<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>2A Modas e Perfumes | Sistema Integrado</title>
    
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.9.2/dist/confetti.browser.min.js"></script>
    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/@emailjs/browser@3/dist/email.min.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
    <script src="https://npmcdn.com/flatpickr/dist/l10n/pt.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;600;700;800&family=Playfair+Display:wght@700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        :root {
            --primary: #c48b78; --primary-dark: #a06b5a;
            --accent: #2c3e50; --accent-light: #34495e;
            --bg: #f8f9fa; --white: #ffffff;
            --success: #27ae60; --warning: #f39c12; --danger: #e74c3c; --info: #3498db;
            --whatsapp: #25D366; --mp: #009EE3;
            --radius: 16px; --btn-radius: 30px; --shadow: 0 10px 30px rgba(0,0,0,0.06);
        }
        * { margin:0; padding:0; box-sizing:border-box; outline:none; font-family:'Plus Jakarta Sans', sans-serif; }
        body { background: var(--bg); color: var(--accent); overflow-x: hidden; display: flex; flex-direction: column; min-height: 100vh; }
        
        h1, .brand-font { font-family:'Plus Jakarta Sans', sans-serif; font-weight: 800; letter-spacing: -0.5px; }
        h2, h3 { font-family:'Plus Jakarta Sans', sans-serif; font-weight: 700; }
        button { cursor:pointer; transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1); border-radius: var(--btn-radius); }

        /* LOADING & STATUS */
        #loading-screen { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: white; z-index: 9999; display: flex; flex-direction: column; align-items: center; justify-content: center; transition: opacity 0.5s; }
        #status-bar { position:fixed; top:0; left:0; width:100%; height:auto; min-height:30px; background:#222; color:white; font-size:0.8rem; display:none; align-items:center; justify-content:center; z-index:99999; font-weight:600; padding:5px; text-align:center; }
        .ok { background:var(--success) !important; } .err { background:var(--danger) !important; }

        /* HEADER */
        .header-floating { position: fixed; top: 30px; right: 5%; z-index: 1000; display:flex; gap:10px; align-items: center; }
        .icon-btn { width:50px; height:50px; border-radius:50%; border:none; background:white; box-shadow:0 4px 15px rgba(0,0,0,0.15); color:var(--accent); font-size:1.2rem; display:flex; align-items:center; justify-content:center; position:relative; }
        .icon-btn:hover { background:var(--primary); color:white; transform:scale(1.1); }
        .badge { position:absolute; top:-5px; right:-5px; background:var(--accent); color:white; width:22px; height:22px; border-radius:50%; font-size:0.75rem; display:flex; align-items:center; justify-content:center; font-weight:bold; border:2px solid white; }
        .login-btn-header { padding: 10px 25px; background: white; border: none; border-radius: 30px; font-weight: 700; color: var(--accent); box-shadow: 0 4px 15px rgba(0,0,0,0.15); display: flex; align-items: center; gap: 8px; font-size: 0.85rem; }
        .login-btn-header:hover { background: var(--primary); color: white; transform: translateY(-2px); }

        /* HERO */
        .hero { padding: 100px 20px 80px; text-align:center; background: radial-gradient(circle at top, #fff5f2 0%, transparent 100%); display: flex; flex-direction: column; align-items: center; }
        .hero img { width:180px; height:180px; border-radius:50%; object-fit:cover; border:5px solid white; box-shadow:var(--shadow); margin-bottom:20px; }
        .hero h1 { font-size:3.5rem; margin-bottom:10px; color:var(--accent); }
        .btn-cta { padding: 16px 50px; background: var(--accent); color: white; border-radius: 50px; border: none; font-weight: 700; font-size: 1.1rem; box-shadow: 0 10px 25px rgba(44,62,80,0.25); margin-top: 45px; animation: pulse 2s infinite; }
        .btn-cta:hover { transform: translateY(-5px); background: var(--primary); }
        @keyframes pulse { 0% { transform: scale(1); } 50% { transform: scale(1.05); } 100% { transform: scale(1); } }

        /* CONTAINER */
        .container { max-width:1200px; margin:0 auto; padding:40px 20px; flex: 1; }
        .filters { display:flex; justify-content:center; gap:12px; margin-bottom:50px; flex-wrap:wrap; }
        .filter-btn { padding: 10px 28px; border-radius: 30px; border: 1px solid #e0e0e0; background: white; color: #555; font-weight: 600; }
        .filter-btn:hover { background: var(--primary); color: white; border-color: var(--primary); transform: translateY(-3px); }
        .filter-btn.active { background: var(--accent); color: white; border-color: var(--accent); transform: scale(1.05); }

        .grid { display:grid; grid-template-columns:repeat(auto-fill, minmax(160px, 1fr)); gap:20px; }
        .card { background:white; border-radius:var(--radius); overflow:hidden; border:1px solid #f0f0f0; transition:0.4s; position:relative; cursor:pointer; }
        .card:hover { transform:translateY(-5px); box-shadow:var(--shadow); border-color:var(--primary); }
        .card img, .card video { width:100%; height:250px; object-fit:cover; background:#f9f9f9; }
        .card-info { padding:15px; text-align:center; }
        .tag-promo { position:absolute; top:10px; right:10px; background:#e91e63; color:white; padding:4px 10px; border-radius:20px; font-size:0.6rem; font-weight:bold; z-index: 2; }
        .tag-delivery { font-size: 0.7rem; color: #27ae60; display: block; margin-top: 5px; font-weight: 600; }

        /* MODALS */
        .overlay { position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.85); backdrop-filter:blur(8px); z-index:2000; display:none; align-items:center; justify-content:center; padding:20px; }
        .overlay.active { display:flex; animation: popIn 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
        @keyframes popIn { from{transform:scale(0.9); opacity:0;} to{transform:scale(1); opacity:1;} }
        .box { background:white; width:100%; max-width:900px; border-radius:20px; overflow:hidden; max-height:90vh; overflow-y:auto; display:grid; grid-template-columns:1fr 1fr; box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5); }
        .box.single-col { display:block; max-width:500px; grid-template-columns: 1fr; }
        
        /* SIDEBAR */
        .sidebar { position:fixed; top:0; right:-500px; width:450px; height:100%; background:white; z-index:3000; padding:30px; box-shadow:-10px 0 50px rgba(0,0,0,0.1); transition:0.4s; display:flex; flex-direction:column; }
        .sidebar.open { right:0; }
        .btn-addr-trigger { width: 100%; padding: 15px; background: white; border: 2px dashed #ccc; border-radius: 16px; color: #777; font-weight: bold; cursor: pointer; transition: 0.3s; display: flex; align-items: center; justify-content: center; gap: 10px; margin-bottom: 20px; text-align: left; }
        .btn-addr-trigger:hover { border-color: var(--primary); background: #fffbf9; color: var(--primary); }
        .btn-addr-trigger.filled { border: 2px solid var(--primary); background: #fff5f2; color: var(--accent); justify-content: flex-start; }

        /* COMMON */
        .input { width:100%; padding:12px 15px; border:1px solid #ddd; border-radius:12px; font-size:0.95rem; margin-bottom:10px; background: #fafafa; transition:0.3s; }
        .input:focus { border-color: var(--primary); background: #fff; box-shadow: 0 0 0 3px rgba(196, 139, 120, 0.2); }
        .input-row { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        .flatpickr-input { background: white !important; border: 1px solid #ddd !important; border-radius: 20px !important; padding: 8px 15px !important; font-weight: 600 !important; cursor: pointer; text-align: center; width: 100%; }
        .compact-date { max-width: 150px; }

        /* MODERN BUTTONS */
        .btn-modern { background: var(--accent); color: white; padding: 12px 24px; border-radius: 30px; border: none; font-weight: bold; display: flex; align-items: center; justify-content: center; gap: 8px; transition: all 0.3s; box-shadow: 0 4px 10px rgba(44,62,80,0.15); cursor: pointer; font-size: 0.95rem; text-decoration: none; }
        .btn-modern:hover { transform: translateY(-3px); box-shadow: 0 8px 20px rgba(44,62,80,0.25); background: var(--accent-light); color:white; }
        .btn-modern.outline { background: transparent; border: 2px solid #eee; color: #555; box-shadow: none; }
        .btn-modern.outline:hover { background: #f5f5f5; border-color: #ddd; color: var(--accent); }
        .btn-modern.small { padding: 8px 16px; font-size: 0.8rem; }
        .btn-modern.success { background: var(--success); }
        .btn-modern.danger { background: var(--danger); }
        .btn-whatsapp { background: var(--whatsapp); color: white; }
        .btn-mp { background: var(--mp); color: white; }

        /* FINANCE CARDS */
        .fin-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 30px; }
        .fin-card-modern { background: white; border-radius: 16px; padding: 25px; border: 1px solid #f0f0f0; position: relative; overflow: hidden; box-shadow: var(--shadow); }
        .fin-card-modern::after { content:''; position:absolute; top:0; right:0; width:6px; height:100%; background: #ccc; }
        .fin-card-modern.rev::after { background: var(--info); }
        .fin-card-modern.cost::after { background: var(--danger); }
        .fin-card-modern.profit::after { background: var(--success); }
        .fin-val-big { font-size: 1.8rem; font-weight: 800; color: var(--accent); margin-top: 8px; }

        /* --- 3D TRUCK & TRACKING ANIMATION (CORRIGIDO) --- */
        .track-container { position: relative; margin: 50px 0 30px; padding: 0 15px; }
        .track-line-bg { width: 100%; height: 6px; background: #eee; border-radius: 3px; position: absolute; top: 0; left: 0; z-index: 1; }
        .track-fill { height: 6px; background: var(--success); border-radius: 3px; position: absolute; top: 0; left: 0; z-index: 2; transition: width 1.5s cubic-bezier(0.4, 0, 0.2, 1); }
        .track-fill.cancelled { background: var(--danger); }
        
        .truck-icon-3d { position: absolute; top: -35px; z-index: 5; font-size: 2rem; color: var(--accent); transition: left 1.5s cubic-bezier(0.4, 0, 0.2, 1); transform: translateX(-50%); filter: drop-shadow(0 4px 6px rgba(0,0,0,0.1)); animation: drive 1s infinite alternate ease-in-out; }
        @keyframes drive { from { transform: translateX(-50%) translateY(0) rotate(-2deg); } to { transform: translateX(-50%) translateY(-3px) rotate(2deg); } }

        .track-steps { display: flex; justify-content: space-between; position: relative; z-index: 3; margin-top: 20px; }
        .track-step { text-align: center; position: relative; width: 33%; }
        .track-step .dot { width: 14px; height: 14px; background: #ddd; border-radius: 50%; margin: -27px auto 10px; border: 2px solid white; box-shadow: 0 2px 5px rgba(0,0,0,0.1); transition: 0.4s; }
        .track-step.active .dot { background: var(--success); transform: scale(1.3); }
        .track-step span { font-size: 0.7rem; font-weight: bold; color: #999; text-transform: uppercase; display: block; margin-top: 15px; }
        .track-step.active span { color: var(--success); }
        
        /* ADMIN EXTRA STYLES */
        .admin-nav { padding:20px; background:white; border-bottom:1px solid #eee; display:flex; gap:10px; overflow-x:auto; }
        .admin-tab { padding:10px 25px; border-radius:30px; border:1px solid #eee; background:transparent; font-weight:600; cursor:pointer; white-space:nowrap; color: #777; transition: all 0.3s ease; }
        .admin-tab:hover { background: #f0f0f0; color: var(--accent); }
        .admin-tab.active { background:var(--accent); color:white; border-color: var(--accent); box-shadow: 0 4px 15px rgba(44,62,80,0.2); }
        
        .manual-order-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
        .manual-prod-adder { background: #f8f9fa; border: 1px dashed #ccc; padding: 15px; border-radius: 12px; display: flex; gap: 10px; align-items: center; flex-wrap: wrap; }
        .manual-cart-list { margin-top: 15px; border: 1px solid #eee; border-radius: 12px; overflow: hidden; }
        .manual-cart-item { display: flex; justify-content: space-between; align-items: center; padding: 10px 15px; background: white; border-bottom: 1px solid #f0f0f0; }
        .btn-map { background: #fff; border: 1px solid #ddd; padding: 5px 10px; border-radius: 20px; font-size: 0.8rem; text-decoration: none; color: #555; display: inline-flex; align-items: center; gap: 5px; margin-top: 5px; font-weight: bold; transition: 0.2s; }
        .btn-map:hover { background: #e8f0fe; color: #1a73e8; border-color: #1a73e8; }
        
        .status-selector { padding: 10px; border-radius: 20px; font-weight: bold; width: 100%; border:none; text-align:center; }
        .st-pendente { background: #fff3cd; color: #856404; } .st-enviado { background: #d1ecf1; color: #0c5460; } .st-entregue { background: #d4edda; color: #155724; } .st-cancelado { background: #f8d7da; color: #721c24; }
        
        /* Product Carousel Styles from previous code */
        .carousel-main-container { width: 100%; height: 350px; background: #f0f0f0; position: relative; display: flex; align-items: center; justify-content: center; overflow: hidden; border-radius: var(--radius); }
        .carousel-main-container img, .carousel-main-container video { width: 100%; height: 100%; object-fit: contain; }
        .carousel-thumbnails { display: flex; gap: 10px; padding: 15px 0; overflow-x: auto; justify-content: center; }
        .carousel-thumb { width: 60px; height: 60px; border-radius: 12px; cursor: pointer; object-fit: cover; border: 2px solid #eee; opacity: 0.6; transition: 0.3s; }
        .carousel-thumb:hover, .carousel-thumb.active { border-color: var(--primary); opacity: 1; transform: scale(1.1); }
        
        /* Modern Checkbox */
        .modern-checkbox-grid { display:flex; flex-wrap:wrap; gap:12px; margin-bottom:25px; }
        .hidden-check { display: none; }
        .color-option-label { width: 40px; height: 40px; border-radius: 50%; cursor: pointer; border: 2px solid #eee; display:flex; align-items:center; justify-content:center; }
        .hidden-check:checked + .color-option-label { border-color: var(--accent); transform: scale(1.1); }
        .var-inputs { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; background: #f9f9f9; padding: 10px; margin-bottom: 10px; border-radius: 8px; border: 1px solid #eee; }
        
        /* Order Cards in Admin */
        .order-card-modern { background: white; border-radius: 12px; border: 1px solid #eee; padding: 20px; margin-bottom: 20px; box-shadow: 0 5px 15px rgba(0,0,0,0.03); }
        .oc-header { display: flex; justify-content: space-between; border-bottom: 1px dashed #eee; padding-bottom: 10px; margin-bottom: 15px; font-weight: bold; color: var(--accent); }
        .oc-body { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
        .oc-section { background: #fafafa; padding: 10px; border-radius: 8px; }
        .oc-section label { font-size: 0.7rem; font-weight: bold; text-transform: uppercase; color: #999; display: block; margin-bottom: 5px; }

        .inst-gen-row { display: grid; grid-template-columns: 40px 1fr 1fr auto; gap: 10px; margin-bottom: 5px; align-items: center; }
        
        @media(max-width:768px){ .box{grid-template-columns:1fr;} .sidebar{width:100%;} .hero{padding-top:80px;} .oc-body, .manual-order-grid { grid-template-columns: 1fr; } .inst-gen-row { grid-template-columns: 1fr 1fr; } .track-step span { font-size: 0.6rem; } }
    </style>
</head>
<body>

    <div id="loading-screen">
        <i class="fas fa-circle-notch fa-spin fa-3x" style="color:var(--primary);"></i>
        <p style="margin-top:15px; color:#666;">Carregando loja...</p>
    </div>

    <div class="header-floating">
        <button class="login-btn-header" onclick="auth.checkProfile()">
            <i class="fas fa-user-circle"></i> Login / Cadastro
        </button>
        <button class="icon-btn" onclick="app.toggleCart()">
            <i class="fas fa-shopping-bag"></i><span class="badge" id="cart-count">0</span>
        </button>
    </div>

    <div class="hero">
        <img src="logo.jpg" onerror="this.src='https://via.placeholder.com/200?text=2A'">
        <h1 class="brand-font">2A Modas e Perfumes</h1>
        <p>Eleg√¢ncia que transforma. Descubra sua ess√™ncia.</p>
        <button class="btn-cta btn-pulse" onclick="app.openPromoModal()">‚ú® Ver Promo√ß√µes</button>
    </div>

    <div class="container" id="vitrine">
        <div class="filters">
            <button class="filter-btn active" onclick="app.filter('all', this)">Todos</button>
            <button class="filter-btn" onclick="app.filter('feminino', this)">Feminino</button>
            <button class="filter-btn" onclick="app.filter('infantil', this)">Infantil</button>
            <button class="filter-btn" onclick="app.filter('perfumes', this)">Perfumes</button>
        </div>
        <div id="products-list" class="grid"></div>
    </div>

    <footer>
        <p class="brand-font">&copy; 2025 2A Modas e Perfumes.</p>
        <br>
        <button onclick="admin.showLogin()">√Årea Administrativa</button>
    </footer>

    <div id="promo-modal" class="overlay">
        <div class="box single-col" style="background:var(--bg); overflow:hidden; max-width:800px;">
            <div style="padding:20px; display:flex; justify-content:space-between; align-items:center;"><h3>üî• Ofertas</h3><button onclick="app.closeModal('promo-modal')" style="border:none;background:none;font-size:1.5rem;">&times;</button></div>
            <div id="promo-track" style="padding:20px; display:flex; gap:15px; overflow-x:auto;"></div>
        </div>
    </div>

    <div id="product-modal" class="overlay">
        <div class="box">
            <div id="m-media-area" style="width:100%; height:100%; background:#f9f9f9; display:flex; align-items:center; justify-content:center;"></div>
            <div style="padding:40px; position:relative;">
                <button onclick="app.closeModal('product-modal')" style="position:absolute; top:20px; right:20px; border:none; background:none; font-size:1.5rem; color:#999;">&times;</button>
                <small id="m-cat" style="color:var(--primary); font-weight:700; text-transform:uppercase;">Categoria</small>
                <h2 id="m-title" style="margin:10px 0;"></h2>
                <h3 id="m-price" style="color:var(--accent); margin-bottom:15px;"></h3>
                <p id="m-desc" style="color:#666; margin-bottom:20px;"></p>
                <div style="margin-bottom:20px; color:#27ae60; font-weight:600; background:#eafff0; padding:10px; border-radius:10px; display:inline-block;"><i class="fas fa-truck"></i> Entrega: 03 a 05 dias √∫teis</div>
                
                <div style="background: #fafafa; padding: 15px; border-radius: 12px; border: 1px solid #eee; margin-bottom: 20px;">
                    <label style="font-weight:bold; font-size:0.9rem; margin-bottom:10px; display:block;">Op√ß√£o:</label>
                    <div id="m-vars" style="display:flex; flex-wrap:wrap; gap:10px;"></div>
                </div>

                <div style="display:flex; align-items:center; gap:15px; margin-bottom:25px;">
                    <span style="font-weight:bold;">Qtd:</span>
                    <div style="border:1px solid #ddd; border-radius:30px; display:flex; overflow:hidden;">
                        <button onclick="app.updQty(-1)" style="padding:10px 15px; border:none; background:white;">-</button>
                        <span id="m-qty" style="padding:10px 15px; font-weight:bold; background:white;">1</span>
                        <button onclick="app.updQty(1)" style="padding:10px 15px; border:none; background:white;">+</button>
                    </div>
                </div>
                <button onclick="app.addCart()" class="btn-modern" style="width:100%; padding:15px;">Adicionar √† Sacola</button>
            </div>
        </div>
    </div>

    <div id="address-modal" class="overlay" style="z-index:10001;">
        <div class="box single-col" style="width:100%; max-width:500px; padding:25px;">
            <h3>üìç Endere√ßo de Entrega</h3>
            <div id="saved-addresses-list" style="margin-bottom:20px; max-height:150px; overflow-y:auto;"></div>
            <div style="background:#f9f9f9; padding:20px; border-radius:16px;">
                <input type="text" id="addr-cep" class="input" placeholder="CEP" onblur="app.fetchCep(this.value)">
                <input type="text" id="addr-street" class="input" placeholder="Rua">
                <div class="input-row"><input type="text" id="addr-num" class="input" placeholder="N√∫mero"><input type="text" id="addr-bairro" class="input" placeholder="Bairro"></div>
                <div class="input-row"><input type="text" id="addr-city" class="input" placeholder="Cidade"><input type="text" id="addr-uf" class="input" placeholder="UF"></div>
                <input type="text" id="addr-ref" class="input" placeholder="Refer√™ncia">
                <input type="text" id="addr-name" class="input" placeholder="Nome Recebedor">
                <input type="text" id="addr-phone" class="input" placeholder="Telefone">
                <select id="addr-type" class="input"><option>Casa</option><option>Trabalho</option></select>
                <button onclick="app.addNewAddress()" class="btn-modern" style="width:100%;">Salvar</button>
            </div>
            <button onclick="app.closeModal('address-modal')" style="width:100%; margin-top:15px; background:none; border:none;">Fechar</button>
        </div>
    </div>

    <div id="client-modal" class="overlay">
        <div class="box single-col" style="max-width:600px; padding:30px;">
            <div style="display:flex; justify-content:space-between; margin-bottom:20px;"><h2>Minha Conta</h2><button onclick="app.closeModal('client-modal')" style="border:none;background:none;">&times;</button></div>
            <div style="background:#f9f9f9; padding:20px; border-radius:16px; margin-bottom:25px;">
                <h4>Meus Dados</h4><p id="client-info-txt"></p>
                <button onclick="auth.logout()" class="btn-modern outline small">Sair</button>
            </div>
            <h3>Meus Pedidos</h3>
            <div class="filter-wrapper">
                <div class="date-group"><label>De:</label><input type="text" id="client-date-start" class="flatpickr-input compact-date" onchange="auth.loadClientOrders()"></div>
                <div class="date-group"><label>At√©:</label><input type="text" id="client-date-end" class="flatpickr-input compact-date" onchange="auth.loadClientOrders()"></div>
            </div>
            <div id="client-orders-list" style="max-height:450px; overflow-y:auto; margin-top:15px;"></div>
        </div>
    </div>

    <div class="sidebar">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px; border-bottom:1px solid #eee; padding-bottom:15px;">
            <h2 style="margin:0;">Sua Sacola</h2>
            <button onclick="app.toggleCart()" style="border:none; background:none; font-size:1.5rem; color:#999;">&times;</button>
        </div>
        <div style="flex:1; overflow-y:auto;"><ul id="cart-list" style="list-style:none;"></ul></div>
        <div style="border-top:1px solid #eee; padding-top:25px;">
            <div id="cart-auth-area" style="margin-bottom:15px;">
                <button onclick="app.showModal('auth-modal')" style="width:100%; padding:12px; background:#f0f0f0; border:none; border-radius:12px;">Login / Cadastro</button>
            </div>
            <button id="btn-address-trigger" onclick="app.openAddressModal()" class="btn-addr-trigger"><i class="fas fa-map-marker-alt"></i> Cadastrar Entrega</button>
            <div style="background:#fafafa; padding:15px; border-radius:12px; margin-bottom:20px; display:flex; justify-content:space-between;">
                <span>Total</span> <span id="cart-total" style="font-weight:bold;">R$ 0.00</span>
            </div>
            <button onclick="app.checkout('whatsapp')" class="btn-modern btn-whatsapp" style="width:100%; margin-bottom:10px;"><i class="fab fa-whatsapp"></i> Pedir no WhatsApp</button>
            <button onclick="app.checkout('mercadopago')" class="btn-modern btn-mp" style="width:100%;"><i class="fas fa-qrcode"></i> Pagar Online</button>
        </div>
    </div>

    <div id="auth-modal" class="overlay" style="z-index:10002;">
        <div class="box single-col" style="padding:40px; text-align:center; max-width:400px;">
            <h2 id="auth-title">Acesso</h2>
            <div id="form-login">
                <input type="email" id="l-email" class="input" placeholder="E-mail"><input type="password" id="l-pass" class="input" placeholder="Senha">
                <button onclick="auth.login()" class="btn-modern" style="width:100%;">Entrar</button>
                <p style="margin-top:20px;"><a href="#" onclick="auth.toggle('register')">Cadastre-se</a></p>
            </div>
            <div id="form-register" style="display:none;">
                <input type="text" id="r-name" class="input" placeholder="Nome"><input type="email" id="r-email" class="input" placeholder="E-mail"><input type="password" id="r-pass" class="input" placeholder="Senha">
                <button onclick="auth.register()" class="btn-modern" style="width:100%;">Cadastrar</button>
                <p style="margin-top:20px;"><a href="#" onclick="auth.toggle('login')">Voltar</a></p>
            </div>
            <button onclick="app.closeModal('auth-modal')" style="position:absolute; top:20px; right:20px; border:none; background:none; font-size:1.5rem;">&times;</button>
        </div>
    </div>

    <div id="admin-auth-modal" class="overlay" style="z-index:10003;">
        <div class="box single-col" style="max-width:350px; text-align:center; padding:30px;">
            <h2>√Årea Restrita</h2>
            <input type="password" id="admin-pass" class="input" placeholder="Senha" style="text-align:center;">
            <button onclick="admin.verifyLogin()" class="btn-modern" style="width:100%;">Entrar</button>
            <button onclick="app.closeModal('admin-auth-modal')" style="background:none; border:none; margin-top:10px;">Cancelar</button>
        </div>
    </div>

    <div id="admin-modal" class="overlay" style="z-index:2001; background:#f4f6f9; align-items:flex-start; padding:0;">
        <div class="box" style="max-width:100%; height:100%; border-radius:0; padding:0; display:flex; flex-direction:column;">
            <div class="admin-nav">
                <h3>Admin 2A</h3>
                <button onclick="admin.tab('dash')" class="admin-tab active">Estoque</button>
                <button onclick="admin.tab('orders')" class="admin-tab">Pedidos</button>
                <button onclick="admin.tab('new-order')" class="admin-tab" style="color:var(--primary); border-color:var(--primary);"><i class="fas fa-plus-circle"></i> Novo Pedido</button>
                <button onclick="admin.tab('pay')" class="admin-tab">Financeiro</button>
                <button onclick="admin.tab('prod')" class="admin-tab">Produtos</button>
                <button onclick="app.closeModal('admin-modal')" class="btn-modern outline small" style="margin-left:auto;">Sair</button>
            </div>
            
            <div style="flex:1; overflow-y:auto; padding:30px; width:100%; max-width:1200px; margin:0 auto;">
                <div id="tab-dash">
                    <div style="display:grid; grid-template-columns:repeat(auto-fit, minmax(250px, 1fr)); gap:20px; margin-bottom:30px;">
                        <div class="fin-card-modern profit"><div class="fin-label">Valor Estoque (Venda)</div><div id="st-rev" class="fin-val-big">R$ 0.00</div></div>
                        <div class="fin-card-modern cost"><div class="fin-label">Custo Estoque</div><div id="st-cost" class="fin-val-big">R$ 0.00</div></div>
                        <div class="fin-card-modern"><div class="fin-label">Qtd Itens</div><div id="st-qty" class="fin-val-big">0</div></div>
                    </div>
                    <div class="dashboard-grid" id="dash-stock-grid"></div>
                </div>

                <div id="tab-orders" style="display:none;">
                    <div style="background:white; padding:25px; border-radius:16px;">
                        <h3>Pedidos</h3>
                        <div class="filter-wrapper">
                            <input type="text" id="order-start" class="flatpickr-input compact-date">
                            <input type="text" id="order-end" class="flatpickr-input compact-date">
                        </div>
                        <div class="chip-container" id="order-filters">
                            <button class="chip active" onclick="admin.filterOrders('all', this)">Todos</button>
                            <button class="chip" onclick="admin.filterOrders('Pendente', this)">Pendente</button>
                            <button class="chip" onclick="admin.filterOrders('Enviado', this)">Enviado</button>
                            <button class="chip" onclick="admin.filterOrders('Entregue', this)">Entregue</button>
                        </div>
                        <div id="orders-list"></div>
                    </div>
                </div>

                <div id="tab-new-order" style="display:none;">
                    <div style="background:white; padding:30px; border-radius:16px; max-width: 900px; margin: 0 auto;">
                        <h3><i class="fas fa-edit"></i> Criar Pedido Manual</h3>
                        <div class="manual-order-grid">
                            <div>
                                <h4 style="margin-bottom:10px;">Cliente</h4>
                                <input type="text" id="m-client-name" class="input" placeholder="Nome">
                                <input type="text" id="m-client-phone" class="input" placeholder="Telefone">
                                <input type="text" id="m-client-addr" class="input" placeholder="Endere√ßo Completo">
                                <h4 style="margin:20px 0 10px;">Pagamento</h4>
                                <div class="input-row">
                                    <select id="m-payment-method" class="input"><option>Dinheiro</option><option>Pix</option><option>Cart√£o</option></select>
                                    <select id="m-payment-status" class="input"><option value="Pago">Pago</option><option value="Pendente">A Pagar</option></select>
                                </div>
                            </div>
                            <div>
                                <h4 style="margin-bottom:10px;">Itens</h4>
                                <div class="manual-prod-adder">
                                    <select id="m-prod-select" class="input" style="flex:2;"><option value="">Produto...</option></select>
                                    <input type="number" id="m-prod-qty" class="input" value="1" style="width:60px;">
                                    <button onclick="admin.addManualItem()" class="btn-modern small"><i class="fas fa-plus"></i></button>
                                </div>
                                <div class="manual-prod-adder" style="margin-top:10px; background:#fff5f2;">
                                    <input type="text" id="m-custom-item" class="input" placeholder="Item avulso" style="flex:2;">
                                    <input type="number" id="m-custom-price" class="input" placeholder="R$" style="width:80px;">
                                    <button onclick="admin.addCustomItem()" class="btn-modern small success"><i class="fas fa-plus"></i></button>
                                </div>
                                <div id="manual-cart-list" class="manual-cart-list"><p style="padding:10px; text-align:center; color:#999;">Vazio</p></div>
                                <div style="display:flex; justify-content:space-between; margin-top:15px; font-weight:800; font-size:1.2rem;"><span>Total</span><span id="m-total-display">R$ 0.00</span></div>
                            </div>
                        </div>
                        <button onclick="admin.saveManualOrder()" class="btn-modern" style="width:100%; margin-top:20px; justify-content:center;">Salvar Pedido</button>
                    </div>
                </div>

                <div id="tab-pay" style="display:none;">
                    <div style="background:white; padding:25px; border-radius:16px;">
                        <h3>Financeiro Real (Caixa)</h3>
                        <div class="filter-wrapper" style="background:#f0f9ff;">
                            <input type="text" id="fin-start" class="flatpickr-input compact-date">
                            <input type="text" id="fin-end" class="flatpickr-input compact-date">
                        </div>
                        <div class="fin-grid">
                            <div class="fin-card-modern profit"><div class="fin-label">Entrada (Recebido no Per√≠odo)</div><div id="fin-real-revenue" class="fin-val-big">R$ 0.00</div></div>
                            <div class="fin-card-modern"><div class="fin-label">Vendas Geradas (Total Pedidos)</div><div id="fin-total-created" class="fin-val-big" style="color:#666">R$ 0.00</div></div>
                        </div>
                        <div class="chip-container" id="pay-filters">
                            <button class="chip active" onclick="admin.filterPayments('all', this)">Todos</button>
                            <button class="chip" onclick="admin.filterPayments('A_pagar', this)">√Ä Pagar</button>
                            <button class="chip" onclick="admin.filterPayments('Pago', this)">Quitados</button>
                        </div>
                        <div id="pay-list"></div>
                    </div>
                </div>

                <div id="tab-prod" style="display:none;">
                    <div style="background:white; padding:25px; border-radius:16px;">
                        <h3>Cadastro</h3>
                        <input type="hidden" id="edit-id">
                        <input type="text" id="f-name" class="input" placeholder="Nome">
                        <div style="display:flex; gap:10px;"><select id="f-cat" class="input"><option value="feminino">Feminino</option><option value="infantil">Infantil</option><option value="perfumes">Perfumes</option></select><input type="number" id="f-cost" class="input" placeholder="Custo"></div>
                        <div class="input-row"><input type="number" id="f-price-global" class="input" placeholder="Venda"><input type="number" id="f-stock-global" class="input" placeholder="Estoque"></div>
                        <div class="modern-checkbox-grid" id="color-checks"></div>
                        <div class="modern-checkbox-grid" id="volume-checks"></div>
                        <div id="active-vars-area"></div>
                        <button onclick="admin.save()" class="btn-modern" style="width:100%; margin-top:20px;">Salvar</button>
                    </div>
                    <div id="admin-list" style="margin-top:20px;"></div>
                </div>
            </div>
        </div>
    </div>

    <script>
        setTimeout(() => { document.getElementById('loading-screen').style.display='none'; }, 2000);
        // CONFIG
        const SUPABASE_URL = 'https://sdeslwemzhxqixmphyye.supabase.co'; 
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InNkZXNsd2Vtemh4cWl4bXBoeXllIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjY3MDUxNDUsImV4cCI6MjA4MjI4MTE0NX0.QK7PkbYOnT6nIRFZHtHsuh42EuCjMSVvdnxf7h1bD80';
        const GOOGLE_CLOUD_URL = 'https://criarpagamentoss-967029810770.southamerica-east1.run.app'; 
        const EMAILJS_PUBLIC_KEY = 'vEXIgVw6GynR5W1qj'; 
        const EMAILJS_SERVICE_ID = 'service_3x4ghcd';
        const EMAILJS_TEMPLATE_CLIENTE = 'template_rwf0bay';
        const EMAILJS_TEMPLATE_ADMIN = 'template_rwf0bay';

        let sb = null; try { sb = supabase.createClient(SUPABASE_URL, SUPABASE_KEY); } catch(e) { console.error(e); }

        const state = { products: [], cart: [], current: null, var: null, qty: 1, user: null, address: null, adminOrders: [], filterStatus: 'all', filterPay: 'all', selectedFiles: [] };
        const COLOR_MAP = { 'Preto': '#000', 'Branco': '#fff', 'Vermelho': '#e74c3c', 'Azul': '#3498db', 'Rosa': '#e91e63' };
        const PRESETS_VOL = ['P','M','G','GG','Unico','50ml','100ml'];
        
        const safeVal = (v) => (v == null) ? "" : v;

        document.addEventListener('DOMContentLoaded', () => {
            flatpickr(".flatpickr-input", { dateFormat: "Y-m-d", locale: "pt", altInput: true, altFormat: "d/m/Y" });
        });

        const app = {
            load: async () => {
                if(!sb) return;
                const { data } = await sb.from('products').select('*');
                state.products = data || []; app.render(state.products);
            },
            render: (list) => {
                const div = document.getElementById('products-list'); if(!div) return; div.innerHTML = "";
                list.forEach(p => {
                    const vars = typeof p.variations === 'string' ? JSON.parse(p.variations) : p.variations;
                    const minP = (vars && vars.length) ? Math.min(...vars.map(v => parseFloat(v.price))) : 0;
                    let img = "https://via.placeholder.com/300";
                    try { const m = JSON.parse(p.image_url); if(Array.isArray(m) && m.length) img = m[0]; } catch(e){}
                    div.innerHTML += `<div class="card" onclick="app.openModal('${p.id}')"><img src="${img}"><div class="card-info"><div style="font-weight:bold;">${p.name}</div><div style="color:var(--primary);">R$ ${minP.toFixed(2)}</div></div></div>`;
                });
            },
            openModal: (id) => {
                const p = state.products.find(x => String(x.id) === String(id));
                if(!p) return;
                state.current = p; state.qty=1; state.var=null;
                document.getElementById('m-title').innerText = p.name;
                document.getElementById('m-price').innerText = "Selecione...";
                const vDiv = document.getElementById('m-vars'); vDiv.innerHTML = "";
                const vars = typeof p.variations === 'string' ? JSON.parse(p.variations) : p.variations;
                vars.forEach(v => {
                    const btn = document.createElement('button');
                    btn.className = 'btn-modern outline small';
                    btn.innerText = `${v.name} - R$ ${v.price}`;
                    btn.onclick = () => { state.var = v; document.getElementById('m-price').innerText = `R$ ${v.price}`; };
                    vDiv.appendChild(btn);
                });
                app.showModal('product-modal');
            },
            addCart: () => {
                if(!state.var) return alert("Selecione varia√ß√£o");
                state.cart.push({name: state.current.name, variant: state.var.name, price: parseFloat(state.var.price), qty: state.qty, image: "https://via.placeholder.com/50"});
                app.renderCart(); app.closeModal('product-modal'); app.toggleCart();
            },
            renderCart: () => {
                const ul = document.getElementById('cart-list'); ul.innerHTML=""; let t=0;
                state.cart.forEach((i,idx) => {
                    t += i.price*i.qty;
                    ul.innerHTML += `<li style="padding:10px; border-bottom:1px solid #eee; display:flex; justify-content:space-between;"><div><b>${i.name}</b> (${i.variant})<br>x${i.qty}</div><div>R$ ${(i.price*i.qty).toFixed(2)} <button onclick="state.cart.splice(${idx},1);app.renderCart()" style="color:red;border:none;background:none;">x</button></div></li>`;
                });
                document.getElementById('cart-total').innerText = `R$ ${t.toFixed(2)}`;
                document.getElementById('cart-count').innerText = state.cart.length;
            },
            toggleCart: () => document.querySelector('.sidebar').classList.toggle('open'),
            fetchCep: async (cep) => {
                cep = cep.replace(/\D/g, '');
                if(cep.length === 8) {
                    const res = await fetch(`https://viacep.com.br/ws/${cep}/json/`);
                    const data = await res.json();
                    if(!data.erro) {
                        document.getElementById('addr-street').value = data.logradouro;
                        document.getElementById('addr-bairro').value = data.bairro;
                        document.getElementById('addr-city').value = data.localidade;
                        document.getElementById('addr-uf').value = data.uf;
                    }
                }
            },
            addNewAddress: () => {
                const val = id => document.getElementById(id).value;
                const a = { street: val('addr-street'), number: val('addr-num'), bairro: val('addr-bairro'), city: val('addr-city'), uf: val('addr-uf'), ref: val('addr-ref'), phone: val('addr-phone') };
                state.address = a; localStorage.setItem('2a_active_addr', JSON.stringify(a));
                app.updateUI(); app.closeModal('address-modal');
            },
            updateUI: () => {
                const btn = document.getElementById('btn-address-trigger');
                if(btn && state.address) { btn.classList.add('filled'); btn.innerHTML = `üìç ${state.address.city}/${state.address.uf}`; }
            },
            checkout: async (method) => {
                if(!state.cart.length) return alert("Carrinho vazio");
                if(!state.address) { app.openAddressModal(); return; }
                const orderData = await app.registerOrder(Date.now().toString(), method, 'Pendente', 'Pendente');
                alert("Pedido Recebido!"); window.location.reload();
            },
            registerOrder: async (oid, method, status, payStatus) => {
                if(!sb) return;
                const total = state.cart.reduce((a,b)=>a+(b.price*b.qty),0);
                const order = { id: oid, customer_name: state.user?.name || "Visitante", customer_email: state.user?.email || "email@teste.com", total, items: JSON.stringify(state.cart), address: JSON.stringify(state.address), date: new Date().toLocaleDateString(), method, status, payment_status: payStatus, created_at: new Date().toISOString() };
                await sb.from('orders').insert([order]);
                return order;
            },
            showModal: (id) => document.getElementById(id).classList.add('active'),
            closeModal: (id) => document.getElementById(id).classList.remove('active'),
            filter: (cat) => app.render(cat==='all' ? state.products : state.products.filter(p => p.category===cat))
        };

        const auth = {
            checkProfile: () => { if(state.user) app.showModal('client-modal'); else app.showModal('auth-modal'); },
            toggle: (m) => { document.getElementById('form-login').style.display=m==='login'?'block':'none'; document.getElementById('form-register').style.display=m==='register'?'block':'none'; },
            login: async () => {
                const e = document.getElementById('l-email').value, p = document.getElementById('l-pass').value;
                const {data} = await sb.from('customers').select('*').eq('email',e).eq('password',p).single();
                if(data) { state.user=data; localStorage.setItem('2a_user', JSON.stringify(data)); app.updateUI(); history.back(); }
            },
            register: async () => {
                const n=document.getElementById('r-name').value, e=document.getElementById('r-email').value, p=document.getElementById('r-pass').value;
                await sb.from('customers').insert([{id: Date.now(), name:n, email:e, password:p, address: []}]);
                alert("Sucesso!"); auth.toggle('login');
            },
            logout: () => { localStorage.removeItem('2a_user'); location.reload(); },
            loadClientOrders: async () => {
                if(!state.user) return;
                const { data } = await sb.from('orders').select('*').eq('customer_email', state.user.email).order('created_at', {ascending: false});
                const div = document.getElementById('client-orders-list'); div.innerHTML = "";
                data.forEach(o => {
                    let pct = 10;
                    if(o.status.includes('Enviado')) pct = 50; if(o.status.includes('Entregue')) pct = 100; if(o.status==='Cancelado') pct=100;
                    const cClass = o.status==='Cancelado' ? 'cancelled' : '';
                    div.innerHTML += `<div class="order-card-modern" style="padding:15px;"><strong>Pedido #${o.id.slice(-4)}</strong> - R$ ${o.total.toFixed(2)}
                    <div class="track-container"><div class="track-line-bg"></div><div class="track-fill ${cClass}" style="width:${pct}%"></div><div class="truck-icon-3d ${cClass}" style="left:${pct}%"><i class="fas fa-truck"></i></div></div><div class="track-steps"><div class="track-step"><span>Pendente</span></div><div class="track-step"><span>Enviado</span></div><div class="track-step"><span>Entregue</span></div></div></div>`;
                });
            }
        };

        const admin = {
            manualCart: [],
            showLogin: () => app.showModal('admin-auth-modal'),
            verifyLogin: () => {
                if(document.getElementById('admin-pass').value === "123") {
                    app.closeModal('admin-auth-modal'); app.showModal('admin-modal');
                    const today = new Date(); const prior = new Date(); prior.setDate(today.getDate()-30);
                    document.getElementById('order-start')._flatpickr.setDate(prior); document.getElementById('order-end')._flatpickr.setDate(today);
                    document.getElementById('fin-start')._flatpickr.setDate(prior); document.getElementById('fin-end')._flatpickr.setDate(today);
                    admin.renderOrders(); admin.renderFinance(); admin.populateManualProdSelect();
                }
            },
            tab: (t) => {
                ['dash','prod','orders','fin','pay','new-order'].forEach(i => document.getElementById(`tab-${i}`).style.display = i===t ? 'block' : 'none');
                if(t==='new-order') { admin.populateManualProdSelect(); admin.manualCart=[]; admin.renderManualCart(); }
            },
            // MANUAL ORDER
            populateManualProdSelect: () => {
                const sel = document.getElementById('m-prod-select'); sel.innerHTML = '<option value="">Selecione...</option>';
                state.products.forEach(p => {
                    const vars = JSON.parse(p.variations || '[]');
                    vars.forEach(v => sel.innerHTML += `<option value="${p.id}|${v.name}|${v.price}|${p.name}">${p.name} - ${v.name} (R$ ${v.price})</option>`);
                });
            },
            addManualItem: () => {
                const val = document.getElementById('m-prod-select').value;
                if(!val) return;
                const [pid, vname, price, pname] = val.split('|');
                admin.manualCart.push({ name: pname, variant: vname, price: parseFloat(price), qty: parseInt(document.getElementById('m-prod-qty').value), pid, is_stock: true });
                admin.renderManualCart();
            },
            addCustomItem: () => {
                admin.manualCart.push({ name: document.getElementById('m-custom-item').value, variant: 'Avulso', price: parseFloat(document.getElementById('m-custom-price').value), qty: 1, is_stock: false });
                admin.renderManualCart();
            },
            renderManualCart: () => {
                const div = document.getElementById('manual-cart-list'); div.innerHTML = "";
                let t = 0;
                admin.manualCart.forEach((i, idx) => {
                    t += i.price * i.qty;
                    div.innerHTML += `<div class="manual-cart-item"><span>${i.name} (${i.variant}) x${i.qty}</span> <span>R$ ${(i.price*i.qty).toFixed(2)} <i class="fas fa-trash" onclick="admin.manualCart.splice(${idx},1);admin.renderManualCart()"></i></span></div>`;
                });
                document.getElementById('m-total-display').innerText = `R$ ${t.toFixed(2)}`;
            },
            saveManualOrder: async () => {
                if(!admin.manualCart.length) return alert("Vazio");
                const total = admin.manualCart.reduce((a,b)=>a+(b.price*b.qty),0);
                const pStatus = document.getElementById('m-payment-status').value;
                const order = {
                    id: Date.now().toString(), customer_name: document.getElementById('m-client-name').value || "Balc√£o",
                    total, items: JSON.stringify(admin.manualCart), 
                    address: JSON.stringify({ street: document.getElementById('m-client-addr').value, phone: document.getElementById('m-client-phone').value }),
                    date: new Date().toLocaleDateString(), method: 'Manual', status: pStatus==='Pago'?'Entregue':'Pendente', payment_status: pStatus, created_at: new Date().toISOString()
                };
                await sb.from('orders').insert([order]);
                // Baixa Estoque
                for(const i of admin.manualCart) {
                    if(i.is_stock) {
                        const {data:p} = await sb.from('products').select('*').eq('id', i.pid).single();
                        if(p) {
                            const vars = JSON.parse(p.variations);
                            const v = vars.find(x => x.name === i.variant);
                            if(v) v.stock -= i.qty;
                            await sb.from('products').update({variations: JSON.stringify(vars)}).eq('id', p.id);
                        }
                    }
                }
                alert("Pedido Salvo!"); admin.tab('orders'); admin.renderOrders();
            },
            // FINANCEIRO REAL
            renderFinance: async () => {
                const startStr = document.getElementById('fin-start').value;
                const endStr = document.getElementById('fin-end').value;
                if(!startStr || !endStr) return;
                const start = new Date(startStr + 'T00:00:00');
                const end = new Date(endStr + 'T23:59:59');
                
                // Pega TODOS os pedidos n√£o cancelados para verificar as datas de pagamento
                const { data: orders } = await sb.from('orders').select('*').neq('status', 'Cancelado');
                
                let realRevenue = 0;
                let totalCreated = 0;

                orders.forEach(o => {
                    const orderDate = new Date(o.created_at);
                    
                    // Total Criado (Vendas Geradas) - Considera data do pedido
                    if(orderDate >= start && orderDate <= end) {
                        totalCreated += o.total;
                    }

                    // Receita Real (Entrada de Caixa) - Considera data do pagamento
                    if(o.payment_status === 'Pago') {
                        // Se foi pago √† vista/total, assume data do pedido como data do recebimento
                        if(orderDate >= start && orderDate <= end) {
                            realRevenue += o.total;
                        }
                    } else if(o.installments) {
                        try {
                            const inst = JSON.parse(o.installments);
                            inst.forEach(i => {
                                if(i.paid) {
                                    // Verifica a data espec√≠fica da parcela paga ou a data do pedido se n√£o houver data de pgto
                                    const payDate = i.date ? new Date(i.date + 'T12:00:00') : orderDate;
                                    if(payDate >= start && payDate <= end) {
                                        realRevenue += parseFloat(i.amount);
                                    }
                                }
                            });
                        } catch(e) {}
                    }
                });

                document.getElementById('fin-real-revenue').innerText = `R$ ${realRevenue.toFixed(2)}`;
                document.getElementById('fin-total-created').innerText = `R$ ${totalCreated.toFixed(2)}`;
            },
            // LISTAGEM E PAGAMENTO PARCIAL
            registerPartialOnPending: async (id, total) => {
                const val = prompt(`Total: R$ ${total}. Valor da entrada?`);
                if(val) {
                    const paid = parseFloat(val);
                    const rest = total - paid;
                    const today = new Date().toISOString().split('T')[0];
                    const next = new Date(); next.setDate(next.getDate()+30);
                    const inst = [{date: today, amount: paid.toFixed(2), paid: true}, {date: next.toISOString().split('T')[0], amount: rest.toFixed(2), paid: false}];
                    await sb.from('orders').update({ payment_status: 'Parcelado', installments: JSON.stringify(inst) }).eq('id', id);
                    alert("Registrado!"); admin.renderOrders();
                }
            },
            renderOrders: async () => {
                const { data } = await sb.from('orders').select('*').order('created_at', {ascending:false});
                const div = document.getElementById('orders-list'); div.innerHTML = "";
                data.forEach(o => {
                    const addr = JSON.parse(o.address || '{}');
                    const fullAddr = `${addr.street||''}, ${addr.number||''} - ${addr.bairro||''}`;
                    const mapLink = `https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(fullAddr + ' ' + (addr.city||''))}`;
                    const btnPartial = (o.payment_status==='Pendente' || o.payment_status==='A_pagar') ? `<button onclick="admin.registerPartialOnPending('${o.id}', ${o.total})" class="btn-modern small outline" style="margin-top:5px;width:100%;"><i class="fas fa-coins"></i> Registrar Entrada</button>` : '';
                    
                    div.innerHTML += `<div class="order-card-modern"><div class="oc-header"><span>#${o.id.slice(-4)}</span><span>${o.date}</span></div>
                    <div class="oc-body">
                        <div><strong>${o.customer_name}</strong><br><a href="${mapLink}" target="_blank" class="btn-map"><i class="fas fa-map-marker-alt"></i> ${fullAddr}</a></div>
                        <div>Total: <strong style="color:green">R$ ${o.total.toFixed(2)}</strong><br>Status: ${o.status}<br>${btnPartial}</div>
                    </div></div>`;
                });
            },
            // AUX
            filterOrders: (s) => { state.filterStatus=s; admin.renderOrders(); },
            filterPayments: (s) => { state.filterPay=s; admin.renderPayments(); }
        };

        (async function(){ 
            const u=localStorage.getItem('2a_user'); if(u) state.user=JSON.parse(u); 
            if(state.user) document.getElementById('client-info-txt').innerHTML = `<b>${state.user.name}</b>`;
            await app.load(); admin.initCheckboxes();
        })();
    </script>
</body>
</html>
