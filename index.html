<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>2A Modas e Perfumes | Sistema Integrado</title>
    
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.9.2/dist/confetti.browser.min.js"></script>
    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/@emailjs/browser@3/dist/email.min.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
    <script src="https://npmcdn.com/flatpickr/dist/l10n/pt.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;600;700;800&family=Playfair+Display:wght@700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        :root {
            --primary: #c48b78; --primary-dark: #a06b5a;
            --accent: #2c3e50; --accent-light: #34495e;
            --bg: #f8f9fa; --white: #ffffff;
            --success: #27ae60; --warning: #f39c12; --danger: #e74c3c; --info: #3498db;
            --whatsapp: #25D366; --mp: #009EE3;
            --radius: 16px; --btn-radius: 30px; --shadow: 0 10px 30px rgba(0,0,0,0.06);
        }
        * { margin:0; padding:0; box-sizing:border-box; outline:none; font-family:'Plus Jakarta Sans', sans-serif; }
        body { background: var(--bg); color: var(--accent); overflow-x: hidden; display: flex; flex-direction: column; min-height: 100vh; }
        
        h1, .brand-font { font-family:'Plus Jakarta Sans', sans-serif; font-weight: 800; letter-spacing: -0.5px; }
        h2, h3 { font-family:'Plus Jakarta Sans', sans-serif; font-weight: 700; }
        button { cursor:pointer; transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1); border-radius: var(--btn-radius); }

        /* LOADING & STATUS */
        #loading-screen { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: white; z-index: 9999; display: flex; flex-direction: column; align-items: center; justify-content: center; transition: opacity 0.5s; }
        #status-bar { position:fixed; top:0; left:0; width:100%; height:auto; min-height:30px; background:#222; color:white; font-size:0.8rem; display:none; align-items:center; justify-content:center; z-index:99999; font-weight:600; padding:5px; text-align:center; }
        .ok { background:var(--success) !important; } .err { background:var(--danger) !important; }

        /* TOAST NOTIFICATION MODERN */
        #toast-container { position: fixed; top: 20px; right: 20px; z-index: 20000; }
        .toast-box {
            background: white; width: 320px; padding: 20px; border-radius: 12px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.15); margin-bottom: 15px;
            position: relative; overflow: hidden; animation: slideInRight 0.5s ease-out;
            border-left: 5px solid var(--success); display: flex; align-items: center; gap: 15px;
        }
        .toast-box.hide { animation: fadeOut 0.5s forwards; }
        .toast-icon { color: var(--success); font-size: 1.5rem; }
        .toast-content strong { display: block; font-size: 0.95rem; color: #333; margin-bottom: 3px; }
        .toast-content span { font-size: 0.85rem; color: #666; }
        .toast-progress {
            position: absolute; bottom: 0; left: 0; height: 4px; background: var(--success);
            width: 100%; animation: progress 5s linear forwards;
        }
        @keyframes progress { from { width: 100%; } to { width: 0%; } }
        @keyframes slideInRight { from { transform: translateX(100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
        @keyframes fadeOut { to { opacity: 0; transform: translateY(-20px); } }

        /* HEADER */
        .header-floating { position: fixed; top: 30px; right: 5%; z-index: 1000; display:flex; gap:10px; align-items: center; }
        .icon-btn { width:50px; height:50px; border-radius:50%; border:none; background:white; box-shadow:0 4px 15px rgba(0,0,0,0.15); color:var(--accent); font-size:1.2rem; display:flex; align-items:center; justify-content:center; position:relative; }
        .icon-btn:hover { background:var(--primary); color:white; transform:scale(1.1); }
        .badge { position:absolute; top:-5px; right:-5px; background:var(--accent); color:white; width:22px; height:22px; border-radius:50%; font-size:0.75rem; display:flex; align-items:center; justify-content:center; font-weight:bold; border:2px solid white; }
        .login-btn-header { padding: 10px 25px; background: white; border: none; border-radius: 30px; font-weight: 700; color: var(--accent); box-shadow: 0 4px 15px rgba(0,0,0,0.15); display: flex; align-items: center; gap: 8px; font-size: 0.85rem; }
        .login-btn-header:hover { background: var(--primary); color: white; transform: translateY(-2px); }

        /* HERO */
        .hero { padding: 100px 20px 80px; text-align:center; background: radial-gradient(circle at top, #fff5f2 0%, transparent 100%); display: flex; flex-direction: column; align-items: center; }
        .hero img { width:180px; height:180px; border-radius:50%; object-fit:cover; border:5px solid white; box-shadow:var(--shadow); margin-bottom:20px; }
        .hero h1 { font-size:3.5rem; margin-bottom:10px; color:var(--accent); }
        .btn-cta { padding: 16px 50px; background: var(--accent); color: white; border-radius: 50px; border: none; font-weight: 700; font-size: 1.1rem; box-shadow: 0 10px 25px rgba(44,62,80,0.25); margin-top: 45px; animation: pulse 2s infinite; }
        .btn-cta:hover { transform: translateY(-5px); background: var(--primary); }
        @keyframes pulse { 0% { transform: scale(1); } 50% { transform: scale(1.05); } 100% { transform: scale(1); } }

        /* CONTAINER */
        .container { max-width:1200px; margin:0 auto; padding:40px 20px; flex: 1; }
        .filters { display:flex; justify-content:center; gap:12px; margin-bottom:50px; flex-wrap:wrap; }
        .filter-btn { padding: 10px 28px; border-radius: 30px; border: 1px solid #e0e0e0; background: white; color: #555; font-weight: 600; }
        .filter-btn:hover { background: var(--primary); color: white; border-color: var(--primary); transform: translateY(-3px); }
        .filter-btn.active { background: var(--accent); color: white; border-color: var(--accent); transform: scale(1.05); }

        .grid { display:grid; grid-template-columns:repeat(auto-fill, minmax(160px, 1fr)); gap:20px; }
        .card { background:white; border-radius:var(--radius); overflow:hidden; border:1px solid #f0f0f0; transition:0.4s; position:relative; cursor:pointer; }
        .card:hover { transform:translateY(-5px); box-shadow:var(--shadow); border-color:var(--primary); }
        .card img, .card video { width:100%; height:250px; object-fit:cover; background:#f9f9f9; }
        .card-info { padding:15px; text-align:center; }
        .tag-promo { position:absolute; top:10px; right:10px; background:#e91e63; color:white; padding:4px 10px; border-radius:20px; font-size:0.6rem; font-weight:bold; z-index: 2; }
        .tag-delivery { font-size: 0.7rem; color: #27ae60; display: block; margin-top: 5px; font-weight: 600; }

        /* --- MODERN PRODUCT MODAL LAYOUT --- */
        .product-modal-grid { display: grid; grid-template-columns: 1.2fr 1fr; gap: 30px; height: 100%; padding-top: 50px; } /* Added padding top for header */
        .pm-images { position: relative; background: #f4f4f4; border-radius: 16px; overflow: hidden; display: flex; align-items: center; justify-content: center; }
        .pm-details { padding: 10px; display: flex; flex-direction: column; overflow-y: auto; }
        
        .carousel-main-container { width: 100%; height: 100%; min-height: 400px; position: relative; display: flex; align-items: center; justify-content: center; }
        .carousel-main-container img, .carousel-main-container video { width: 100%; height: 100%; object-fit: contain; transition: opacity 0.5s ease-in-out; }
        .carousel-dots { position: absolute; bottom: 15px; left: 50%; transform: translateX(-50%); display: flex; gap: 8px; z-index: 10; }
        .carousel-dot { width: 8px; height: 8px; border-radius: 50%; background: rgba(0,0,0,0.3); cursor: pointer; transition: 0.3s; }
        .carousel-dot.active { background: var(--accent); transform: scale(1.3); }

        /* --- MODERN CHIPS FOR VARIATIONS --- */
        .var-chip-container { display: flex; flex-wrap: wrap; gap: 10px; margin-top: 10px; }
        .var-chip { padding: 8px 16px; border: 1px solid #eee; border-radius: 20px; cursor: pointer; transition: all 0.2s; background: white; font-weight: 600; font-size: 0.9rem; display: inline-flex; align-items: center; gap: 8px; color: #555; }
        .var-chip:hover { border-color: var(--primary); transform: translateY(-2px); }
        .var-chip.selected { background: var(--accent); color: white; border-color: var(--accent); box-shadow: 0 4px 10px rgba(44,62,80,0.3); }
        .var-chip.disabled { opacity: 0.5; cursor: not-allowed; background: #f9f9f9; border-color: #eee; }
        .color-circle { width: 12px; height: 12px; border-radius: 50%; border: 1px solid rgba(0,0,0,0.1); }

        /* MODALS & NAVIGATION HEADER */
        .overlay { position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.85); backdrop-filter:blur(8px); z-index:2000; display:none; align-items:center; justify-content:center; padding:20px; }
        .overlay.active { display:flex; animation: popIn 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
        @keyframes popIn { from{transform:scale(0.9); opacity:0;} to{transform:scale(1); opacity:1;} }
        
        .box { background:white; width:100%; max-width:1000px; border-radius:24px; overflow:hidden; max-height:90vh; display: flex; flex-direction: column; box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5); position: relative; }
        .box.single-col { display:block; max-width:500px; padding-top: 50px; }
        
        /* NEW FIXED NAV BUTTONS */
        .modal-header-fixed {
            position: absolute; top: 0; left: 0; width: 100%; height: 50px;
            background: white; border-bottom: 1px solid #eee; z-index: 100;
            display: flex; justify-content: space-between; align-items: center; padding: 0 15px;
        }
        .btn-nav-fixed {
            border: none; background: transparent; font-weight: 800; font-size: 0.75rem;
            cursor: pointer; display: flex; align-items: center; gap: 6px;
            text-transform: uppercase; letter-spacing: 0.5px; padding: 8px 12px; border-radius: 20px; transition: 0.2s;
        }
        .btn-nav-fixed.back { color: var(--info); background: #f0f8ff; }
        .btn-nav-fixed.back:hover { background: #e3f2fd; }
        .btn-nav-fixed.close { color: var(--danger); background: #fff0f0; }
        .btn-nav-fixed.close:hover { background: #ffebee; }

        /* SIDEBAR (SACOLA) */
        .sidebar { position:fixed; top:0; right:-500px; width:450px; height:100%; background:white; z-index:3000; padding:60px 30px 30px; box-shadow:-10px 0 50px rgba(0,0,0,0.1); transition:0.4s; display:flex; flex-direction:column; }
        .sidebar.open { right:0; }
        
        /* ADMIN/FORMS */
        .input { width:100%; padding:12px 15px; border:1px solid #ddd; border-radius:12px; font-size:0.95rem; margin-bottom:10px; background: #fafafa; transition:0.3s; }
        .input:focus { border-color: var(--primary); background: #fff; box-shadow: 0 0 0 3px rgba(196, 139, 120, 0.2); }
        .input-row { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        .input-cep-grid { display: grid; grid-template-columns: 1fr 2fr; gap: 10px; }

        /* MODERN FILE UPLOAD */
        .file-upload-wrapper { position: relative; border: 2px dashed #ccc; border-radius: 20px; padding: 30px; text-align: center; background: #fafafa; transition: 0.3s; cursor: pointer; margin-top: 15px; }
        .file-upload-wrapper:hover { border-color: var(--primary); background: #fff5f2; transform: translateY(-2px); }
        .file-upload-wrapper input[type="file"] { position: absolute; top: 0; left: 0; width: 100%; height: 100%; opacity: 0; cursor: pointer; }
        .file-preview-grid { display: flex; gap: 15px; flex-wrap: wrap; margin-top: 20px; justify-content: center; }
        .file-preview-item { width: 80px; height: 80px; border-radius: 12px; object-fit: cover; border: 2px solid #eee; cursor: pointer; position: relative; transition: 0.2s; }
        .file-preview-item:hover { transform: scale(1.05); }
        .file-preview-item.main-selected { border-color: var(--success); box-shadow: 0 0 0 3px rgba(39, 174, 96, 0.2); }
        .preview-wrapper { position: relative; }
        .main-tag { position: absolute; top: -8px; right: -8px; background: var(--success); color: white; font-size: 0.6rem; padding: 2px 6px; border-radius: 10px; display: none; font-weight: bold; }
        .file-preview-item.main-selected + .main-tag { display: block; }

        /* COMPACT DATE PICKER */
        .flatpickr-input { background: white !important; border: 1px solid #ddd !important; border-radius: 20px !important; padding: 8px 15px !important; font-weight: 600 !important; color: var(--accent) !important; cursor: pointer; text-align: center; width: 100%; font-size: 0.9rem !important; }
        .compact-date { max-width: 150px; }

        /* CHIP FILTERS */
        .chip-container { display: flex; gap: 8px; flex-wrap: wrap; margin-bottom: 20px; }
        .chip { padding: 8px 18px; border-radius: 25px; border: 1px solid #eee; background: white; color: #666; font-size: 0.85rem; font-weight: 600; cursor: pointer; transition: 0.2s; display: flex; align-items: center; gap: 6px; }
        .chip:hover { background: #f5f5f5; transform: translateY(-2px); }
        .chip.active { background: var(--accent); color: white; border-color: var(--accent); box-shadow: 0 4px 10px rgba(44,62,80,0.2); }
        .chip-dot { width: 8px; height: 8px; border-radius: 50%; display: inline-block; }
        
        /* FILTER BAR */
        .filter-wrapper { 
            background: #fff; padding: 15px; border-radius: 16px; margin-bottom: 25px; 
            border: 1px solid #eee; display: flex; align-items: flex-end; gap: 15px; flex-wrap: wrap; 
            box-shadow: 0 4px 20px rgba(0,0,0,0.03);
        }
        .date-group { display: flex; flex-direction: column; gap: 5px; }
        .date-group label { font-size: 0.75rem; font-weight: bold; color: #555; text-transform: uppercase; letter-spacing: 0.5px; }

        /* MODERN BUTTONS */
        .btn-modern {
            background: var(--accent); color: white; padding: 12px 24px; border-radius: 30px; border: none; font-weight: bold;
            display: flex; align-items: center; justify-content: center; gap: 8px; transition: all 0.3s;
            box-shadow: 0 4px 10px rgba(44,62,80,0.15); cursor: pointer; font-size: 0.95rem; text-decoration: none;
        }
        .btn-modern:hover { transform: translateY(-3px); box-shadow: 0 8px 20px rgba(44,62,80,0.25); background: var(--accent-light); color:white; }
        .btn-modern.outline { background: transparent; border: 2px solid #eee; color: #555; box-shadow: none; }
        .btn-modern.outline:hover { background: #f5f5f5; border-color: #ddd; color: var(--accent); }
        .btn-modern.small { padding: 8px 16px; font-size: 0.8rem; }
        .btn-modern.success { background: var(--success); }
        .btn-modern.success:hover { background: #219150; box-shadow: 0 8px 20px rgba(39,174,96,0.3); }
        .btn-modern.danger { background: var(--danger); }
        .btn-modern.danger:hover { background: #c0392b; box-shadow: 0 8px 20px rgba(231,76,60,0.3); }
        
        .btn-whatsapp { background: var(--whatsapp); color: white; border:none; box-shadow: 0 4px 15px rgba(37, 211, 102, 0.3); }
        .btn-whatsapp:hover { background: #1da851; transform: translateY(-3px); }
        .btn-mp { background: var(--mp); color: white; border:none; box-shadow: 0 4px 15px rgba(0, 158, 227, 0.3); }
        .btn-mp:hover { background: #007bb3; transform: translateY(-3px); }

        /* FINANCE CARDS */
        .fin-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 30px; }
        .fin-card-modern { background: white; border-radius: 16px; padding: 25px; border: 1px solid #f0f0f0; position: relative; overflow: hidden; box-shadow: var(--shadow); }
        .fin-card-modern::after { content:''; position:absolute; top:0; right:0; width:6px; height:100%; background: #ccc; }
        .fin-card-modern.rev::after { background: var(--info); }
        .fin-card-modern.cost::after { background: var(--danger); }
        .fin-card-modern.profit::after { background: var(--success); }
        .fin-card-modern.margin::after { background: var(--warning); }
        
        .fin-label { font-size: 0.8rem; text-transform: uppercase; color: #888; font-weight: bold; letter-spacing: 0.5px; }
        .fin-val-big { font-size: 1.8rem; font-weight: 800; color: var(--accent); margin-top: 8px; }
        
        /* DEBT/ORDER CARD */
        .debt-card, .order-card-modern, .client-order { 
            background: #fff; border-radius: 16px; padding: 25px; margin-bottom: 20px; 
            border: 1px solid #f0f0f0; box-shadow: 0 8px 24px rgba(0,0,0,0.04); transition: 0.3s; 
        }
        .debt-card:hover, .order-card-modern:hover { transform: translateY(-3px); box-shadow: 0 12px 30px rgba(0,0,0,0.08); }
        
        .debt-card { border-left: 6px solid var(--warning); }
        .debt-card.overdue { border-left-color: var(--danger); background: #fff5f5; }
        .debt-card.paid { border-left-color: var(--success); background: #f6fffa; opacity: 0.9; }
        
        .debt-header, .oc-header { display: flex; justify-content: space-between; margin-bottom: 15px; align-items: center; border-bottom: 1px dashed #eee; padding-bottom: 10px; }
        .debt-client, .oc-id { font-size: 1.15rem; font-weight: 800; color: var(--accent); }
        .debt-val-box { text-align: right; }
        .debt-total { font-size: 0.9rem; color: #777; }
        .debt-rest { font-size: 1.3rem; font-weight: 800; color: var(--danger); }
        .debt-card.paid .debt-rest { color: var(--success); }
        .oc-val { font-size: 1.1rem; font-weight: 700; color: #333; }

        .oc-body { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
        .oc-section { background: #fafafa; padding: 15px; border-radius: 12px; }
        .oc-section label { display: block; font-size: 0.75rem; text-transform: uppercase; color: #aaa; font-weight: bold; margin-bottom: 8px; }

        /* INSTALLMENTS */
        .installment-list { margin-top: 15px; background: white; border: 1px solid #eee; border-radius: 12px; overflow: hidden; display: none; }
        .installment-item { display: flex; justify-content: space-between; align-items: center; padding: 15px 20px; border-bottom: 1px solid #f5f5f5; font-size: 0.95rem; }
        .installment-item:last-child { border-bottom: none; }
        .installment-item.is-paid { background: #f0fff4; color: #27ae60; text-decoration: line-through; opacity: 0.7; }

        /* CUSTOM MODERN CHECKBOX */
        .custom-checkbox { position: relative; display: inline-block; width: 24px; height: 24px; cursor: pointer; }
        .custom-checkbox input { opacity: 0; width: 0; height: 0; }
        .checkmark { position: absolute; top: 0; left: 0; height: 24px; width: 24px; background-color: #fff; border-radius: 8px; transition: 0.2s; border: 2px solid #ddd; }
        .custom-checkbox:hover input ~ .checkmark { border-color: var(--primary); }
        .custom-checkbox input:checked ~ .checkmark { background-color: var(--success); border-color: var(--success); }
        .custom-checkbox input:checked ~ .checkmark:after { display: block; }
        .checkmark:after { content: ""; position: absolute; display: none; left: 7px; top: 3px; width: 6px; height: 12px; border: solid white; border-width: 0 2px 2px 0; transform: rotate(45deg); }

        /* PRODUCT ROW AND THUMBNAILS FIX */
        .order-prod-row { display: flex; gap: 15px; align-items: center; padding: 10px 0; border-bottom: 1px dashed #eee; }
        .order-prod-row img { width: 60px; height: 60px; border-radius: 10px; object-fit: cover; border: 1px solid #eee; flex-shrink: 0; }
        .order-prod-info { flex: 1; }
        .order-prod-name { font-weight: bold; font-size: 0.95rem; color: var(--accent); }
        .order-prod-var { font-size: 0.8rem; color: #777; margin-top: 2px; }
        .order-prod-qty { font-weight: bold; background: #eee; padding: 4px 10px; border-radius: 20px; font-size: 0.8rem; }

        /* MINI PROD ADMIN LIST FIX */
        .mini-prod { display: flex; align-items: center; gap: 15px; padding: 10px; border-bottom: 1px solid #f0f0f0; }
        .mini-prod img { width: 50px; height: 50px; border-radius: 8px; object-fit: cover; border: 1px solid #ddd; }
        
        /* ADMIN CHIP EDIT BUTTON */
        .btn-chip-edit { background: #fff; border: 1px solid #ddd; padding: 6px 14px; border-radius: 20px; font-size: 0.75rem; font-weight: 700; color: #555; display: inline-flex; align-items: center; gap: 5px; transition: 0.2s; text-transform: uppercase; letter-spacing: 0.5px; }
        .btn-chip-edit:hover { background: var(--accent); color: white; border-color: var(--accent); box-shadow: 0 4px 10px rgba(0,0,0,0.1); }

        /* MODERN TOGGLE SWITCH */
        .toggle-switch { position: relative; display: inline-block; width: 60px; height: 30px; margin-right: 10px; vertical-align: middle; }
        .toggle-switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #ccc; transition: .4s; border-radius: 34px; }
        .slider:before { position: absolute; content: ""; height: 22px; width: 22px; left: 4px; bottom: 4px; background-color: white; transition: .4s; border-radius: 50%; box-shadow: 0 2px 5px rgba(0,0,0,0.2); }
        input:checked + .slider { background-color: var(--primary); }
        input:focus + .slider { box-shadow: 0 0 1px var(--primary); }
        input:checked + .slider:before { transform: translateX(30px); }
        .toggle-label { font-weight: bold; vertical-align: middle; color: var(--accent); }

        /* ADMIN INTERACTIVE */
        .admin-nav { padding:20px; background:white; border-bottom:1px solid #eee; display:flex; gap:10px; overflow-x:auto; }
        .admin-tab { padding:10px 25px; border-radius:30px; border:1px solid #eee; background:transparent; font-weight:600; cursor:pointer; white-space:nowrap; color: #777; transition: all 0.3s ease; }
        .admin-tab:hover { background: #f0f0f0; color: var(--accent); }
        .admin-tab.active { background:var(--accent); color:white; border-color: var(--accent); box-shadow: 0 4px 15px rgba(44,62,80,0.2); }
        
        /* MODERN CHECKBOXES & BUTTONS (VARS) */
        .checkbox-section-title { font-weight:bold; margin-bottom:15px; display:block; color:var(--accent); font-size:1rem; margin-top: 10px;}
        .modern-checkbox-grid { display:flex; flex-wrap:wrap; gap:12px; margin-bottom:25px; }
        .hidden-check { display: none; }
        .color-option-label { width: 50px; height: 50px; border-radius: 50%; cursor: pointer; border: 3px solid #eee; transition: all 0.3s; display:flex; align-items:center; justify-content:center; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .color-option-label:hover { transform: scale(1.1); }
        .hidden-check:checked + .color-option-label { border-color: var(--accent); transform: scale(1.15); box-shadow: 0 5px 15px rgba(0,0,0,0.15); }
        .hidden-check:checked + .color-option-label::after { content: '\f00c'; font-family: 'Font Awesome 6 Free'; font-weight: 900; color: white; text-shadow: 0 1px 2px rgba(0,0,0,0.5); }
        .vol-option-label { padding: 10px 20px; border: 1px solid #ddd; border-radius: 30px; cursor: pointer; font-weight: 700; color: #777; background: white; transition: 0.3s; font-size: 0.9rem; }
        .hidden-check:checked + .vol-option-label { background: var(--accent); color: white; border-color: var(--accent); transform: translateY(-2px); box-shadow: 0 4px 10px rgba(44,62,80,0.2); }

        /* DASHBOARD GRID */
        .dashboard-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 20px; margin-top: 25px; }
        .dash-card { background: white; border-radius: 16px; padding: 20px; display: flex; align-items: center; gap: 20px; border: 1px solid #f0f0f0; position:relative; box-shadow: 0 5px 15px rgba(0,0,0,0.03); transition: 0.3s; }
        .dash-card:hover { transform: translateY(-3px); box-shadow: 0 10px 25px rgba(0,0,0,0.06); }
        .dash-card img { width: 70px; height: 70px; border-radius: 12px; object-fit: cover; border: 1px solid #eee; }
        .dash-card.sold-out { background: #fafafa; border-color: #eee; }
        .dash-card.sold-out img { filter: grayscale(100%); opacity: 0.5; }
        .tag-dashboard-sold { position: absolute; top: 15px; right: 15px; background: #999; color: white; padding: 4px 10px; border-radius: 20px; font-size: 0.7rem; font-weight: bold; }

        /* PROMO CAROUSEL LIST */
        .promo-list-container { display: flex; gap: 15px; overflow-x: auto; padding: 10px 5px; scroll-behavior: smooth; }
        .promo-list-card { min-width: 160px; width: 160px; background: white; border-radius: 16px; border: 1px solid #eee; padding: 10px; text-align: center; cursor: pointer; transition: 0.3s; flex-shrink: 0; }
        .promo-list-card:hover { transform: translateY(-5px); box-shadow: 0 10px 25px rgba(0,0,0,0.1); border-color: var(--primary); }
        .promo-list-card img { width: 100%; height: 140px; object-fit: cover; border-radius: 12px; margin-bottom: 10px; }
        .promo-price { color: var(--primary); font-weight: 800; font-size: 1.1rem; }

        /* STATUS SELECTOR */
        .status-selector { padding: 10px 15px; border-radius: 20px; border: none; font-weight: bold; font-size: 0.9rem; cursor: pointer; width: 100%; appearance: none; text-align: center; transition: 0.3s; }
        .st-pendente { background: #fff3cd; color: #856404; border: 1px solid #ffeeba; }
        .st-enviado { background: #d1ecf1; color: #0c5460; border: 1px solid #bee5eb; }
        .st-entregue { background: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .st-cancelado { background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }

        /* --- MODERN & CLEAN TRACKING --- */
        .track-container { position: relative; margin: 50px 0 30px; padding: 0 15px; }
        .track-line-bg { width: 100%; height: 4px; background: #eee; border-radius: 10px; position: absolute; top: 0; left: 0; z-index: 1; }
        .track-fill { height: 4px; background: var(--success); border-radius: 10px; position: absolute; top: 0; left: 0; z-index: 2; transition: width 1.5s cubic-bezier(0.4, 0, 0.2, 1); box-shadow: 0 0 10px rgba(39, 174, 96, 0.3); }
        .track-fill.cancelled { background: var(--danger); box-shadow: 0 0 10px rgba(231, 76, 60, 0.3); }
        .truck-icon-3d { position: absolute; top: -35px; z-index: 5; font-size: 1.8rem; color: var(--accent); transition: left 1.5s cubic-bezier(0.4, 0, 0.2, 1); transform: translateX(-50%); filter: drop-shadow(0 4px 6px rgba(0,0,0,0.1)); animation: drive 1s infinite alternate ease-in-out; }
        @keyframes drive { from { transform: translateX(-50%) translateY(0) rotate(-2deg); } to { transform: translateX(-50%) translateY(-2px) rotate(2deg); } }
        .track-steps { display: flex; justify-content: space-between; position: relative; z-index: 3; margin-top: 15px; }
        .track-step { text-align: center; position: relative; width: 33%; }
        .track-step .dot { width: 12px; height: 12px; background: #ddd; border-radius: 50%; margin: -23px auto 10px; border: 3px solid white; box-shadow: 0 2px 5px rgba(0,0,0,0.1); transition: 0.4s; }
        .track-step.active .dot { background: var(--success); transform: scale(1.2); }
        .track-step span { font-size: 0.7rem; font-weight: 700; color: #bbb; text-transform: uppercase; display: block; margin-top: 15px; letter-spacing: 0.5px; }
        .track-step.active span { color: var(--success); }
        .cancelled-dot .dot { background: var(--danger) !important; }
        .cancelled-dot span { color: var(--danger) !important; }

        /* DYNAMIC INSTALLMENT CARDS */
        .inst-gen-row { background: white; border: 1px solid #eee; padding: 10px; border-radius: 12px; display: grid; grid-template-columns: 40px 1fr 1fr auto !important; gap: 8px; align-items: center; margin-bottom: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.02); }
        .inst-gen-row input { background: #f9f9f9; border: 1px solid #ddd; border-radius: 8px; font-weight: 600; padding: 8px; }
        .inst-gen-row input.i-date, .inst-gen-row input.i-amount { width: 100%; min-width: 130px; }
        .qty-installments-input { width: 120px !important; margin: 0; text-align: center; }
        
        /* ADMIN WA BTN & MAPS */
        .admin-wa-btn { display: inline-flex; align-items: center; gap: 8px; background: #25D366; color: white; padding: 8px 15px; border-radius: 20px; text-decoration: none; font-weight: bold; font-size: 0.85rem; margin-top: 5px; box-shadow: 0 4px 10px rgba(37, 211, 102, 0.3); transition: 0.3s; }
        .admin-wa-btn:hover { background: #128c7e; transform: translateY(-2px); }
        .btn-map { background: #fff; border: 1px solid #ddd; padding: 5px 10px; border-radius: 20px; font-size: 0.8rem; text-decoration: none; color: #555; display: inline-flex; align-items: center; gap: 5px; margin-top: 5px; font-weight: bold; transition: 0.2s; }
        .btn-map:hover { background: #e8f0fe; color: #1a73e8; border-color: #1a73e8; }

        /* PARTIAL PAY CARD */
        .partial-pay-card { background: #fff; border: 1px solid #ffeeba; background-color: #fffdf5; padding: 15px; border-radius: 12px; margin-top: 10px; display: none; box-shadow: 0 5px 15px rgba(0,0,0,0.05); }
        .partial-pay-card.show { display: block; animation: slideDown 0.3s ease; }
        
        /* CUSTOMER LIST TABLE */
        .cust-table { width: 100%; border-collapse: collapse; margin-top: 10px; }
        .cust-table th { text-align: left; padding: 12px; border-bottom: 2px solid #eee; color: #888; font-size: 0.8rem; text-transform: uppercase; }
        .cust-table td { padding: 15px 12px; border-bottom: 1px solid #f5f5f5; color: #444; }
        .cust-table tr:hover { background: #fafafa; }
        .cust-badge { padding: 4px 10px; border-radius: 12px; font-size: 0.75rem; font-weight: bold; }
        .cust-badge.ok { background: #d4edda; color: #155724; }
        .cust-badge.warn { background: #fff3cd; color: #856404; }

        /* --- NOVO: ESTILOS PARA PEDIDO MANUAL ADMIN --- */
        .manual-order-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
        .manual-prod-adder { background: #f8f9fa; border: 1px dashed #ccc; padding: 15px; border-radius: 12px; display: flex; gap: 10px; align-items: center; flex-wrap: wrap; }
        .manual-cart-list { margin-top: 15px; border: 1px solid #eee; border-radius: 12px; overflow: hidden; }
        .manual-cart-item { display: flex; justify-content: space-between; align-items: center; padding: 10px 15px; background: white; border-bottom: 1px solid #f0f0f0; }

        /* --- NOVO ESTILO BOT√ÉO ENDERE√áO NA SACOLA --- */
        .btn-addr-trigger { width: 100%; padding: 15px; background: white; border: 2px dashed #ccc; border-radius: 16px; color: #777; font-weight: bold; cursor: pointer; transition: 0.3s; display: flex; align-items: center; justify-content: center; gap: 10px; margin-bottom: 20px; text-align: left; }
        .btn-addr-trigger:hover { border-color: var(--primary); background: #fffbf9; color: var(--primary); }
        .btn-addr-trigger.filled { border: 2px solid var(--primary); background: #fff5f2; color: var(--accent); justify-content: flex-start; }
        .btn-addr-trigger.filled i { color: var(--primary); font-size: 1.2rem; }

        /* MODERN INPUT LARGE */
        .modern-input-large { width: 100%; padding: 15px; font-size: 1.2rem; border: 2px solid #eee; border-radius: 12px; text-align: center; font-weight: bold; color: var(--accent); outline: none; transition: 0.3s; }
        .modern-input-large:focus { border-color: var(--primary); box-shadow: 0 0 0 4px rgba(196, 139, 120, 0.1); }

        footer { background: #222; color: #888; text-align: center; padding: 40px 20px; margin-top: auto; }
        footer button { color: #ddd; text-decoration: none; font-size: 0.8rem; font-weight: bold; border: 1px solid #444; padding: 8px 15px; border-radius: 20px; transition: 0.3s; cursor: pointer; background: transparent; }
        footer button:hover { background: #444; color: white; border-color: white; }

        #address-modal { z-index: 10005; background: rgba(0,0,0,0.9); }
        #admin-auth-modal .box { background: white; padding: 40px; text-align: center; border-radius: 20px; box-shadow: 0 20px 50px rgba(0,0,0,0.2); }
        #admin-auth-modal h2 { margin-bottom: 20px; color: var(--accent); }
        #admin-auth-modal i { font-size: 3rem; color: var(--accent); margin-bottom: 20px; }

        @media(max-width:768px){ 
            .box{grid-template-columns:1fr;} 
            .product-modal-grid { display: block; overflow-y: auto; }
            .sidebar{width:100%;} .hero{padding-top:80px;} .oc-body, .manual-order-grid { grid-template-columns: 1fr; } .filter-wrapper { justify-content: flex-start; } .inst-gen-row { grid-template-columns: 1fr 1fr !important; } .inst-gen-row span { grid-column: span 2; } .track-step span { font-size: 0.6rem; } 
        }
    </style>
</head>
<body>

    <div id="loading-screen">
        <i class="fas fa-circle-notch fa-spin fa-3x" style="color:var(--primary);"></i>
        <p style="margin-top:15px; color:#666;">Carregando loja...</p>
    </div>

    <div id="toast-container"></div>

    <div id="status-bar"></div>

    <div class="header-floating">
        <button class="login-btn-header" onclick="auth.checkProfile()">
            <i class="fas fa-user-circle"></i> Login / Cadastro
        </button>
        <button class="icon-btn" onclick="app.toggleCart()">
            <i class="fas fa-shopping-bag"></i><span class="badge" id="cart-count">0</span>
        </button>
    </div>

    <div class="hero">
        <img src="logo.jpg" onerror="this.src='https://via.placeholder.com/200?text=2A'">
        <h1 class="brand-font">2A Modas e Perfumes</h1>
        <p>Eleg√¢ncia que transforma. Descubra sua ess√™ncia.</p>
        <button class="btn-cta btn-pulse" onclick="app.openPromoModal()">‚ú® Ver Promo√ß√µes</button>
    </div>

    <div class="container" id="vitrine">
        <div class="filters">
            <button class="filter-btn active" onclick="app.filter('all', this)">Todos</button>
            <button class="filter-btn" onclick="app.filter('feminino', this)">Feminino</button>
            <button class="filter-btn" onclick="app.filter('infantil', this)">Infantil</button>
            <button class="filter-btn" onclick="app.filter('perfumes', this)">Perfumes</button>
        </div>
        <div id="products-list" class="grid"></div>
    </div>

    <footer>
        <p class="brand-font">¬© 2025 2A Modas e Perfumes.</p>
        <br>
        <button onclick="admin.showLogin()">√Årea Administrativa</button>
    </footer>

    <div id="promo-modal" class="overlay">
        <div class="box single-col" style="background:var(--bg); overflow:hidden; max-width:800px;">
            <div class="modal-header-fixed">
                <button onclick="app.closeModal('promo-modal')" class="btn-nav-fixed back"><i class="fas fa-arrow-left"></i> VOLTAR</button>
                <button onclick="app.closeModal('promo-modal')" class="btn-nav-fixed close">FECHAR <i class="fas fa-times"></i></button>
            </div>
            <div style="padding:20px; margin-top: 50px;">
                <h3>üî• Ofertas Especiais</h3>
            </div>
            <div class="carousel-wrapper" style="padding: 0 20px 20px;">
                <div id="promo-track" class="promo-list-container"></div>
            </div>
        </div>
    </div>

    <div id="product-modal" class="overlay">
        <div class="box" style="padding: 20px; height: 85vh; max-height: 700px;">
            <div class="modal-header-fixed">
                <button onclick="app.closeModal('product-modal')" class="btn-nav-fixed back"><i class="fas fa-arrow-left"></i> VOLTAR</button>
                <button onclick="app.closeModal('product-modal')" class="btn-nav-fixed close">FECHAR <i class="fas fa-times"></i></button>
            </div>
            <div class="product-modal-grid">
                <div class="pm-images" id="m-media-area"></div>
                <div class="pm-details">
                    <small id="m-cat" style="color:var(--primary); font-weight:800; text-transform:uppercase; letter-spacing: 1px; font-size: 0.8rem;">Categoria</small>
                    <h2 id="m-title" style="margin:5px 0 15px; font-size: 2rem; line-height: 1.1;"></h2>
                    <h3 id="m-price" style="color:var(--accent); margin-bottom:15px; font-size: 1.8rem;"></h3>
                    <div style="background:#f8f9fa; padding:15px; border-radius:12px; margin-bottom:20px;">
                        <p id="m-desc" style="color:#666; font-size: 0.95rem; line-height: 1.6;"></p>
                    </div>
                    <div style="margin-bottom:25px;">
                        <label style="font-weight:bold; font-size:0.9rem; margin-bottom:10px; display:block; color: var(--accent);">Escolha uma op√ß√£o:</label>
                        <div id="m-vars" class="var-chip-container"></div>
                    </div>
                    <div style="margin-top: auto;">
                        <div style="margin-bottom: 15px; color:#27ae60; font-weight:600; font-size: 0.9rem; display: flex; align-items: center; gap: 8px;">
                            <i class="fas fa-truck"></i> Entrega: 03 a 05 dias √∫teis
                        </div>
                        <div style="display:flex; gap:15px;">
                            <div style="border:1px solid #ddd; border-radius:30px; display:flex; align-items: center; height: 50px;">
                                <button onclick="app.updQty(-1)" style="padding:0 15px; border:none; background:transparent; font-size: 1.2rem;">-</button>
                                <span id="m-qty" style="font-weight:bold; width: 20px; text-align: center;">1</span>
                                <button onclick="app.updQty(1)" style="padding:0 15px; border:none; background:transparent; font-size: 1.2rem;">+</button>
                            </div>
                            <button onclick="app.addCart()" class="btn-modern" style="flex:1; height: 50px; font-size: 1.1rem;">Adicionar √† Sacola</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="address-modal" class="overlay" style="justify-content:flex-start; padding-left:20px; z-index:10001;">
        <div class="box single-col" style="width:100%; max-width:500px; height:auto; overflow-y: auto;">
            <div class="modal-header-fixed">
                <button onclick="app.closeModal('address-modal')" class="btn-nav-fixed back"><i class="fas fa-arrow-left"></i> VOLTAR</button>
                <button onclick="app.closeModal('address-modal')" class="btn-nav-fixed close">FECHAR <i class="fas fa-times"></i></button>
            </div>
            <div style="padding:25px; margin-top: 50px;">
                <h3>üìç Onde entregar?</h3>
                <div id="saved-addresses-list" style="margin-bottom:20px; max-height:150px; overflow-y:auto;"></div>
                <div style="background:#f9f9f9; padding:20px; border-radius:16px;">
                    <h4>Novo Endere√ßo</h4>
                    <div class="input-cep-grid">
                        <input type="text" id="addr-cep" class="input" placeholder="CEP (00000-000)" onblur="app.fetchCep(this.value, 'addr')" maxlength="9">
                        <a href="https://buscacepinter.correios.com.br/app/endereco/index.php" target="_blank" style="font-size:0.8rem; display:flex; align-items:center;">N√£o sei meu CEP</a>
                    </div>
                    <input type="text" id="addr-street" class="input" placeholder="Rua / Logradouro">
                    <div class="input-row">
                        <input type="text" id="addr-num" class="input" placeholder="N√∫mero">
                        <input type="text" id="addr-bairro" class="input" placeholder="Bairro">
                    </div>
                    <div class="input-row">
                        <input type="text" id="addr-city" class="input" placeholder="Cidade">
                        <input type="text" id="addr-uf" class="input" placeholder="Estado (UF)" maxlength="2">
                    </div>
                    <input type="text" id="addr-ref" class="input" placeholder="Ponto de Refer√™ncia">
                    <input type="text" id="addr-name" class="input" placeholder="Nome de quem recebe">
                    <input type="text" id="addr-phone" class="input" placeholder="Telefone / WhatsApp">
                    <label style="display:block; margin:10px 0; font-weight:bold;">Salvar como:</label>
                    <select id="addr-type" class="input">
                        <option value="Casa">Casa</option>
                        <option value="Trabalho">Trabalho</option>
                        <option value="Outro">Outro</option>
                    </select>
                    <button onclick="app.addNewAddress()" class="btn-modern" style="width:100%;">Salvar Endere√ßo</button>
                </div>
            </div>
        </div>
    </div>

    <div id="client-modal" class="overlay">
        <div class="box single-col" style="max-width:600px;">
            <div class="modal-header-fixed">
                <button onclick="app.closeModal('client-modal')" class="btn-nav-fixed back"><i class="fas fa-arrow-left"></i> VOLTAR</button>
                <button onclick="app.closeModal('client-modal')" class="btn-nav-fixed close">FECHAR <i class="fas fa-times"></i></button>
            </div>
            <div style="padding:30px; margin-top: 50px;">
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
                    <h2>Minha Conta</h2>
                </div>
                <div style="background:#f9f9f9; padding:20px; border-radius:16px; margin-bottom:25px;">
                    <h4>Meus Dados</h4>
                    <p id="client-info-txt" style="color:#666; font-size:0.95rem; line-height:1.6; margin-bottom:10px;"></p>
                    <button onclick="auth.logout()" class="btn-modern outline small">Sair</button>
                </div>
                
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
                    <h3>Meus Pedidos</h3>
                </div>
                <div class="filter-wrapper">
                    <div class="date-group">
                        <label>De:</label>
                        <input type="text" id="client-date-start" class="flatpickr-input compact-date" onchange="auth.loadClientOrders()">
                    </div>
                    <div class="date-group">
                        <label>At√©:</label>
                        <input type="text" id="client-date-end" class="flatpickr-input compact-date" onchange="auth.loadClientOrders()">
                    </div>
                </div>
                
                <div id="client-orders-list" style="max-height:450px; overflow-y:auto; margin-top:15px;"></div>
            </div>
        </div>
    </div>

    <div class="sidebar">
        <div class="modal-header-fixed">
            <button onclick="app.toggleCart()" class="btn-nav-fixed back"><i class="fas fa-arrow-left"></i> VOLTAR</button>
            <button onclick="app.toggleCart()" class="btn-nav-fixed close">FECHAR <i class="fas fa-times"></i></button>
        </div>
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px; border-bottom:1px solid #eee; padding-bottom:15px;">
            <h2 style="margin:0;">Sua Sacola</h2>
        </div>
        
        <div style="background: white; border: 1px solid #eee; padding: 15px; border-radius: 16px; margin-bottom: 20px; box-shadow: 0 4px 10px rgba(0,0,0,0.03); display: flex; align-items: center; gap: 10px;">
            <i class="fas fa-truck" style="color: var(--success); font-size: 1.2rem;"></i>
            <div>
                <strong style="display: block; font-size: 0.9rem;">Entrega R√°pida</strong>
                <small style="color: #666;">Receba em 03 a 05 dias √∫teis</small>
            </div>
        </div>

        <div style="flex:1; overflow-y:auto;">
            <ul id="cart-list" style="list-style:none;"></ul>
        </div>
        
        <div style="border-top:1px solid #eee; padding-top:25px;">
            <div id="cart-auth-area" style="margin-bottom:15px;">
                <button onclick="app.showModal('auth-modal')" style="width:100%; padding:12px; background:#f0f0f0; border:none; border-radius:12px; color:#555; font-weight:bold;">
                    <i class="fas fa-user-circle"></i> Fazer Login / Cadastro
                </button>
            </div>
            
            <button id="btn-address-trigger" onclick="app.openAddressModal()" class="btn-addr-trigger">
                <i class="fas fa-map-marker-alt"></i> Cadastrar local de entrega
            </button>
            
            <div style="background: #fafafa; padding: 15px; border-radius: 12px; margin-bottom: 20px;">
                <div style="display:flex; justify-content:space-between; font-weight:bold; font-size:1.1rem; color: var(--accent);">
                    <span>Total</span> <span id="cart-total">R$ 0.00</span>
                </div>
            </div>

            <button onclick="app.checkout('whatsapp')" class="btn-modern btn-whatsapp btn-pulse" style="width: 100%; margin-bottom: 10px;">
                <i class="fab fa-whatsapp"></i> Falar Via WhatsApp
            </button>
            <button onclick="app.checkout('mercadopago')" class="btn-modern btn-mp btn-pulse" style="width: 100%;">
                <i class="fas fa-qrcode"></i> Pagar via Pix/Cart√£o
            </button>
        </div>
    </div>

    <div id="auth-modal" class="overlay" style="z-index:10002;">
        <div class="box single-col" style="padding:40px; text-align:center; max-width:400px;">
            <div class="modal-header-fixed">
                <button onclick="app.closeModal('auth-modal')" class="btn-nav-fixed back"><i class="fas fa-arrow-left"></i> VOLTAR</button>
                <button onclick="app.closeModal('auth-modal')" class="btn-nav-fixed close">FECHAR <i class="fas fa-times"></i></button>
            </div>
            <div style="margin-top: 50px;">
                <h2 id="auth-title" style="margin-bottom:25px;">Acesso</h2>
                <div id="form-login">
                    <input type="email" id="l-email" class="input" placeholder="E-mail">
                    <input type="password" id="l-pass" class="input" placeholder="Senha">
                    <button onclick="auth.login()" class="btn-modern" style="width:100%;">Entrar</button>
                    <p style="margin-top:20px; font-size:0.9rem;">N√£o tem conta? <a href="#" onclick="auth.toggle('register')">Cadastre-se</a></p>
                </div>
                <div id="form-register" style="display:none;">
                    <input type="text" id="r-name" class="input" placeholder="Nome">
                    <input type="email" id="r-email" class="input" placeholder="E-mail">
                    <input type="password" id="r-pass" class="input" placeholder="Senha">
                    <button onclick="auth.register()" class="btn-modern" style="width:100%;">Cadastrar</button>
                    <p style="margin-top:20px; font-size:0.9rem;"><a href="#" onclick="auth.toggle('login')">Voltar</a></p>
                </div>
            </div>
        </div>
    </div>

    <div id="admin-auth-modal" class="overlay" style="z-index:10003;">
        <div class="box single-col" style="max-width: 350px;">
            <div class="modal-header-fixed">
                <button onclick="app.closeModal('admin-auth-modal')" class="btn-nav-fixed back"><i class="fas fa-arrow-left"></i> VOLTAR</button>
                <button onclick="app.closeModal('admin-auth-modal')" class="btn-nav-fixed close">FECHAR <i class="fas fa-times"></i></button>
            </div>
            <div style="padding:30px; text-align: center; margin-top: 50px;">
                <i class="fas fa-lock"></i>
                <h2>√Årea Restrita</h2>
                <input type="password" id="admin-pass" class="input" placeholder="Digite a senha" style="text-align:center; font-size:1.2rem;" onkeydown="if(event.key==='Enter') admin.verifyLogin()">
                <button onclick="admin.verifyLogin()" class="btn-modern" style="width:100%;">Entrar</button>
            </div>
        </div>
    </div>

    <div id="admin-modal" class="overlay" style="z-index:2001; background:#f4f6f9; align-items:flex-start; padding:0;">
        <div class="box" style="max-width:100%; height:100%; border-radius:0; padding:0; display:flex; flex-direction:column;">
            <div class="admin-nav">
                <h3 style="margin-right:20px; align-self:center;">Admin 2A</h3>
                <button onclick="admin.tab('dash')" class="admin-tab active">Estoque</button>
                <button onclick="admin.tab('orders')" class="admin-tab">Pedidos</button>
                <button onclick="admin.tab('new-order')" class="admin-tab" style="color:var(--primary); border-color:var(--primary);"><i class="fas fa-plus-circle"></i> Novo Pedido</button>
                <button onclick="admin.tab('customers')" class="admin-tab"><i class="fas fa-users"></i> Clientes</button>
                <button onclick="admin.tab('pay')" class="admin-tab">Financeiro</button>
                <button onclick="admin.tab('prod')" class="admin-tab">Produtos</button>
                <button onclick="admin.tab('backup')" class="admin-tab" style="color:var(--danger)"><i class="fas fa-trash-alt"></i> Lixeira/Backups</button>
                <button onclick="admin.resetData()" class="btn-modern danger small" style="margin-left:20px;">Resetar</button>
            </div>
            <div style="flex:1; overflow-y:auto; padding:30px; width:100%; max-width:1200px; margin:0 auto;">
                
                <div id="tab-dash">
                    <div style="display:grid; grid-template-columns:repeat(auto-fit, minmax(250px, 1fr)); gap:20px; margin-bottom:30px;">
                        <div class="fin-card-modern profit"><div class="fin-label">Valor Estoque (Venda)</div><div id="st-rev" class="fin-val-big">R$ 0.00</div></div>
                        <div class="fin-card-modern cost"><div class="fin-label">Custo Total</div><div id="st-cost" class="fin-val-big">R$ 0.00</div></div>
                        <div class="fin-card-modern"><div class="fin-label">Itens Total</div><div id="st-qty" class="fin-val-big">0</div></div>
                    </div>
                    <div class="dashboard-grid" id="dash-stock-grid"></div>
                </div>

                <div id="tab-orders" style="display:none;">
                    <div style="background:white; padding:25px; border-radius:16px;">
                        <h3>Pedidos</h3>
                        <div class="filter-wrapper"><div class="date-group"><label>De:</label><input type="text" id="order-start" class="flatpickr-input compact-date"></div><div class="date-group"><label>At√©:</label><input type="text" id="order-end" class="flatpickr-input compact-date"></div></div>
                        <div class="chip-container" id="order-filters">
                            <button class="chip active" onclick="admin.filterOrders('all', this)">Todos</button>
                            <button class="chip" onclick="admin.filterOrders('Pendente', this)">Pendente</button>
                            <button class="chip" onclick="admin.filterOrders('Enviado', this)">Enviado</button>
                            <button class="chip" onclick="admin.filterOrders('Entregue', this)">Entregue</button>
                            <button class="chip" onclick="admin.filterOrders('Cancelado', this)">Cancelado</button>
                        </div>
                        <div id="orders-list"></div>
                    </div>
                </div>

                <div id="tab-customers" style="display:none;">
                    <div style="background:white; padding:25px; border-radius:16px;">
                        <h3>Clientes & Posi√ß√£o Financeira</h3>
                        <div id="customers-list-container"></div>
                    </div>
                </div>

                <div id="tab-backup" style="display:none;">
                    <div style="background:white; padding:25px; border-radius:16px; border:2px dashed #e74c3c;">
                        <h3 style="color:#c0392b;">Pedidos Arquivados (Backup)</h3>
                        <p style="color:#666;">Hist√≥rico de pedidos resetados da tela principal.</p>
                        <div id="backup-list"></div>
                    </div>
                </div>

                <div id="tab-new-order" style="display:none;">
                    <div style="background:white; padding:30px; border-radius:16px; max-width: 900px; margin: 0 auto;">
                        <h3><i class="fas fa-edit"></i> Criar Pedido Manual</h3>
                        <div class="manual-order-grid">
                            <div>
                                <h4 style="margin-bottom:10px;">Cliente</h4>
                                <input type="text" id="m-client-name" class="input" placeholder="Nome">
                                <input type="email" id="m-client-email" class="input" placeholder="E-mail">
                                <input type="text" id="m-client-phone" class="input" placeholder="Telefone">
                                <hr style="margin:10px 0; border:0; border-top:1px dashed #eee;">
                                <div class="input-cep-grid"><input type="text" id="m-client-cep" class="input" placeholder="CEP" onblur="app.fetchCep(this.value, 'manual')"><span>Busca</span></div>
                                <input type="text" id="m-client-street" class="input" placeholder="Rua">
                                <div class="input-row"><input type="text" id="m-client-num" class="input" placeholder="N¬∫"><input type="text" id="m-client-bairro" class="input" placeholder="Bairro"></div>
                                <div class="input-row"><input type="text" id="m-client-city" class="input" placeholder="Cidade"><input type="text" id="m-client-uf" class="input" placeholder="UF"></div>
                                <h4 style="margin:20px 0 10px;">Pagamento</h4>
                                <div class="input-row"><select id="m-payment-method" class="input"><option>Dinheiro</option><option>Pix</option><option>Cart√£o</option></select><select id="m-payment-status" class="input"><option value="Pago">Pago</option><option value="Pendente">A Pagar</option></select></div>
                            </div>
                            <div>
                                <h4 style="margin-bottom:10px;">Itens</h4>
                                <div class="manual-prod-adder">
                                    <select id="m-prod-select" class="input" style="flex:2;"><option value="">Selecione...</option></select>
                                    <input type="number" id="m-prod-qty" class="input" value="1" style="width:60px;">
                                    <button onclick="admin.addManualItem()" class="btn-modern small">+</button>
                                </div>
                                <div class="manual-prod-adder" style="margin-top:10px; background:#fff5f2;"><input type="text" id="m-custom-item" class="input" placeholder="Item avulso" style="flex:2;"><input type="number" id="m-custom-price" class="input" placeholder="R$" style="width:80px;"><button onclick="admin.addCustomItem()" class="btn-modern small success">+</button></div>
                                <div id="manual-cart-list" class="manual-cart-list"></div>
                                <div style="display:flex; justify-content:space-between; margin-top:15px; font-weight:800; font-size:1.2rem;"><span>Total</span><span id="m-total-display">R$ 0.00</span></div>
                            </div>
                        </div>
                        <button onclick="admin.saveManualOrder()" class="btn-modern" style="width:100%; margin-top:20px; justify-content:center;">Salvar Pedido</button>
                    </div>
                </div>

                <div id="tab-pay" style="display:none;">
                    <div style="background:white; padding:25px; border-radius:16px;">
                        <h3>Financeiro Real</h3>
                        <div class="filter-wrapper" style="background:#f0f9ff;"><input type="text" id="fin-start" class="flatpickr-input compact-date"><input type="text" id="fin-end" class="flatpickr-input compact-date"></div>
                        <div class="fin-grid">
                            <div class="fin-card-modern profit"><div class="fin-label">Vendas (Receita)</div><div id="fin-real-revenue" class="fin-val-big">R$ 0.00</div></div>
                            <div class="fin-card-modern cost"><div class="fin-label">Total Gerado</div><div id="fin-total-created" class="fin-val-big">R$ 0.00</div></div>
                        </div>
                        <div class="chip-container" id="pay-filters"><button class="chip active" onclick="admin.filterPayments('all', this)">Todos</button><button class="chip" onclick="admin.filterPayments('A_pagar', this)">√Ä Pagar</button><button class="chip" onclick="admin.filterPayments('Pago', this)">Quitados</button></div>
                        <div id="pay-list"></div>
                    </div>
                </div>

                <div id="tab-prod" style="display:none;">
                    <div style="background:white; padding:30px; border-radius:16px;">
                        <h3>Cadastro</h3>
                        <input type="hidden" id="edit-id">
                        <input type="text" id="f-name" class="input" placeholder="Nome">
                        <div style="display:flex; gap:10px;"><select id="f-cat" class="input"><option value="feminino">Feminino</option><option value="infantil">Infantil</option><option value="perfumes">Perfumes</option></select><input type="number" id="f-cost" class="input" placeholder="Custo"></div>
                        <div class="input-row"><input type="number" id="f-price-global" class="input" placeholder="Venda"><input type="number" id="f-stock-global" class="input" placeholder="Estoque"></div>
                        <div class="file-upload-wrapper" onclick="document.getElementById('f-file').click()"><p>Toque para fotos</p><input type="file" id="f-file" multiple onchange="admin.handleFileSelect(this)"></div>
                        <div id="file-preview-area" class="file-preview-grid"></div>
                        <div class="modern-checkbox-grid" id="color-checks"></div>
                        <div class="modern-checkbox-grid" id="volume-checks"></div>
                        <div id="active-vars-area"></div>
                        <button onclick="admin.save()" class="btn-modern" style="width:100%; margin-top:20px;">Salvar</button>
                    </div>
                    <div id="admin-list" style="margin-top:20px;"></div>
                </div>
            </div>
            
            <div class="modal-header-fixed" style="top: auto; bottom: 0; border-top: 1px solid #eee; border-bottom: none;">
                <button onclick="app.closeModal('admin-modal')" class="btn-nav-fixed back"><i class="fas fa-arrow-left"></i> VOLTAR</button>
                <button onclick="app.closeModal('admin-modal')" class="btn-nav-fixed close">FECHAR <i class="fas fa-times"></i></button>
            </div>
        </div>
    </div>

    <script>
        setTimeout(() => { document.getElementById('loading-screen').style.display='none'; }, 2000);
        // CONFIG
        const SUPABASE_URL = 'https://sdeslwemzhxqixmphyye.supabase.co'; 
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InNkZXNsd2Vtemh4cWl4bXBoeXllIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjY3MDUxNDUsImV4cCI6MjA4MjI4MTE0NX0.QK7PkbYOnT6nIRFZHtHsuh42EuCjMSVvdnxf7h1bD80';
        const GOOGLE_CLOUD_URL = 'https://criarpagamentoss-967029810770.southamerica-east1.run.app'; 
        const EMAILJS_PUBLIC_KEY = 'vEXIgVw6GynR5W1qj'; 
        const EMAILJS_SERVICE_ID = 'service_3x4ghcd';
        const EMAILJS_TEMPLATE_CLIENTE = 'template_rwf0bay';
        const EMAILJS_TEMPLATE_ADMIN = 'template_rwf0bay';

        let sb = null; try { sb = supabase.createClient(SUPABASE_URL, SUPABASE_KEY); } catch(e) { console.error(e); }

        const state = { products: [], cart: [], current: null, var: null, qty: 1, user: null, address: null, adminOrders: [], filterStatus: 'all', filterPay: 'all', selectedFiles: [], mainImageIndex: 0 };
        const PRESETS_VOL = ['25ml','50ml','75ml','100ml','200ml','P','M','G','GG','Unico'];
        const COLOR_MAP = { 'Preto': '#000000', 'Branco': '#ffffff', 'Vermelho': '#e74c3c', 'Azul': '#3498db', 'Rosa': '#e91e63', 'Verde': '#2ecc71', 'Nude': '#e3c0a5', 'Estampado': 'linear-gradient(45deg, red, blue)', 'Bege': '#f5f5dc', 'Amarelo': '#f1c40f', 'Cinza': '#95a5a6' };
        
        const safeVal = (v) => (v === null || v === undefined || v === "null") ? "" : v;
        const setSafe = (id, val) => { const el = document.getElementById(id); if(el) el.innerText = safeVal(val); };
        let autoScrollInterval;

        // TOAST FUNCTION
        const showToast = (msg) => {
            const container = document.getElementById('toast-container');
            const toast = document.createElement('div');
            toast.className = 'toast-box';
            toast.innerHTML = `<i class="fas fa-check-circle toast-icon"></i><div class="toast-content"><strong>Sucesso!</strong><span>${msg}</span></div><div class="toast-progress"></div>`;
            container.appendChild(toast);
            setTimeout(() => { toast.classList.add('hide'); setTimeout(() => toast.remove(), 500); }, 5000);
        };

        document.addEventListener('DOMContentLoaded', () => {
            flatpickr(".flatpickr-input", { dateFormat: "Y-m-d", locale: "pt", altInput: true, altFormat: "d/m/Y" });
        });

        const app = {
            load: async () => {
                if(!sb) return;
                const { data, error } = await sb.from('products').select('*');
                if(!error) { state.products = data || []; app.render(state.products); }
            },
            render: (list) => {
                const div = document.getElementById('products-list'); if(!div) return; div.innerHTML = "";
                list.forEach(p => {
                    const vars = typeof p.variations === 'string' ? JSON.parse(p.variations) : p.variations;
                    const minP = (vars && vars.length) ? Math.min(...vars.map(v => parseFloat(v.price))) : 0;
                    const isPromo = p.is_promo ? '<span class="tag-promo">OFERTA</span>' : '';
                    let mainImg = "https://via.placeholder.com/300";
                    try { const media = JSON.parse(p.image_url); if(Array.isArray(media) && media.length > 0) mainImg = media[0]; } catch(e) { mainImg = p.image_url; }
                    div.innerHTML += `<div class="card" onclick="app.openModal('${p.id}')">${isPromo}<img src="${mainImg}" onerror="this.src='https://via.placeholder.com/300'"><div class="card-info"><span style="font-size:0.8rem;color:#999;text-transform:uppercase;">${p.category}</span><div style="font-weight:bold;margin:5px 0;">${p.name}</div><div style="color:var(--primary);font-weight:bold;">A partir R$ ${minP.toFixed(2)}</div><span class="tag-delivery">üöö 03 a 05 dias √∫teis</span></div></div>`;
                });
            },
            openPromoModal: () => {
                const promos = state.products.filter(p => p.is_promo);
                if(!promos.length) return alert("Sem promo√ß√µes ativas.");
                const cDiv = document.getElementById('promo-track'); cDiv.innerHTML = "";
                const shownIds = new Set();
                promos.forEach(p => {
                    if(shownIds.has(p.id)) return; shownIds.add(p.id);
                    const vars = JSON.parse(p.variations); const minP = Math.min(...vars.map(v => v.price));
                    let mainImg = JSON.parse(p.image_url)[0];
                    cDiv.innerHTML += `<div class="promo-list-card" onclick="app.closeModal('promo-modal'); setTimeout(() => app.openModal('${p.id}'), 100)"><img src="${mainImg}"><div><strong>${p.name}</strong><br><small class="promo-price">R$ ${minP.toFixed(2)}</small></div></div>`;
                });
                app.showModal('promo-modal');
            },
            openModal: (id) => {
                const p = state.products.find(x => String(x.id) === String(id));
                if(!p) return;
                state.current = p; state.qty=1; state.var=null;
                let media = []; try { media = JSON.parse(p.image_url); } catch(e) { media = [p.image_url]; }
                if(!Array.isArray(media)) media = [p.image_url];
                app.renderCarousel(media);
                setSafe('m-title', p.name); setSafe('m-cat', p.category); setSafe('m-desc', p.description); setSafe('m-price', "Selecione...");
                const vDiv = document.getElementById('m-vars'); vDiv.innerHTML = "";
                const vars = typeof p.variations === 'string' ? JSON.parse(p.variations) : p.variations;
                if(vars) {
                    vars.forEach(v => {
                        const hasStock = parseInt(v.stock) > 0;
                        const chip = document.createElement('div');
                        chip.className = `var-chip ${!hasStock ? 'disabled' : ''}`;
                        let dot = ""; if(COLOR_MAP[v.name]) dot = `<div class="color-circle" style="background:${COLOR_MAP[v.name]}"></div>`;
                        chip.innerHTML = `${dot}<span>${v.name}</span><small style="opacity:0.8">R$ ${parseFloat(v.price).toFixed(2)}</small>`;
                        if(hasStock) {
                            chip.onclick = () => { state.var = v; document.getElementById('m-price').innerText = `R$ ${parseFloat(v.price).toFixed(2)}`; Array.from(vDiv.children).forEach(c => c.classList.remove('selected')); chip.classList.add('selected'); };
                        }
                        vDiv.appendChild(chip);
                    });
                }
                app.showModal('product-modal');
            },
            renderCarousel: (media) => {
                const area = document.getElementById('m-media-area');
                if(!media.length) { area.innerHTML = ''; return; }
                const isVideo = (url) => url && url.match && url.match(/\.(mp4|webm)$/i);
                let dotsHtml = '';
                if(media.length > 1) { dotsHtml = `<div class="carousel-dots">${media.map((_, i) => `<div class="carousel-dot ${i===0?'active':''}" onclick="app.swapMedia('${media[i]}', this, ${i})"></div>`).join('')}</div>`; }
                const renderMain = (url) => isVideo(url) ? `<video src="${url}" controls autoplay muted loop></video>` : `<img src="${url}">`;
                area.innerHTML = `<div class="carousel-main-container" id="c-main" onmouseenter="clearInterval(autoScrollInterval)" onmouseleave="app.startAutoScroll()">${renderMain(media[0])}${dotsHtml}</div>`;
                if(media.length > 1) { app.currentMediaIndex = 0; app.currentMediaList = media; app.startAutoScroll(); } else { clearInterval(autoScrollInterval); }
            },
            startAutoScroll: () => {
                if(app.currentMediaList && app.currentMediaList.length > 1) {
                    clearInterval(autoScrollInterval);
                    autoScrollInterval = setInterval(() => {
                        let nextIndex = app.currentMediaIndex + 1;
                        if(nextIndex >= app.currentMediaList.length) nextIndex = 0;
                        const dots = document.querySelectorAll('.carousel-dot');
                        if(dots[nextIndex]) app.swapMedia(app.currentMediaList[nextIndex], dots[nextIndex], nextIndex);
                    }, 3000);
                }
            },
            swapMedia: (url, dot, index) => {
                const isVideo = (u) => u.match(/\.(mp4|webm)$/i);
                const main = document.getElementById('c-main');
                const imgEl = main.querySelector('img');
                if(isVideo(url)) { main.innerHTML = `<video src="${url}" controls autoplay muted loop></video>` + (main.querySelector('.carousel-dots')?.outerHTML || ''); }
                else {
                    if(imgEl) { imgEl.style.opacity = 0; setTimeout(() => { imgEl.src = url; imgEl.style.opacity = 1; }, 200); }
                    else { main.innerHTML = `<img src="${url}">` + (main.querySelector('.carousel-dots')?.outerHTML || ''); }
                }
                if(dot) { document.querySelectorAll('.carousel-dot').forEach(t => t.classList.remove('active')); dot.classList.add('active'); }
                if(typeof index !== 'undefined') app.currentMediaIndex = index;
            },
            updQty: (n) => { if (n > 0) { if (!state.var) return alert("Selecione a varia√ß√£o primeiro."); if (state.qty + n > parseInt(state.var.stock)) return alert("Estoque m√°ximo atingido."); } state.qty += n; if(state.qty<1) state.qty=1; document.getElementById('m-qty').innerText = state.qty; },
            addCart: () => { if(!state.var) return alert("Selecione uma op√ß√£o"); const img = JSON.parse(state.current.image_url)[0]; state.cart.push({name: state.current.name, variant: state.var.name, price: parseFloat(state.var.price), qty: state.qty, image: img}); app.renderCart(); app.closeModal('product-modal'); app.toggleCart(); showToast('Adicionado √† sacola!'); },
            renderCart: () => {
                const ul = document.getElementById('cart-list'); ul.innerHTML=""; let t=0;
                state.cart.forEach((i,idx) => { t += i.price*i.qty; ul.innerHTML += `<li class="cart-item"><img src="${i.image}" class="cart-thumb"><div><b>${i.name}</b><br><small>${i.variant}</small><div class="qty-controls"><button class="qty-btn" onclick="app.cQty(${idx},-1)">-</button><span class="qty-val">${i.qty}</span><button class="qty-btn" onclick="app.cQty(${idx},1)">+</button></div></div><div style="text-align:right">R$ ${(i.price*i.qty).toFixed(2)}<br><button class="btn-remove" onclick="state.cart.splice(${idx},1);app.renderCart()"><i class="fas fa-trash"></i></button></div></li>`; });
                document.getElementById('cart-total').innerText = `R$ ${t.toFixed(2)}`; document.getElementById('cart-count').innerText = state.cart.length;
            },
            cQty: (idx,n) => { state.cart[idx].qty+=n; if(state.cart[idx].qty<1) state.cart[idx].qty=1; app.renderCart(); },
            toggleCart: () => document.querySelector('.sidebar').classList.toggle('open'),
            fetchCep: async (cep, prefix='addr') => {
                cep = cep.replace(/\D/g, '');
                if(cep.length === 8) {
                    const res = await fetch(`https://viacep.com.br/ws/${cep}/json/`);
                    const data = await res.json();
                    if(!data.erro) {
                        const streetId = prefix === 'manual' ? 'm-client-street' : 'addr-street';
                        const bairroId = prefix === 'manual' ? 'm-client-bairro' : 'addr-bairro';
                        const cityId = prefix === 'manual' ? 'm-client-city' : 'addr-city';
                        const ufId = prefix === 'manual' ? 'm-client-uf' : 'addr-uf';
                        const numId = prefix === 'manual' ? 'm-client-num' : 'addr-num';
                        if(document.getElementById(streetId)) document.getElementById(streetId).value = data.logradouro;
                        if(document.getElementById(bairroId)) document.getElementById(bairroId).value = data.bairro;
                        if(document.getElementById(cityId)) document.getElementById(cityId).value = data.localidade;
                        if(document.getElementById(ufId)) document.getElementById(ufId).value = data.uf;
                        if(document.getElementById(numId)) document.getElementById(numId).focus();
                    }
                }
            },
            openAddressModal: () => {
                const list = JSON.parse(localStorage.getItem('2a_addrs') || '[]');
                const div = document.getElementById('saved-addresses-list'); div.innerHTML="";
                list.forEach((a,i) => { div.innerHTML += `<div style="border:1px solid #eee; padding:10px; margin-bottom:5px; border-radius:8px; display:flex; justify-content:space-between; align-items:center;"><div onclick="app.setAddr(${i})" style="cursor:pointer; flex:1;"><b>${a.type || 'Endere√ßo'}</b>: ${a.street}, ${a.number}<br><small>${a.name} (${a.phone})</small></div><div><i class="fas fa-edit" onclick="app.editAddress(${i})" style="color:blue; margin-right:10px; cursor:pointer;"></i><i class="fas fa-trash" onclick="app.delAddress(${i})" style="color:red; cursor:pointer;"></i></div></div>`; });
                app.showModal('address-modal');
            },
            addNewAddress: () => {
                const val = id => document.getElementById(id).value;
                const a = { name: val('addr-name'), phone: val('addr-phone'), cep: val('addr-cep'), street: val('addr-street'), number: val('addr-num'), bairro: val('addr-bairro'), city: val('addr-city'), uf: val('addr-uf'), ref: val('addr-ref'), type: document.getElementById('addr-type').value };
                if(!a.name || !a.street) return alert("Preencha campos obrigat√≥rios.");
                const list = JSON.parse(localStorage.getItem('2a_addrs') || '[]'); list.push(a); localStorage.setItem('2a_addrs', JSON.stringify(list));
                if(state.user) sb.from('customers').update({ address: list }).eq('id', state.user.id).then();
                state.address = a; localStorage.setItem('2a_active_addr', JSON.stringify(a));
                app.updateUI(); app.closeModal('address-modal'); showToast('Endere√ßo salvo!');
            },
            delAddress: (i) => { const list = JSON.parse(localStorage.getItem('2a_addrs')); list.splice(i, 1); localStorage.setItem('2a_addrs', JSON.stringify(list)); if(state.user) sb.from('customers').update({ address: list }).eq('id', state.user.id).then(); app.openAddressModal(); },
            editAddress: (i) => { const list = JSON.parse(localStorage.getItem('2a_addrs')); const a = list[i]; const setVal = (id, v) => document.getElementById(id).value = safeVal(v); setVal('addr-name', a.name); setVal('addr-phone', a.phone); setVal('addr-cep', a.cep); setVal('addr-street', a.street); setVal('addr-num', a.number); setVal('addr-bairro', a.bairro); setVal('addr-city', a.city); setVal('addr-uf', a.uf); setVal('addr-ref', a.ref); app.delAddress(i); },
            setAddr: (i) => { const list = JSON.parse(localStorage.getItem('2a_addrs')); state.address = list[i]; localStorage.setItem('2a_active_addr', JSON.stringify(state.address)); app.updateUI(); app.closeModal('address-modal'); },
            updateUI: () => { const btn = document.getElementById('btn-address-trigger'); if(btn && state.address) { btn.classList.add('filled'); btn.innerHTML = `üìç Entregar em: ${state.address.city}/${state.address.uf} (${state.address.street})`; } },
            checkout: async (method) => {
                if(!state.cart.length) return alert("Carrinho vazio");
                if(!state.user) { app.showModal('auth-modal'); return; }
                if(!state.address) { app.openAddressModal(); return; }
                const btn = document.querySelector(method === 'whatsapp' ? '.btn-whatsapp' : '.btn-mp');
                const btnOriginalText = btn.innerText;
                try {
                    btn.innerText = "Processando...";
                    const newOrderId = Date.now().toString();
                    const orderData = await app.registerOrder(newOrderId, method === 'whatsapp' ? 'WhatsApp/Dinheiro' : 'Mercado Pago', 'Pendente', method === 'mercadopago' ? 'Pago' : 'Pendente');
                    await app.updateStockDatabase();
                    await app.sendEmails(orderData, state.cart, state.user.email);
                    if(method === 'whatsapp') app.sendPaidOrder('Dinheiro/Combinar'); 
                    else {
                        localStorage.setItem('2a_cart', JSON.stringify(state.cart));
                        const items = state.cart.map(i => ({name: `${i.name} - ${i.variant}`, price: i.price, qty: i.qty}));
                        const res = await fetch(GOOGLE_CLOUD_URL, { method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({items, buyer: { email: state.user.email, name: state.user.name }, address: state.address}) });
                        const data = await res.json();
                        if(data.init_point) window.location.href = data.init_point;
                    }
                } catch(e) { console.error(e); btn.innerText = btnOriginalText; }
            },
            registerOrder: async (oid, method, status = 'Pendente', payStatus = 'Pendente') => {
                if(!sb) return;
                const total = state.cart.reduce((a,b)=>a+(b.price*b.qty),0);
                const order = { id: oid.toString(), customer_name: state.user.name, customer_email: state.user.email, customer_id: String(state.user.id), total: total, items: JSON.stringify(state.cart), address: JSON.stringify(state.address), date: new Date().toLocaleDateString() + ' ' + new Date().toLocaleTimeString(), method: method, status: status, payment_status: payStatus, created_at: new Date().toISOString() };
                const { data, error } = await sb.from('orders').insert([order]).select();
                return order; 
            },
            sendEmails: async (order, cartItems, recipientEmail) => {
                if(!recipientEmail) return;
                const itemsTxt = cartItems.map(i => `${i.qty}x ${i.name} (${i.variant}) - R$ ${i.price.toFixed(2)}`).join('\n');
                const total = cartItems.reduce((a,b)=>a+(b.price*b.qty),0).toFixed(2);
                let fullAddr = "N√£o informado";
                try { const addrObj = typeof order.address === 'string' ? JSON.parse(order.address) : order.address; fullAddr = `${addrObj.street}, ${addrObj.number} - ${addrObj.city}`; } catch(e) {}
                const templateParams = { to_name: order.customer_name, to_email: recipientEmail, message: `PEDIDO #${order.id}\n\nPAGAMENTO: ${order.method}\n\nITENS:\n${itemsTxt}\n\nTOTAL: R$ ${total}\n\nENDERE√áO:\n${fullAddr}\n\nStatus: ${order.status}`, admin_email: 'erickveraosilva@gmail.com' };
                if(window.emailjs) { emailjs.send(EMAILJS_SERVICE_ID, EMAILJS_TEMPLATE_CLIENTE, templateParams); emailjs.send(EMAILJS_SERVICE_ID, EMAILJS_TEMPLATE_ADMIN, {...templateParams, to_email: 'erickveraosilva@gmail.com'}); }
            },
            updateStockDatabase: async () => { if(!sb) return; for (const item of state.cart) { const { data: prod } = await sb.from('products').select('*').eq('name', item.name).single(); if(prod) { let vars = typeof prod.variations === 'string' ? JSON.parse(prod.variations) : prod.variations; const targetVar = vars.find(v => v.name === item.variant); if(targetVar) { targetVar.stock = Math.max(0, parseInt(targetVar.stock) - item.qty); await sb.from('products').update({ variations: JSON.stringify(vars) }).eq('id', prod.id); } } } },
            sendPaidOrder: (paymentType) => { let addr = state.address; const fullAddr = `${addr.street}, ${addr.number} - ${addr.bairro} (${addr.city})`; let msg = `*NOVO PEDIDO 2A MODAS (${state.user.name})*\n--------------------------------\n*PAGAMENTO:* ${paymentType}\n*TOTAL:* R$ ${document.getElementById('cart-total').innerText.replace('R$ ','')}\n--------------------------------\n*ENTREGA:*\nüìç ${fullAddr}\n--------------------------------\n*ITENS:*\n`; state.cart.forEach(i=>{ msg += `‚ñ™ ${i.qty}x ${i.name} (${i.variant})\n`; }); localStorage.removeItem('2a_cart'); state.cart = []; app.renderCart(); app.toggleCart(); window.location.href = `https://wa.me/5567998951120?text=${encodeURIComponent(msg)}`; },
            showModal: (id) => { document.getElementById(id).classList.add('active'); },
            closeModal: (id) => { document.getElementById(id).classList.remove('active'); if(id === 'product-modal') clearInterval(autoScrollInterval); },
            filter: (cat, btn) => { document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active')); btn.classList.add('active'); app.render(cat==='all' ? state.products : state.products.filter(p => p.category===cat)); }
        };

        const auth = {
            checkProfile: () => { if(state.user) { app.showModal('client-modal'); auth.loadClientOrders(); document.getElementById('client-info-txt').innerHTML = `<strong>${safeVal(state.user.name)}</strong><br>${safeVal(state.user.email)}`; } else app.showModal('auth-modal'); },
            toggle: (m) => { document.getElementById('form-login').style.display=m==='login'?'block':'none'; document.getElementById('form-register').style.display=m==='register'?'block':'none'; },
            login: async () => { const e = document.getElementById('l-email').value, p = document.getElementById('l-pass').value; if(sb) { const {data} = await sb.from('customers').select('*').eq('email',e).eq('password',p).single(); if(data) { state.user=data; localStorage.setItem('2a_user', JSON.stringify(data)); if(data.address && Array.isArray(data.address)) localStorage.setItem('2a_addrs', JSON.stringify(data.address)); app.updateUI(); app.closeModal('auth-modal'); } else alert("Inv√°lido"); } },
            register: async () => { const n=document.getElementById('r-name').value, e=document.getElementById('r-email').value, p=document.getElementById('r-pass').value; if(sb) await sb.from('customers').insert([{id: Date.now(), name:n, email:e, password:p, address: []}]); showToast("Sucesso!"); auth.toggle('login'); },
            logout: () => { localStorage.removeItem('2a_user'); location.reload(); },
            loadClientOrders: async () => {
                if(!state.user || !state.user.email) return;
                let query = sb.from('orders').select('*').eq('customer_email', state.user.email).neq('status', 'Archived_Backup').order('created_at', {ascending: false});
                const { data } = await query;
                const div = document.getElementById('client-orders-list'); div.innerHTML = "";
                data.forEach(o => {
                    let pct = 0; if(o.status.includes('Pendente')) pct = 10; if(o.status.includes('Enviado')) pct = 50; if(o.status.includes('Entregue')) pct = 100;
                    const items = JSON.parse(o.items);
                    const itemsHtml = items.map(i => `<div class="order-prod-row"><img src="${i.image || 'https://via.placeholder.com/50'}" onerror="this.src='https://via.placeholder.com/50'"><div class="order-prod-info"><div class="order-prod-name">${i.name}</div><div class="order-prod-var">${i.variant}</div></div><div class="order-prod-qty">x${i.qty}</div></div>`).join('');
                    const cClass = o.status === 'Cancelado' ? 'cancelled' : '';
                    if(o.status === 'Cancelado') pct = 100;
                    div.innerHTML += `
                    <div class="client-order">
                        <div style="display:flex; justify-content:space-between; margin-bottom:10px; border-bottom:1px dashed #eee; padding-bottom:5px;"><strong>Pedido #${o.id.slice(-6)}</strong><span style="color:var(--success); font-weight:bold;">R$ ${o.total.toFixed(2)}</span></div>
                        <div style="background:#f9f9f9; padding:15px; border-radius:12px; margin-bottom:15px;">${itemsHtml}</div>
                        <div class="track-container"><div class="track-line-bg"></div><div class="track-fill ${cClass}" style="width:${pct}%"></div><div class="truck-icon-3d ${cClass}" style="left:${pct}%"><i class="fas fa-truck"></i></div><div class="track-steps"><div class="track-step"><span>Pendente</span></div><div class="track-step"><span>Enviado</span></div><div class="track-step"><span>Entregue</span></div></div></div>
                        <div style="text-align:center; font-size:0.8rem; color:#999; margin-top:10px;">${o.date}</div>
                    </div>`;
                });
            }
        };

        const admin = {
            showLogin: () => { app.showModal('admin-auth-modal'); },
            verifyLogin: () => { if(document.getElementById('admin-pass').value === "123") { app.closeModal('admin-auth-modal'); setTimeout(() => { app.showModal('admin-modal'); admin.renderOrders(); admin.renderFinance(); admin.renderList(); }, 100); } else alert("Senha incorreta"); },
            initCheckboxes: () => { const cDiv = document.getElementById('color-checks'), vDiv = document.getElementById('volume-checks'); Object.keys(COLOR_MAP).forEach(c => { cDiv.innerHTML += `<label><input type="checkbox" class="hidden-check" value="${c}" onchange="admin.toggleInput(this)"><span class="color-option-label" style="background:${COLOR_MAP[c]}" title="${c}"></span></label>`; }); PRESETS_VOL.forEach(v => { vDiv.innerHTML += `<label><input type="checkbox" class="hidden-check" value="${v}" onchange="admin.toggleInput(this)"><span class="vol-option-label">${v}</span></label>`; }); },
            toggleInput: (cb) => { const id = `grp-${cb.value.replace(/[^a-z0-9]/gi,'')}`; const area = document.getElementById('active-vars-area'); if(cb.checked) area.innerHTML += `<div id="${id}" class="var-inputs show"><strong style="grid-column:span 2">${cb.value}</strong><input type="hidden" class="v-name" value="${cb.value}"><input type="number" class="input v-cost" placeholder="Custo"><input type="number" class="input v-price" placeholder="Venda"><input type="number" class="input v-stock" placeholder="Estoque" style="grid-column:span 2"></div>`; else document.getElementById(id)?.remove(); },
            tab: (t) => { document.querySelectorAll('.admin-tab').forEach(b => b.classList.remove('active')); document.querySelector(`.admin-tab[onclick*='${t}']`)?.classList.add('active'); ['dash','prod','orders','customers','backup','fin','pay', 'new-order'].forEach(i => { document.getElementById(`tab-${i}`).style.display = i===t ? 'block' : 'none'; }); if(t === 'new-order') { admin.populateManualProdSelect(); admin.manualCart = []; admin.renderManualCart(); } if(t === 'customers') admin.renderCustomers(); if(t === 'backup') admin.renderBackup(); },
            
            // --- LOGICA DE RESET E BACKUP ---
            resetData: async () => {
                if(confirm("Deseja limpar os pedidos da tela? Eles ser√£o arquivados na aba 'Lixeira/Backups'.")) {
                    if(sb) {
                        const { error } = await sb.from('orders').update({status: 'Archived_Backup'}).neq('status', 'Archived_Backup');
                        if(!error) { showToast("Pedidos arquivados com sucesso."); admin.renderOrders(); admin.renderFinance(); }
                        else alert("Erro: " + error.message);
                    }
                }
            },
            renderBackup: async () => {
                const { data } = await sb.from('orders').select('*').eq('status', 'Archived_Backup').order('created_at', {ascending: false});
                const div = document.getElementById('backup-list'); div.innerHTML = "";
                if(!data || data.length === 0) { div.innerHTML = "<p>Nenhum backup encontrado.</p>"; return; }
                data.forEach(o => {
                    div.innerHTML += `<div style="border:1px solid #e74c3c; padding:10px; margin-bottom:10px; background:#fff; border-radius:8px; display:flex; justify-content:space-between;"><div><strong>#${o.id.slice(-6)}</strong> - ${o.customer_name}<br>Total: R$ ${o.total.toFixed(2)}</div><button onclick="admin.restoreOrder('${o.id}')" class="btn-modern small outline">Restaurar</button></div>`;
                });
            },
            restoreOrder: async (id) => {
                await sb.from('orders').update({status: 'Pendente'}).eq('id', id);
                showToast("Pedido restaurado!"); admin.renderBackup(); admin.renderOrders();
            },

            // --- NOVA ABA: CLIENTES ---
            renderCustomers: async () => {
                const { data } = await sb.from('orders').select('*').neq('status', 'Archived_Backup').order('customer_name');
                const div = document.getElementById('customers-list-container'); div.innerHTML = "";
                if(!data.length) { div.innerHTML = "Sem dados."; return; }
                
                let html = `<table class="cust-table"><thead><tr><th>Cliente</th><th>Pago</th><th>Restante</th><th>Parcelas</th><th>A√ß√£o</th></tr></thead><tbody>`;
                data.forEach(o => {
                    let paid = 0, remaining = o.total;
                    let pendingInst = 0;
                    if(o.payment_status === 'Pago') { paid = o.total; remaining = 0; }
                    else if(o.installments) {
                        const inst = JSON.parse(o.installments);
                        inst.forEach(i => { if(i.paid) paid += parseFloat(i.amount); else pendingInst++; });
                        remaining = o.total - paid;
                    } else if(o.payment_status === 'Pendente') { pendingInst = 1; } // Considera 1 pendencia
                    
                    const badge = remaining < 0.1 ? '<span class="cust-badge ok">Quitado</span>' : '<span class="cust-badge warn">Pendente</span>';
                    html += `<tr><td>${o.customer_name}</td><td style="color:var(--success)">R$ ${paid.toFixed(2)}</td><td style="color:var(--danger)">R$ ${remaining.toFixed(2)}</td><td>${remaining > 0.1 ? pendingInst + 'x' : '-'}</td><td><button onclick="alert('Detalhes do pedido #${o.id}')" class="btn-modern small outline">Ver</button></td></tr>`;
                });
                html += `</tbody></table>`;
                div.innerHTML = html;
            },

            // ... (Fun√ß√µes existentes mantidas: handleFileSelect, setMain, save, edit, del, clear, renderList, filterOrders, renderOrders...)
            handleFileSelect: (input) => { const files = Array.from(input.files); state.selectedFiles = files; state.mainImageIndex = 0; const area = document.getElementById('file-preview-area'); area.innerHTML = ""; files.forEach((f, idx) => { const url = URL.createObjectURL(f); area.innerHTML += `<div class="preview-wrapper" onclick="admin.setMain(${idx})"><img src="${url}" class="file-preview-item ${idx===0?'main-selected':''}" id="prev-${idx}"><div class="main-tag">PRINCIPAL</div></div>`; }); },
            setMain: (idx) => { state.mainImageIndex = idx; document.querySelectorAll('.file-preview-item').forEach(el => el.classList.remove('main-selected')); document.getElementById(`prev-${idx}`).classList.add('main-selected'); },
            save: async () => { 
                const btn = document.getElementById('btn-save'); btn.innerText="Salvando..."; btn.disabled=true;
                try {
                    const vars = []; document.querySelectorAll('.var-inputs').forEach(d => { const p=d.querySelector('.v-price').value, s=d.querySelector('.v-stock').value; if(p && s) vars.push({ name: d.querySelector('.v-name').value, cost: d.querySelector('.v-cost').value||0, price: p, stock: s }); });
                    if(!vars.length) { const gp=document.getElementById('f-price-global').value, gs=document.getElementById('f-stock-global').value; if(!gp) throw new Error("Preencha dados"); vars.push({name:'Padr√£o', price:gp, stock:gs, cost:0}); }
                    let mediaUrls=[]; const editId=document.getElementById('edit-id').value;
                    if(editId && state.selectedFiles.length===0) { const oldP=state.products.find(x=>String(x.id)===String(editId)); if(oldP) try{mediaUrls=JSON.parse(oldP.image_url)}catch(e){mediaUrls=[oldP.image_url]} } 
                    else if(state.selectedFiles.length>0) { 
                        if(state.mainImageIndex > 0) { const m = state.selectedFiles.splice(state.mainImageIndex,1)[0]; state.selectedFiles.unshift(m); }
                        for(let i=0;i<state.selectedFiles.length;i++){ const f=state.selectedFiles[i], name='prod_'+Date.now()+'_'+i; await sb.storage.from('images').upload(name,f); const {data}=sb.storage.from('images').getPublicUrl(name); mediaUrls.push(data.publicUrl); } 
                    }
                    const payload = { name: document.getElementById('f-name').value, category: document.getElementById('f-cat').value, cost_price: document.getElementById('f-cost').value||0, description: document.getElementById('f-desc').value, is_promo: document.getElementById('f-promo').checked, variations: JSON.stringify(vars) };
                    if(mediaUrls.length) payload.image_url = JSON.stringify(mediaUrls); else if(!editId) payload.image_url = JSON.stringify(["https://via.placeholder.com/300"]);
                    if(editId) await sb.from('products').update(payload).eq('id', editId); else { payload.id=Date.now(); await sb.from('products').insert([payload]); }
                    showToast("Produto salvo!"); admin.clear(); await app.load(); admin.renderList();
                } catch(e){alert(e.message)} finally{btn.innerText="Salvar"; btn.disabled=false;} 
            },
            edit: (id) => { const p = state.products.find(x => String(x.id) === String(id)); document.getElementById('edit-id').value = p.id; document.getElementById('f-name').value = safeVal(p.name); document.getElementById('f-desc').value = safeVal(p.description); document.getElementById('f-cost').value = safeVal(p.cost_price); document.getElementById('f-promo').checked = p.is_promo; admin.clear(true); document.getElementById('edit-id').value = p.id; const vars = JSON.parse(p.variations); vars.forEach(v => { if(v.name==='Padr√£o'){document.getElementById('f-price-global').value=v.price;document.getElementById('f-stock-global').value=v.stock;} else { document.querySelectorAll('.hidden-check').forEach(cb => { if(cb.value===v.name){cb.checked=true; admin.toggleInput(cb); setTimeout(()=>{const d=document.getElementById(`grp-${cb.value.replace(/[^a-z0-9]/gi,'')}`); if(d){d.querySelector('.v-price').value=v.price; d.querySelector('.v-stock').value=v.stock;}},50)} }); } }); admin.tab('prod'); },
            del: async (id) => { if(confirm("Excluir?")) { await sb.from('products').delete().eq('id', id); await app.load(); admin.renderList(); showToast("Exclu√≠do!"); } },
            clear: (soft=false) => { if(!soft) document.getElementById('edit-id').value=""; ['f-name','f-desc','f-cost','f-file','f-price-global','f-stock-global'].forEach(i=>{ const el = document.getElementById(i); if(el) el.value=""; }); state.selectedFiles = []; state.mainImageIndex = 0; document.getElementById('file-preview-area').innerHTML = ""; document.getElementById('active-vars-area').innerHTML=""; document.querySelectorAll('.hidden-check').forEach(c => c.checked=false); },
            renderList: () => {
                const div = document.getElementById('admin-list'); div.innerHTML=""; state.products.forEach(p => { const vars = JSON.parse(p.variations); let stock = 0; vars.forEach(v => stock += parseInt(v.stock||0)); let mainImg = JSON.parse(p.image_url)[0]; div.innerHTML += `<div class="mini-prod ${stock===0?'sold-out':''}"><img src="${mainImg}" onerror="this.src='https://via.placeholder.com/50'"> <div style="flex:1"><strong>${p.name}</strong><br>Estoque: ${stock}</div><div><button onclick="admin.edit('${p.id}'); admin.tab('prod')" class="btn-chip-edit"><i class="fas fa-pen"></i> Editar</button> <button onclick="admin.del('${p.id}')" style="color:red;border:none;background:none; margin-left:10px;"><i class="fas fa-trash"></i></button></div></div>`; });
            },
            
            // --- PEDIDO MANUAL E FINANCEIRO ---
            populateManualProdSelect: () => { const sel = document.getElementById('m-prod-select'); sel.innerHTML = '<option value="">Selecione...</option>'; state.products.forEach(p => { const vars = JSON.parse(p.variations); vars.forEach(v => { sel.innerHTML += `<option value="${p.id}|${v.name}|${v.price}|${p.name}">${p.name} - ${v.name} (R$ ${v.price})</option>`; }); }); },
            manualCart: [],
            addManualItem: () => { const val = document.getElementById('m-prod-select').value; const qty = parseInt(document.getElementById('m-prod-qty').value); if(!val) return; const [pid, vname, price, pname] = val.split('|'); admin.manualCart.push({ name: pname, variant: vname, price: parseFloat(price), qty: qty, image: "https://via.placeholder.com/50", is_stock: true, pid }); admin.renderManualCart(); },
            addCustomItem: () => { admin.manualCart.push({ name: document.getElementById('m-custom-item').value, variant: 'Avulso', price: parseFloat(document.getElementById('m-custom-price').value), qty: 1, is_stock: false }); admin.renderManualCart(); },
            renderManualCart: () => { const div = document.getElementById('manual-cart-list'); div.innerHTML = ""; let t = 0; admin.manualCart.forEach((i, idx) => { t += i.price * i.qty; div.innerHTML += `<div class="manual-cart-item"><span>${i.name} (${i.variant}) x${i.qty}</span> <span>R$ ${(i.price*i.qty).toFixed(2)} <i class="fas fa-trash" onclick="admin.manualCart.splice(${idx},1);admin.renderManualCart()"></i></span></div>`; }); document.getElementById('m-total-display').innerText = `R$ ${t.toFixed(2)}`; },
            saveManualOrder: async () => {
                if(!admin.manualCart.length) return alert("Vazio");
                const email = document.getElementById('m-client-email').value;
                const order = { id: Date.now().toString(), customer_name: document.getElementById('m-client-name').value || "Balc√£o", customer_email: email, total: admin.manualCart.reduce((a,b)=>a+(b.price*b.qty),0), items: JSON.stringify(admin.manualCart), address: JSON.stringify({ street: document.getElementById('m-client-street').value, number: document.getElementById('m-client-num').value, bairro: document.getElementById('m-client-bairro').value, city: document.getElementById('m-client-city').value }), date: new Date().toLocaleDateString(), method: 'Manual', status: document.getElementById('m-payment-status').value==='Pago'?'Entregue':'Pendente', payment_status: document.getElementById('m-payment-status').value, created_at: new Date().toISOString() };
                await sb.from('orders').insert([order]);
                for(const i of admin.manualCart) { if(i.is_stock) { const {data:p} = await sb.from('products').select('*').eq('id', i.pid).single(); if(p) { const vars = JSON.parse(p.variations); const v = vars.find(x => x.name === i.variant); if(v) v.stock -= i.qty; await sb.from('products').update({variations: JSON.stringify(vars)}).eq('id', p.id); } } }
                if(email) app.sendEmails(order, admin.manualCart, email);
                showToast("Pedido Salvo!"); admin.manualCart = []; admin.renderManualCart(); admin.tab('orders'); admin.renderOrders();
            },
            
            // --- RENDER ORDERS E A√á√ïES ---
            renderOrders: async () => {
                const { data } = await sb.from('orders').select('*').neq('status', 'Archived_Backup').order('created_at', {ascending: false});
                state.adminOrders = data || [];
                const div = document.getElementById('orders-list'); div.innerHTML = "";
                let filtered = state.adminOrders;
                if(state.filterStatus !== 'all') filtered = filtered.filter(o => o.status.includes(state.filterStatus));
                
                filtered.forEach(o => {
                    const iList = JSON.parse(o.items);
                    const itemsHtml = iList.map(i => `<div class="order-prod-row"><img src="${i.image||'https://via.placeholder.com/50'}" onerror="this.src='https://via.placeholder.com/50'"><div class="order-prod-info"><div class="order-prod-name">${i.name}</div><div class="order-prod-var">${i.variant}</div></div><div class="order-prod-qty">x${i.qty}</div></div>`).join('');
                    const addr = JSON.parse(o.address || '{}');
                    const fullAddrString = `${addr.street || ''}, ${addr.number || ''} - ${addr.bairro || ''}, ${addr.city || ''}`;
                    const mapLink = `https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(fullAddrString)}`;
                    
                    const payStatus = o.payment_status || 'Pendente';
                    const btnPartial = (payStatus === 'Pendente' || payStatus === 'A_pagar') 
                        ? `<button onclick="admin.registerPartialOnPending('${o.id}', ${o.total})" class="btn-modern small outline" style="margin-top:5px; width:100%; border-color:#f39c12; color:#e67e22;"><i class="fas fa-coins"></i> Registrar Entrada/Sinal</button>` 
                        : '';

                    div.innerHTML += `
                    <div class="order-card-modern">
                        <div class="oc-header"><span class="oc-id">Pedido #${o.id.slice(-6)}</span><span class="oc-date">${o.date}</span></div>
                        <div class="oc-body">
                            <div class="oc-section"><label>Cliente</label><div class="oc-val">${o.customer_name}</div></div>
                            <div class="oc-section" style="grid-column:span 2"><label>Entrega</label><div style="font-size:0.9rem;">${fullAddrString}</div><a href="${mapLink}" target="_blank" class="btn-map">Ver Mapa</a></div>
                            <div class="oc-section"><label>Total</label><div class="oc-val" style="color:var(--success)">R$ ${o.total.toFixed(2)}</div></div>
                            <div class="oc-section"><label>Status</label><select onchange="admin.updateStatus('${o.id}', this.value)" class="status-selector"><option value="Pendente">Pendente</option><option value="Enviado">Enviado</option><option value="Entregue">Entregue</option><option value="Cancelado">Cancelado</option></select></div>
                            <div class="payment-box">
                                <label>Financeiro:</label>
                                <select onchange="admin.togglePaymentDetails(this, '${o.id}')" class="input"><option value="A_pagar">√Ä Pagar</option><option value="Pago">Pago</option><option value="Parcelado">Parcelado</option></select>
                                ${btnPartial}
                                <div id="pay-det-${o.id}" class="gen-installments-area" style="display:${payStatus==='Parcelado'?'block':'none'}"><input type="number" id="inst-n-${o.id}" class="input qty-installments-input" placeholder="Qtd"><button onclick="admin.genInstallments('${o.id}', ${o.total})" class="btn-modern outline small">Gerar</button><div id="inst-list-${o.id}"></div></div>
                                <button onclick="admin.updatePaymentStatus('${o.id}')" class="btn-modern success small" style="width:100%; margin-top:5px;">Salvar Fin.</button>
                            </div>
                            <div class="oc-items-box">${itemsHtml}</div>
                        </div>
                    </div>`;
                    if(payStatus === 'Parcelado' && o.installments) { admin.renderInstInputs(o.id, JSON.parse(o.installments)); }
                });
            },
            registerPartialOnPending: async (id, total) => {
                const modalHtml = `
                    <div id="partial-modal" class="overlay active" style="z-index:99999;">
                        <div class="box single-col" style="max-width:350px; padding:30px; text-align:center;">
                            <h3>Registrar Entrada</h3>
                            <p>Valor total do pedido: <strong>R$ ${total.toFixed(2)}</strong></p>
                            <input type="number" id="partial-val-input" class="modern-input-large" placeholder="R$ 0,00" style="margin:20px 0;">
                            
                            <button onclick="admin.confirmPartialLogic('${id}', ${total})" class="btn-modern success" style="width:100%;">Confirmar Entrada</button>
                            <button onclick="document.getElementById('partial-modal').remove()" class="btn-nav-action btn-nav-close" style="margin-top:10px;">Cancelar</button>
                        </div>
                    </div>`;
                document.body.insertAdjacentHTML('beforeend', modalHtml);
            },
            confirmPartialLogic: async (id, total) => {
                const val = parseFloat(document.getElementById('partial-val-input').value);
                if(!val || val <= 0 || val >= total) return alert("Valor inv√°lido.");
                const today = new Date().toISOString().split('T')[0];
                const nextMonth = new Date(); nextMonth.setDate(nextMonth.getDate() + 30);
                const installments = [{ date: today, amount: val.toFixed(2), paid: true }, { date: nextMonth.toISOString().split('T')[0], amount: (total - val).toFixed(2), paid: false }];
                await sb.from('orders').update({ payment_status: 'Parcelado', installments: JSON.stringify(installments) }).eq('id', id);
                document.getElementById('partial-modal').remove(); showToast("Entrada registrada!"); admin.renderOrders();
            },
            updateStatus: async (id, val) => { await sb.from('orders').update({status: val}).eq('id', id); showToast("Status atualizado!"); admin.renderOrders(); },
            updatePaymentStatus: async (id) => { 
                const div = document.getElementById(`pay-det-${id}`); const row = div.parentElement; const status = row.querySelector('select').value;
                let instJson = null; 
                if(status==='Parcelado'){ const rows=document.getElementById(`inst-list-${id}`).querySelectorAll('.inst-gen-row'); const arr=[]; rows.forEach(r=>{arr.push({date:r.querySelector('.i-date').value, amount:r.querySelector('.i-amount').value, paid:r.querySelector('.i-check').checked})}); instJson=JSON.stringify(arr); }
                await sb.from('orders').update({payment_status:status, installments:instJson}).eq('id',id); showToast("Financeiro salvo!"); admin.renderOrders();
            },
            genInstallments: (id, total) => { const n=parseInt(document.getElementById(`inst-n-${id}`).value); const arr=[]; const val=(total/n).toFixed(2); for(let i=0;i<n;i++){ const d=new Date(); d.setDate(d.getDate()+(30*(i+1))); arr.push({date:d.toISOString().split('T')[0], amount:val, paid:false}); } admin.renderInstInputs(id, arr); },
            renderInstInputs: (id, arr) => { const b=document.getElementById(`inst-list-${id}`); b.innerHTML=""; arr.forEach((i,x)=>{ b.innerHTML+=`<div class="inst-gen-row"><span>${x+1}x</span><input type="date" value="${i.date}" class="i-date"><input type="number" value="${i.amount}" class="i-amount"><input type="checkbox" class="i-check" ${i.paid?'checked':''}></div>`; }); },
            togglePaymentDetails: (sel, id) => { document.getElementById(`pay-det-${id}`).style.display = (sel.value==='Parcelado')?'block':'none'; },
            filterOrders: (s, b) => { state.filterStatus=s; document.querySelectorAll('#order-filters .chip').forEach(c=>c.classList.remove('active')); b.classList.add('active'); admin.renderOrders(); },
            
            // FINANCEIRO REAL
            renderFinance: async () => {
                const s = document.getElementById('fin-start').value, e = document.getElementById('fin-end').value; if(!s || !e) return;
                const start = new Date(s+'T00:00:00'), end = new Date(e+'T23:59:59');
                const {data} = await sb.from('orders').select('*').neq('status', 'Archived_Backup').neq('status','Cancelado');
                let real=0, created=0;
                data.forEach(o => {
                    const d = new Date(o.created_at);
                    if(d>=start && d<=end) created+=o.total;
                    if(o.payment_status==='Pago' && d>=start && d<=end) real+=o.total;
                    else if(o.installments) { JSON.parse(o.installments).forEach(i=>{ if(i.paid){ const pd=new Date(i.date+'T12:00:00'); if(pd>=start && pd<=end) real+=parseFloat(i.amount); } }); }
                });
                document.getElementById('fin-real-revenue').innerText = `R$ ${real.toFixed(2)}`; document.getElementById('fin-total-created').innerText = `R$ ${created.toFixed(2)}`;
            },
            filterPayments: (s,b) => { state.filterPay=s; document.querySelectorAll('#pay-filters .chip').forEach(c=>c.classList.remove('active')); b.classList.add('active'); admin.renderPayments(); },
            renderPayments: async () => { /* Mesma l√≥gica do renderOrders mas filtrando por pagamento */ } 
        };

        (async function init() {
            if(window.emailjs) emailjs.init(EMAILJS_PUBLIC_KEY);
            const u = localStorage.getItem('2a_user'); if(u) state.user=JSON.parse(u);
            const a = localStorage.getItem('2a_active_addr'); if(a) state.address=JSON.parse(a);
            const urlParams = new URLSearchParams(window.location.search);
            if (urlParams.get('status') === 'approved' && localStorage.getItem('2a_cart')) {
                state.cart = JSON.parse(localStorage.getItem('2a_cart'));
                const order = await app.registerOrder(Date.now().toString(), 'Mercado Pago', 'Pendente (Pago)', 'Pago');
                await app.updateStockDatabase(); await app.sendEmails(order, state.cart, state.user.email);
                localStorage.removeItem('2a_cart'); window.history.replaceState({}, document.title, window.location.pathname);
                alert("Pagamento Confirmado!");
            }
            await app.load(); admin.initCheckboxes(); app.updateUI();
            document.getElementById('loading-screen').style.display='none';
        })();
    </script>
</body>
</html>
