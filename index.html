const mercadopago = require('mercadopago');
const cors = require('cors');

// Configuração do CORS para permitir que seu site acesse essa função
const corsHandler = cors({ origin: true });

// CONFIGURE AQUI SEU ACCESS TOKEN DO MERCADO PAGO
const client = new mercadopago.MercadoPagoConfig({ accessToken: 'SEU_ACCESS_TOKEN_DO_MERCADO_PAGO_AQUI' });

exports.createPreference = (req, res) => {
  corsHandler(req, res, async () => {
    
    // Verifica se é um método POST
    if (req.method !== 'POST') {
      return res.status(405).send('Method Not Allowed');
    }

    try {
      const { items } = req.body;

      // Formata os itens para o padrão do Mercado Pago
      const mpItems = items.map(item => ({
        title: `${item.name} (${item.color})`,
        unit_price: Number(item.price),
        quantity: Number(item.qty),
        currency_id: 'BRL'
      }));

      const preference = new mercadopago.Preference(client);

      const response = await preference.create({
        body: {
          items: mpItems,
          back_urls: {
            // Coloque o link do seu site GitHub aqui para retorno
            success: "https://SEU-USUARIO.github.io/2a-modas/sucesso",
            failure: "https://SEU-USUARIO.github.io/2a-modas/erro",
            pending: "https://SEU-USUARIO.github.io/2a-modas/pendente"
          },
          auto_return: "approved"
        }
      });

      // Retorna o link de pagamento (init_point) para o site
      res.status(200).json({ init_point: response.init_point });

    } catch (error) {
      console.error(error);
      res.status(500).json({ error: 'Erro ao criar preferência de pagamento' });
    }
  });
};