<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>2A Modas e Perfumes | Sistema Integrado</title>
    
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.9.2/dist/confetti.browser.min.js"></script>
    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/@emailjs/browser@3/dist/email.min.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
    <script src="https://npmcdn.com/flatpickr/dist/l10n/pt.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;600;700;800&family=Playfair+Display:wght@700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        :root {
            --primary: #c48b78; --primary-dark: #a06b5a;
            --accent: #2c3e50; --accent-light: #34495e;
            --bg: #f8f9fa; --white: #ffffff;
            --success: #27ae60; --warning: #f39c12; --danger: #e74c3c; --info: #3498db;
            --whatsapp: #25D366; --mp: #009EE3;
            --radius: 16px; --btn-radius: 30px; --shadow: 0 10px 30px rgba(0,0,0,0.06);
        }
        * { margin:0; padding:0; box-sizing:border-box; outline:none; font-family:'Plus Jakarta Sans', sans-serif; }
        body { background: var(--bg); color: var(--accent); overflow-x: hidden; display: flex; flex-direction: column; min-height: 100vh; }

        h1, .brand-font { font-family:'Plus Jakarta Sans', sans-serif; font-weight: 800; letter-spacing: -0.5px; }
        h2, h3 { font-family:'Plus Jakarta Sans', sans-serif; font-weight: 700; }
        button { cursor:pointer; transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1); border-radius: var(--btn-radius); }

        /* GLOBAL CUSTOM DIALOG (ALERT/CONFIRM) */
        #custom-dialog {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6);
            backdrop-filter: blur(5px); z-index: 999999; display: none; align-items: center; justify-content: center;
        }
        #custom-dialog.active { display: flex; animation: fadeIn 0.3s; }
        .cd-box {
            background: white; width: 90%; max-width: 400px; padding: 30px; border-radius: 20px;
            box-shadow: 0 20px 50px rgba(0,0,0,0.3); text-align: center; transform: scale(0.9); transition: 0.3s;
        }
        #custom-dialog.active .cd-box { transform: scale(1); }
        .cd-icon { font-size: 3rem; margin-bottom: 15px; color: var(--primary); }
        .cd-title { font-size: 1.5rem; font-weight: 800; margin-bottom: 10px; color: var(--accent); }
        .cd-msg { color: #666; margin-bottom: 25px; line-height: 1.5; }
        .cd-actions { display: flex; gap: 10px; justify-content: center; }
        .cd-input { width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 10px; margin-bottom: 20px; font-size: 1rem; display: none; }

        /* LOADING & STATUS */
        #loading-screen { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: white; z-index: 9999; display: flex; flex-direction: column; align-items: center; justify-content: center; transition: opacity 0.5s; }
        #status-bar { position:fixed; top:0; left:0; width:100%; height:auto; min-height:30px; background:#222; color:white; font-size:0.8rem; display:none; align-items:center; justify-content:center; z-index:99999; font-weight:600; padding:5px; text-align:center; }
        .ok { background:var(--success) !important; } .err { background:var(--danger) !important; }

        /* HEADER */
        .header-floating { position: fixed; top: 30px; right: 5%; z-index: 1000; display:flex; gap:10px; align-items: center; }
        .icon-btn { width:50px; height:50px; border-radius:50%; border:none; background:white; box-shadow:0 4px 15px rgba(0,0,0,0.15); color:var(--accent); font-size:1.2rem; display:flex; align-items:center; justify-content:center; position:relative; }
        .icon-btn:hover { background:var(--primary); color:white; transform:scale(1.1); }
        .badge { position:absolute; top:-5px; right:-5px; background:var(--accent); color:white; width:22px; height:22px; border-radius:50%; font-size:0.75rem; display:flex; align-items:center; justify-content:center; font-weight:bold; border:2px solid white; }
        .login-btn-header { padding: 10px 25px; background: white; border: none; border-radius: 30px; font-weight: 700; color: var(--accent); box-shadow: 0 4px 15px rgba(0,0,0,0.15); display: flex; align-items: center; gap: 8px; font-size: 0.85rem; }
        .login-btn-header:hover { background: var(--primary); color: white; transform: translateY(-2px); }

        /* HERO */
        .hero { padding: 100px 20px 80px; text-align:center; background: radial-gradient(circle at top, #fff5f2 0%, transparent 100%); display: flex; flex-direction: column; align-items: center; }
        .hero img { width:180px; height:180px; border-radius:50%; object-fit:cover; border:5px solid white; box-shadow:var(--shadow); margin-bottom:20px; }
        .hero h1 { font-size:3.5rem; margin-bottom:10px; color:var(--accent); }

        .btn-cta { 
            padding: 16px 50px; border-radius: 50px; border: none; font-weight: 700; font-size: 1.1rem; margin-top: 45px; color: white;
            background: linear-gradient(45deg, var(--accent), var(--primary), var(--accent));
            background-size: 200% 200%;
            animation: gradientMove 3s ease infinite;
            box-shadow: 0 10px 25px rgba(44,62,80,0.25);
        }
        .btn-cta:hover { transform: translateY(-5px); box-shadow: 0 15px 30px rgba(196, 139, 120, 0.4); }
        @keyframes gradientMove { 0% { background-position: 0% 50%; } 50% { background-position: 100% 50%; } 100% { background-position: 0% 50%; } }

        /* CONTAINER & CARDS */
        .container { max-width:1200px; margin:0 auto; padding:40px 20px; flex: 1; }
        .filters { display:flex; justify-content:center; gap:12px; margin-bottom:50px; flex-wrap:wrap; }
        .filter-btn { padding: 10px 28px; border-radius: 30px; border: 1px solid #e0e0e0; background: white; color: #555; font-weight: 600; }
        .filter-btn:hover { background: var(--primary); color: white; border-color: var(--primary); transform: translateY(-3px); }
        .filter-btn.active { background: var(--accent); color: white; border-color: var(--accent); transform: scale(1.05); }

        .grid { display:grid; grid-template-columns:repeat(auto-fill, minmax(170px, 1fr)); gap:25px; }
        .card { 
            background:white; border-radius:20px; overflow:hidden; border:none; 
            transition:0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275); position:relative; cursor:pointer; 
            box-shadow: 0 10px 20px rgba(0,0,0,0.05);
        }
        .card:hover { transform:translateY(-8px); box-shadow: 0 15px 35px rgba(196, 139, 120, 0.2); }
        .card img, .card video { width:100%; height:260px; object-fit:cover; background:#f9f9f9; }
        .card-info { padding:18px; text-align:left; }
        .tag-promo { position:absolute; top:12px; right:12px; background:linear-gradient(45deg, #e91e63, #ff6b6b); color:white; padding:5px 12px; border-radius:20px; font-size:0.65rem; font-weight:800; z-index: 2; box-shadow: 0 4px 10px rgba(233, 30, 99, 0.3); }
        .tag-delivery { font-size: 0.7rem; color: #27ae60; display: flex; align-items:center; gap:5px; margin-top: 8px; font-weight: 600; background: #e8f5e9; padding: 4px 10px; border-radius: 8px; width: fit-content; }

        /* MODALS GENERAL */
        .overlay { position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.85); backdrop-filter:blur(8px); z-index:2000; display:none; align-items:center; justify-content:center; padding:20px; }
        .overlay.active { display:flex; animation: popIn 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
        @keyframes popIn { from{transform:scale(0.9); opacity:0;} to{transform:scale(1); opacity:1;} }
        .box { background:white; width:100%; max-width:1000px; border-radius:24px; overflow:hidden; max-height:90vh; overflow-y:auto; box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5); }
        .box.single-col { display:block; max-width:500px; }

        /* PRODUCT MODAL */
        .product-modal-grid { display: grid; grid-template-columns: 1.2fr 1fr; gap: 30px; height: 100%; }
        .pm-images { position: relative; background: #f0f2f5; border-radius: 24px; overflow: hidden; display: flex; align-items: center; justify-content: center; }
        .pm-details { padding: 10px 20px; display: flex; flex-direction: column; overflow-y: auto; }
        .pm-price-tag { font-size: 2.2rem; font-weight: 800; color: var(--accent); margin: 15px 0; letter-spacing: -1px; }
        .carousel-main-container { width: 100%; height: 100%; min-height: 400px; position: relative; display: flex; align-items: center; justify-content: center; }
        .carousel-main-container img, .carousel-main-container video { width: 100%; height: 100%; object-fit: contain; }
        .var-chip-container { display: flex; flex-wrap: wrap; gap: 10px; margin-top: 10px; }
        .var-chip { padding: 8px 16px; border: 1px solid #eee; border-radius: 20px; cursor: pointer; transition: all 0.2s; background: white; font-weight: 600; }
        .var-chip.selected { background: var(--accent); color: white; border-color: var(--accent); }
        .color-circle { width: 12px; height: 12px; border-radius: 50%; border: 1px solid rgba(0,0,0,0.1); display:inline-block; margin-right:5px; }

        /* SIDEBAR */
        .sidebar { position:fixed; top:0; right:-500px; width:450px; height:100%; background:white; z-index:3000; padding:30px; box-shadow:-10px 0 50px rgba(0,0,0,0.1); transition:0.4s; display:flex; flex-direction:column; }
        .sidebar.open { right:0; }
        .btn-continue-shop {
            background: transparent; border: 2px solid var(--primary); color: var(--primary);
            padding: 10px; border-radius: 25px; font-weight: bold; width: 100%; margin-top: 10px;
            cursor: pointer; transition: 0.3s; display: flex; align-items: center; justify-content: center; gap: 8px;
        }
        .btn-continue-shop:hover { background: var(--primary); color: white; }

        /* FORMS & BUTTONS */
        .input { width:100%; padding:12px 15px; border:1px solid #ddd; border-radius:12px; font-size:0.95rem; margin-bottom:10px; background: #fafafa; transition:0.3s; }
        .input:focus { border-color: var(--primary); background: #fff; box-shadow: 0 0 0 3px rgba(196, 139, 120, 0.2); }
        .btn-modern { background: var(--accent); color: white; padding: 12px 24px; border-radius: 30px; border: none; font-weight: bold; display: flex; align-items: center; justify-content: center; gap: 8px; transition: all 0.3s; box-shadow: 0 4px 10px rgba(44,62,80,0.15); cursor: pointer; font-size: 0.95rem; text-decoration: none; }
        .btn-modern:hover { transform: translateY(-3px); box-shadow: 0 8px 20px rgba(44,62,80,0.25); background: var(--accent-light); color:white; }
        .btn-modern.outline { background: transparent; border: 2px solid #eee; color: #555; box-shadow: none; }
        .btn-modern.outline:hover { background: #f5f5f5; border-color: #ddd; color: var(--accent); }
        .btn-modern.small { padding: 8px 16px; font-size: 0.8rem; }
        .btn-modern.success { background: var(--success); }
        .btn-modern.danger { background: var(--danger); }
        .btn-whatsapp { background: var(--whatsapp); color: white; border:none; box-shadow: 0 4px 15px rgba(37, 211, 102, 0.3); }
        .btn-mp { background: var(--mp); color: white; border:none; box-shadow: 0 4px 15px rgba(0, 158, 227, 0.3); }

        /* ADMIN SPECIFIC */
        .admin-nav { padding:20px; background:white; border-bottom:1px solid #eee; display:flex; gap:10px; overflow-x:auto; }
        .admin-tab { padding:10px 25px; border-radius:30px; border:1px solid #eee; background:transparent; font-weight:600; cursor:pointer; white-space:nowrap; color: #777; transition: all 0.3s ease; }
        .admin-tab.active { background:var(--accent); color:white; border-color: var(--accent); box-shadow: 0 4px 15px rgba(44,62,80,0.2); }

        .dashboard-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 20px; margin-top: 25px; }
        .dash-card { background: white; border-radius: 16px; padding: 20px; display: flex; align-items: center; gap: 20px; border: 1px solid #f0f0f0; position:relative; box-shadow: 0 5px 15px rgba(0,0,0,0.03); }

        .fin-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 30px; }
        .fin-card-modern { background: white; border-radius: 16px; padding: 25px; border: 1px solid #f0f0f0; position: relative; overflow: hidden; box-shadow: var(--shadow); }
        .fin-card-modern::after { content:''; position:absolute; top:0; right:0; width:6px; height:100%; background: #ccc; }
        .fin-card-modern.profit::after { background: var(--success); }
        .fin-card-modern.cost::after { background: var(--danger); }
        .fin-card-modern.receivable::after { background: var(--warning); }
        .fin-label { font-size: 0.8rem; text-transform: uppercase; color: #888; font-weight: bold; letter-spacing: 0.5px; }
        .fin-val-big { font-size: 1.8rem; font-weight: 800; color: var(--accent); margin-top: 8px; }

        /* ADMIN CARDS & LISTS */
        .client-admin-card { background: white; border: 1px solid #eee; border-radius: 16px; margin-bottom: 15px; overflow: hidden; transition: 0.3s; }
        .cac-header { padding: 20px; display: flex; justify-content: space-between; align-items: center; background: #fff; cursor: pointer; }
        .cac-body { background: #f8f9fa; border-top: 1px solid #eee; padding: 20px; display: none; }
        .cac-body.open { display: block; animation: slideDown 0.3s ease; }

        .order-card-modern, .debt-card { background: #fff; border-radius: 16px; padding: 25px; margin-bottom: 20px; border: 1px solid #f0f0f0; box-shadow: 0 8px 24px rgba(0,0,0,0.04); transition: 0.3s; }
        .btn-map-visual { 
            background: #e8f0fe; color: #1967d2; border: 1px solid #d2e3fc; padding: 8px 15px; 
            border-radius: 20px; font-weight: bold; font-size: 0.85rem; text-decoration: none; 
            display: inline-flex; align-items: center; gap: 8px; transition:0.2s; 
        }
        .btn-map-visual:hover { background: #1967d2; color: white; }

        .paid-badge { 
            background: #e6fffa; color: #047857; padding: 5px 12px; border-radius: 20px; 
            font-weight: 800; border: 1px solid #b7eb8f; display: inline-flex; align-items: center; gap: 5px; 
        }

        /* THUMBNAILS IN LIST */
        .item-thumb-row { display: flex; align-items: center; gap: 10px; margin-bottom: 8px; padding-bottom: 8px; border-bottom: 1px dashed #eee; }
        .item-thumb-row:last-child { border-bottom: none; }
        .item-thumb-img { width: 40px; height: 40px; border-radius: 8px; object-fit: cover; border: 1px solid #ddd; }
        
        .inst-gen-row { display: grid; grid-template-columns: 40px 1fr 1fr auto !important; gap: 8px; align-items: center; margin-bottom: 8px; }
        .inst-partial-row { display: flex; gap: 5px; align-items: center; margin-top: 5px; justify-content: flex-end; }

        @keyframes slideDown { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        @media(max-width:768px){ 
            .box{grid-template-columns:1fr;} 
            .product-modal-grid { display: block; overflow-y: auto; }
            .sidebar{width:100%;} .hero{padding-top:80px;} 
        }
    </style>
</head>
<body>

    <div id="custom-dialog">
        <div class="cd-box">
            <div class="cd-icon" id="cd-icon"><i class="fas fa-info-circle"></i></div>
            <div class="cd-title" id="cd-title">Aten√ß√£o</div>
            <div class="cd-msg" id="cd-msg">Mensagem aqui</div>
            <input type="text" id="cd-input" class="cd-input" placeholder="Digite aqui...">
            <div class="cd-actions" id="cd-actions"></div>
        </div>
    </div>

    <div id="success-toast">
        <div class="st-icon-box"><i class="fas fa-check"></i></div>
        <div class="st-msg" id="st-text">Opera√ß√£o realizada!</div>
        <div class="st-progress-bg"><div class="st-progress-bar"></div></div>
    </div>
    <style>
        #success-toast {
            position: fixed; top: 20px; left: 50%; transform: translateX(-50%) translateY(-150px);
            background: white; padding: 20px 30px; border-radius: 16px;
            box-shadow: 0 20px 50px rgba(0,0,0,0.15); z-index: 100000;
            display: flex; flex-direction: column; align-items: center; gap: 10px;
            opacity: 0; transition: all 0.5s cubic-bezier(0.68, -0.55, 0.27, 1.55); min-width: 300px;
        }
        #success-toast.active { transform: translateX(-50%) translateY(0); opacity: 1; }
        .st-icon-box { width: 50px; height: 50px; background: #d4edda; border-radius: 50%; display: flex; align-items: center; justify-content: center; color: #155724; font-size: 1.5rem; }
        .st-msg { font-weight: 800; color: var(--accent); font-size: 1.1rem; }
        .st-progress-bg { width: 100%; height: 4px; background: #eee; border-radius: 4px; margin-top: 10px; overflow: hidden; }
        .st-progress-bar { height: 100%; background: var(--success); width: 100%; transform-origin: left; }
        #success-toast.active .st-progress-bar { animation: countDown 5s linear forwards; }
        @keyframes countDown { from { width: 100%; } to { width: 0%; } }
    </style>

    <div id="loading-screen">
        <i class="fas fa-circle-notch fa-spin fa-3x" style="color:var(--primary);"></i>
        <p style="margin-top:15px; color:#666;">Carregando loja...</p>
    </div>

    <div id="status-bar"></div>

    <div class="header-floating">
        <button class="login-btn-header" onclick="auth.checkProfile()">
            <i class="fas fa-user-circle"></i> Login / Cadastro
        </button>
        <button class="icon-btn" onclick="app.toggleCart()">
            <i class="fas fa-shopping-bag"></i><span class="badge" id="cart-count">0</span>
        </button>
    </div>

    <div class="hero">
        <img src="logo.jpg" onerror="this.src='https://via.placeholder.com/200?text=2A'">
        <h1 class="brand-font">2A Modas e Perfumes</h1>
        <p>Eleg√¢ncia que transforma. Descubra sua ess√™ncia.</p>
        <button class="btn-cta" onclick="app.openPromoModal()">‚ú® Ver Promo√ß√µes</button>
    </div>

    <div class="container" id="vitrine">
        <div class="filters">
            <button class="filter-btn active" onclick="app.filter('all', this)">Todos</button>
            <button class="filter-btn" onclick="app.filter('feminino', this)">Feminino</button>
            <button class="filter-btn" onclick="app.filter('infantil', this)">Infantil</button>
            <button class="filter-btn" onclick="app.filter('perfumes', this)">Perfumes</button>
        </div>
        <div id="products-list" class="grid"></div>
    </div>

    <div id="promo-modal" class="overlay">
        <div class="box single-col" style="background:var(--bg); overflow:hidden; max-width:800px;">
            <div style="padding:20px; display:flex; justify-content:space-between; align-items:center; border-bottom:1px solid #eee;">
                <h3>üî• Ofertas Especiais</h3>
                <button onclick="app.closeModal('promo-modal')" style="border:none; background:none; font-size:1.5rem;">√ó</button>
            </div>
            <div class="carousel-wrapper" style="padding: 20px; overflow-x: auto; display: flex; gap: 20px;" id="promo-track"></div>
        </div>
    </div>

    <div id="product-modal" class="overlay">
        <div class="box" style="padding: 25px; height: 85vh; max-height: 750px;">
            <div class="product-modal-grid">
                <div class="pm-images" id="m-media-area"></div>
                
                <div class="pm-details">
                    <button onclick="app.closeModal('product-modal')" style="align-self: flex-end; border:none; background:none; font-size:1.5rem; color:#999; cursor: pointer; margin-bottom: 10px;">√ó</button>
                    
                    <small id="m-cat" style="color:var(--primary); font-weight:800; text-transform:uppercase; letter-spacing: 1px; font-size: 0.8rem;">Categoria</small>
                    <h2 id="m-title" style="margin:5px 0 10px; font-size: 2.2rem; line-height: 1.1;"></h2>
                    <h3 id="m-price" class="pm-price-tag"></h3>
                    <div class="pm-desc-box"><p id="m-desc"></p></div>

                    <div style="margin-bottom:25px;">
                        <label style="font-weight:bold; font-size:0.9rem; margin-bottom:10px; display:block; color: var(--accent);">Escolha uma op√ß√£o:</label>
                        <div id="m-vars" class="var-chip-container"></div>
                    </div>

                    <div style="margin-top: auto;">
                        <div style="margin-bottom: 15px; color:#27ae60; font-weight:600; font-size: 0.9rem; display: flex; align-items: center; gap: 8px;">
                            <i class="fas fa-truck"></i> Entrega: 03 a 05 dias √∫teis
                        </div>
                        <div style="display:flex; gap:15px;">
                            <div style="border:1px solid #ddd; border-radius:30px; display:flex; align-items: center; height: 55px;">
                                <button onclick="app.updQty(-1)" style="padding:0 15px; border:none; background:transparent; font-size: 1.2rem;">-</button>
                                <span id="m-qty" style="font-weight:bold; width: 20px; text-align: center;">1</span>
                                <button onclick="app.updQty(1)" style="padding:0 15px; border:none; background:transparent; font-size: 1.2rem;">+</button>
                            </div>
                            <button onclick="app.addCart()" class="btn-modern btn-cta" style="flex:1; height: 55px; font-size: 1.1rem; margin-top: 0;">Adicionar √† Sacola</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="address-modal" class="overlay" style="justify-content:flex-start; padding-left:20px; z-index:10001;">
        <div class="box single-col" style="width:100%; max-width:500px; height:auto; overflow-y: auto;">
            <div style="padding:25px;">
                <h3>üìç Onde entregar?</h3>
                <div id="saved-addresses-list" style="margin-bottom:20px; max-height:150px; overflow-y:auto;"></div>
                <div style="background:#f9f9f9; padding:20px; border-radius:16px;">
                    <h4>Novo Endere√ßo</h4>
                    <input type="text" id="addr-cep" class="input" placeholder="CEP" onblur="app.fetchCep(this.value, 'addr')">
                    <input type="text" id="addr-street" class="input" placeholder="Rua">
                    <div class="input-row" style="display:grid; grid-template-columns:1fr 1fr; gap:10px;">
                        <input type="text" id="addr-num" class="input" placeholder="N√∫mero">
                        <input type="text" id="addr-bairro" class="input" placeholder="Bairro">
                    </div>
                    <div class="input-row" style="display:grid; grid-template-columns:1fr 1fr; gap:10px;">
                        <input type="text" id="addr-city" class="input" placeholder="Cidade">
                        <input type="text" id="addr-uf" class="input" placeholder="UF">
                    </div>
                    <input type="text" id="addr-ref" class="input" placeholder="Refer√™ncia">
                    <input type="text" id="addr-name" class="input" placeholder="Nome Recebedor">
                    <input type="text" id="addr-phone" class="input" placeholder="Telefone">
                    <select id="addr-type" class="input"><option>Casa</option><option>Trabalho</option></select>
                    <button onclick="app.addNewAddress()" class="btn-modern" style="width:100%;">Salvar</button>
                </div>
                <button onclick="app.closeModal('address-modal')" style="width:100%; margin-top:15px; background:none; border:none; color:#666;">Fechar</button>
            </div>
        </div>
    </div>

    <div class="sidebar">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px; border-bottom:1px solid #eee; padding-bottom:15px;">
            <h2 style="margin:0;">Sua Sacola</h2>
            <button onclick="app.toggleCart()" style="border:none; background:none; font-size:1.5rem; color:#999;">√ó</button>
        </div>
        
        <button onclick="app.toggleCart()" class="btn-continue-shop"><i class="fas fa-arrow-left"></i> Continuar Comprando</button>

        <div style="flex:1; overflow-y:auto; margin-top:15px;">
            <ul id="cart-list" style="list-style:none;"></ul>
        </div>
        
        <div style="border-top:1px solid #eee; padding-top:25px;">
            <div id="cart-auth-area" style="margin-bottom:15px;"></div>
            
            <button id="btn-address-trigger" onclick="app.openAddressModal()" class="btn-modern outline" style="width:100%; margin-bottom:15px; justify-content: flex-start;">
                <i class="fas fa-map-marker-alt"></i> Cadastrar local de entrega
            </button>
            
            <div style="background: #fafafa; padding: 15px; border-radius: 12px; margin-bottom: 20px;">
                <div style="display:flex; justify-content:space-between; font-weight:bold; font-size:1.1rem; color: var(--accent);">
                    <span>Total</span> <span id="cart-total">R$ 0.00</span>
                </div>
            </div>

            <button onclick="app.checkout('whatsapp')" class="btn-modern btn-whatsapp" style="width: 100%; margin-bottom: 10px;">
                <i class="fab fa-whatsapp"></i> Falar Via WhatsApp
            </button>
            <button onclick="app.checkout('mercadopago')" class="btn-modern btn-mp" style="width: 100%; margin-bottom: 10px;">
                <i class="fas fa-qrcode"></i> Pagar via Pix/Cart√£o
            </button>
            
            <button onclick="app.toggleCart()" class="btn-continue-shop" style="margin-top:0;"><i class="fas fa-arrow-left"></i> Voltar √† Loja</button>
        </div>
    </div>

    <div id="auth-modal" class="overlay" style="z-index:10002;">
        <div class="box single-col" style="padding:40px; text-align:center; max-width:400px;">
            <h2 id="auth-title" style="margin-bottom:25px;">Acesso</h2>
            <div id="form-login">
                <input type="email" id="l-email" class="input" placeholder="E-mail">
                <input type="password" id="l-pass" class="input" placeholder="Senha">
                <button onclick="auth.login()" class="btn-modern" style="width:100%;">Entrar</button>
                <p style="margin-top:20px;">N√£o tem conta? <a href="#" onclick="auth.toggle('register')">Cadastre-se</a></p>
            </div>
            <div id="form-register" style="display:none;">
                <input type="text" id="r-name" class="input" placeholder="Nome">
                <input type="email" id="r-email" class="input" placeholder="E-mail">
                <input type="password" id="r-pass" class="input" placeholder="Senha">
                <button onclick="auth.register()" class="btn-modern" style="width:100%;">Cadastrar</button>
                <p style="margin-top:20px;"><a href="#" onclick="auth.toggle('login')">Voltar</a></p>
            </div>
            <button onclick="app.closeModal('auth-modal')" style="position:absolute; top:20px; right:20px; border:none; background:none; font-size:1.5rem;">√ó</button>
        </div>
    </div>

    <div id="admin-auth-modal" class="overlay" style="z-index:10003;">
        <div class="box single-col" style="max-width: 350px; padding: 40px; text-align: center;">
            <i class="fas fa-lock" style="font-size:3rem; color:var(--accent); margin-bottom:20px;"></i>
            <h2>√Årea Restrita</h2>
            <input type="email" id="admin-email" class="input" placeholder="E-mail Admin" value="loja@2amoda.com">
            <input type="password" id="admin-pass" class="input" placeholder="Sua senha">
            <button onclick="admin.verifyLogin()" class="btn-modern" style="width:100%;">Entrar</button>
            <button onclick="app.closeModal('admin-auth-modal')" style="background:none; border:none; color:#999; margin-top:10px;">Cancelar</button>
        </div>
    </div>

    <div id="admin-modal" class="overlay" style="z-index:2001; background:#f4f6f9; align-items:flex-start; padding:0;">
        <div class="box" style="max-width:100%; height:100%; border-radius:0; padding:0; display:flex; flex-direction:column;">
            <div class="admin-nav">
                <h3 style="margin-right:20px; align-self:center;">Admin 2A</h3>
                <button onclick="admin.tab('dash')" class="admin-tab active">Estoque</button>
                <button onclick="admin.tab('orders')" class="admin-tab">Pedidos</button>
                <button onclick="admin.tab('pay')" class="admin-tab">Gest√£o de Clientes e Pedidos</button>
                <button onclick="admin.tab('prod')" class="admin-tab">Produtos</button>
                <button onclick="admin.logout()" class="btn-modern outline small" style="margin-left:auto;">Sair</button>
            </div>
            <div style="flex:1; overflow-y:auto; padding:30px; width:100%; max-width:1200px; margin:0 auto;">
                
                <div id="tab-dash">
                    <div style="display:grid; grid-template-columns:repeat(auto-fit, minmax(250px, 1fr)); gap:20px; margin-bottom:30px;">
                        <div style="background:white; padding:25px; border-radius:16px; text-align:center; box-shadow: var(--shadow);">
                            <div style="color:var(--success); font-weight:bold;">VALOR EM ESTOQUE</div>
                            <div class="stat-val" id="st-rev" style="font-size:1.8rem; font-weight:bold;">R$ 0.00</div>
                        </div>
                    </div>
                    <div style="background:white; padding:25px; border-radius:16px;">
                        <h4>Vis√£o Geral do Estoque</h4>
                        <div id="dash-stock-grid" class="dashboard-grid"></div>
                    </div>
                </div>

                <div id="tab-orders" style="display:none;">
                    <div style="background:white; padding:25px; border-radius:16px;">
                        <h3>Acompanhar Pedidos</h3>
                        <div id="orders-list"></div>
                    </div>
                </div>

                <div id="tab-pay" style="display:none;">
                    <div style="background:white; padding:25px; border-radius:16px;">
                        <h3>Gest√£o de Clientes e Pedidos</h3>
                        <div class="fin-grid">
                            <div class="fin-card-modern profit">
                                <div class="fin-label">Vendas (Receita Real)</div>
                                <div id="fin-real-revenue" class="fin-val-big">R$ 0.00</div>
                            </div>
                            <div class="fin-card-modern cost">
                                <div class="fin-label">Total Pedidos (Criados)</div>
                                <div id="fin-total-created" class="fin-val-big">R$ 0.00</div>
                            </div>
                            <div class="fin-card-modern receivable">
                                <div class="fin-label">Total a Receber</div>
                                <div id="fin-total-receivable" class="fin-val-big">R$ 0.00</div>
                            </div>
                        </div>
                        <div id="pay-list"></div>
                    </div>
                </div>

                <div id="tab-prod" style="display:none;">
                    <div style="background:white; padding:30px; border-radius:16px; margin-bottom:30px;">
                        <h3>Cadastro de Produto</h3>
                        <input type="hidden" id="edit-id">
                        <input type="text" id="f-name" class="input" placeholder="Nome do Produto">
                        <div style="display:flex; gap:15px;">
                            <select id="f-cat" class="input"><option value="feminino">Feminino</option><option value="infantil">Infantil</option><option value="perfumes">Perfumes</option></select>
                            <input type="number" id="f-cost" class="input" placeholder="Custo Global (Opcional)">
                        </div>
                        <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px;">
                            <input type="number" id="f-price-global" class="input" placeholder="Pre√ßo de Venda Global">
                            <input type="number" id="f-stock-global" class="input" placeholder="Estoque Geral">
                        </div>
                        <div style="margin: 20px 0;"><label><input type="checkbox" id="f-promo"> Ativar Promo√ß√£o?</label></div>
                        
                        <div onclick="document.getElementById('f-file').click()" style="border:2px dashed #ccc; padding:20px; text-align:center; cursor:pointer;">
                            <p>Clique para enviar fotos</p>
                            <input type="file" id="f-file" multiple accept="image/*" style="display:none;" onchange="admin.handleFileSelect(this)">
                        </div>
                        <div id="file-preview-area" style="display:flex; gap:10px; margin-top:10px;"></div>

                        <hr style="margin:20px 0;">
                        <label>Varia√ß√µes:</label>
                        <div id="color-checks" style="display:flex; gap:10px; flex-wrap:wrap; margin-bottom:10px;"></div>
                        <div id="volume-checks" style="display:flex; gap:10px; flex-wrap:wrap;"></div>
                        <div id="active-vars-area" style="margin-top:10px;"></div>

                        <textarea id="f-desc" class="input" rows="3" placeholder="Descri√ß√£o"></textarea>
                        <div style="display:flex; gap:10px; margin-top:20px;">
                            <button onclick="admin.save()" id="btn-save" class="btn-modern" style="flex:2;">Salvar</button>
                            <button onclick="admin.clear()" class="btn-modern outline" style="flex:1;">Limpar</button>
                        </div>
                    </div>
                    <div style="background:white; padding:25px; border-radius:16px;">
                        <h3>Lista de Produtos</h3>
                        <div id="admin-list" style="margin-top:20px;"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <footer>
        <p class="brand-font">¬© 2025 2A Modas e Perfumes.</p>
        <button onclick="admin.showLogin()">√Årea Administrativa</button>
    </footer>

    <script>
        // --- CUSTOM UI SYSTEM ---
        const ui = {
            dialog: document.getElementById('custom-dialog'),
            title: document.getElementById('cd-title'),
            msg: document.getElementById('cd-msg'),
            actions: document.getElementById('cd-actions'),
            icon: document.getElementById('cd-icon'),
            input: document.getElementById('cd-input'),
            
            reset: () => {
                ui.dialog.classList.remove('active');
                ui.title.innerText = ""; ui.msg.innerText = ""; ui.actions.innerHTML = "";
                ui.icon.innerHTML = ""; ui.input.style.display = 'none'; ui.input.value = "";
            },
            
            alert: (msg, title="Aviso") => {
                return new Promise(resolve => {
                    ui.title.innerText = title; ui.msg.innerText = msg;
                    ui.icon.innerHTML = '<i class="fas fa-info-circle"></i>';
                    ui.actions.innerHTML = `<button class="btn-modern" id="cd-ok">OK</button>`;
                    ui.dialog.classList.add('active');
                    document.getElementById('cd-ok').onclick = () => { ui.reset(); resolve(); };
                });
            },
            
            confirm: (msg, title="Confirmar") => {
                return new Promise(resolve => {
                    ui.title.innerText = title; ui.msg.innerText = msg;
                    ui.icon.innerHTML = '<i class="fas fa-question-circle" style="color:var(--warning)"></i>';
                    ui.actions.innerHTML = `
                        <button class="btn-modern outline" id="cd-cancel">Cancelar</button>
                        <button class="btn-modern" id="cd-yes">Sim, Confirmar</button>
                    `;
                    ui.dialog.classList.add('active');
                    document.getElementById('cd-cancel').onclick = () => { ui.reset(); resolve(false); };
                    document.getElementById('cd-yes').onclick = () => { ui.reset(); resolve(true); };
                });
            },
            
            prompt: (msg, title="Entrada") => {
                return new Promise(resolve => {
                    ui.title.innerText = title; ui.msg.innerText = msg;
                    ui.icon.innerHTML = '<i class="fas fa-pen"></i>';
                    ui.input.style.display = 'block';
                    ui.actions.innerHTML = `
                        <button class="btn-modern outline" id="cd-cancel">Cancelar</button>
                        <button class="btn-modern" id="cd-ok">Confirmar</button>
                    `;
                    ui.dialog.classList.add('active');
                    ui.input.focus();
                    document.getElementById('cd-cancel').onclick = () => { ui.reset(); resolve(null); };
                    document.getElementById('cd-ok').onclick = () => { 
                        const val = ui.input.value; ui.reset(); resolve(val); 
                    };
                });
            }
        };

        // --- CONFIG & STATE ---
        const SUPABASE_URL = 'https://sdeslwemzhxqixmphyye.supabase.co'; 
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InNkZXNsd2Vtemh4cWl4bXBoeXllIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjY3MDUxNDUsImV4cCI6MjA4MjI4MTE0NX0.QK7PkbYOnT6nIRFZHtHsuh42EuCjMSVvdnxf7h1bD80';
        let sb = null; try { sb = supabase.createClient(SUPABASE_URL, SUPABASE_KEY); } catch(e) { console.error(e); }
        
        const state = { products: [], cart: [], current: null, var: null, qty: 1, user: null, address: null, adminOrders: [], selectedFiles: [], mainImageIndex: 0 };
        const PRESETS_VOL = ['25ml','50ml','75ml','100ml','P','M','G','GG'];
        const COLOR_MAP = { 'Preto': '#000', 'Branco': '#fff', 'Vermelho': 'red', 'Azul': 'blue', 'Rosa': 'pink' };

        document.addEventListener('DOMContentLoaded', () => {
            const u = localStorage.getItem('2a_user'); if(u) state.user=JSON.parse(u);
            setTimeout(() => document.getElementById('loading-screen').style.display='none', 1500);
            app.load();
        });

        const app = {
            load: async () => {
                if(!sb) return;
                const { data } = await sb.from('products').select('*');
                state.products = data || []; app.render(state.products);
            },
            success: (msg) => {
                const t = document.getElementById('success-toast');
                document.getElementById('st-text').innerText = msg;
                t.classList.add('active');
                setTimeout(() => t.classList.remove('active'), 4000);
            },
            render: (list) => {
                const div = document.getElementById('products-list'); div.innerHTML = "";
                list.forEach(p => {
                    const vars = typeof p.variations === 'string' ? JSON.parse(p.variations) : p.variations;
                    const minP = Math.min(...vars.map(v => parseFloat(v.price)));
                    let img = "https://via.placeholder.com/300";
                    try { const m = JSON.parse(p.image_url); img = Array.isArray(m) ? m[0] : p.image_url; } catch(e){}
                    div.innerHTML += `<div class="card" onclick="app.openModal('${p.id}')"><img src="${img}"><div class="card-info"><b>${p.name}</b><br><span style="color:var(--primary)">R$ ${minP.toFixed(2)}</span></div></div>`;
                });
            },
            openModal: (id) => {
                const p = state.products.find(x => String(x.id) === String(id));
                state.current = p; state.qty=1; state.var=null;
                document.getElementById('m-title').innerText = p.name;
                document.getElementById('m-price').innerText = "Selecione...";
                
                let media = []; try { media = JSON.parse(p.image_url); } catch(e) { media = [p.image_url]; }
                if(!Array.isArray(media)) media = [p.image_url];
                document.getElementById('m-media-area').innerHTML = `<img src="${media[0]}" style="width:100%; height:100%; object-fit:contain;">`;
                
                const vDiv = document.getElementById('m-vars'); vDiv.innerHTML = "";
                const vars = typeof p.variations === 'string' ? JSON.parse(p.variations) : p.variations;
                vars.forEach(v => {
                    const chip = document.createElement('div');
                    chip.className = 'var-chip';
                    chip.innerText = `${v.name} (R$ ${v.price})`;
                    chip.onclick = () => {
                        state.var = v;
                        document.getElementById('m-price').innerText = `R$ ${parseFloat(v.price).toFixed(2)}`;
                        Array.from(vDiv.children).forEach(c => c.classList.remove('selected'));
                        chip.classList.add('selected');
                    };
                    vDiv.appendChild(chip);
                });
                app.showModal('product-modal');
            },
            addCart: () => {
                if(!state.var) return ui.alert("Selecione uma op√ß√£o");
                let img = state.current.image_url;
                try { const m = JSON.parse(img); if(Array.isArray(m)) img = m[0]; } catch(e){}
                state.cart.push({name: state.current.name, variant: state.var.name, price: parseFloat(state.var.price), qty: state.qty, image: img});
                app.renderCart(); app.closeModal('product-modal'); app.toggleCart();
            },
            renderCart: () => {
                const ul = document.getElementById('cart-list'); ul.innerHTML=""; let t=0;
                state.cart.forEach((i,idx) => {
                    t += i.price*i.qty;
                    ul.innerHTML += `<li style="display:flex; gap:10px; margin-bottom:10px; border-bottom:1px solid #eee; padding-bottom:10px;"><img src="${i.image}" style="width:50px;height:50px;border-radius:8px;"><div><b>${i.name}</b><br><small>${i.variant}</small><br>R$ ${i.price} x ${i.qty}</div><button onclick="state.cart.splice(${idx},1);app.renderCart()" style="margin-left:auto; color:red; border:none; background:none;"><i class="fas fa-trash"></i></button></li>`;
                });
                document.getElementById('cart-total').innerText = `R$ ${t.toFixed(2)}`;
                document.getElementById('cart-count').innerText = state.cart.length;
            },
            toggleCart: () => document.querySelector('.sidebar').classList.toggle('open'),
            showModal: (id) => { document.getElementById(id).classList.add('active'); },
            closeModal: (id) => { document.getElementById(id).classList.remove('active'); },
            updQty: (n) => { state.qty+=n; if(state.qty<1) state.qty=1; document.getElementById('m-qty').innerText = state.qty; },
            checkout: async (method) => {
                if(!state.cart.length) return ui.alert("Carrinho vazio");
                if(!state.user) { await ui.alert("Fa√ßa login para continuar."); app.showModal('auth-modal'); return; }
                const oid = Date.now().toString();
                const total = state.cart.reduce((a,b)=>a+(b.price*b.qty),0);
                // Simple Insert
                await sb.from('orders').insert([{
                    id: oid, customer_name: state.user.name, customer_email: state.user.email, total: total,
                    items: JSON.stringify(state.cart), address: JSON.stringify(state.address || {}),
                    method: method, status: 'Pendente', payment_status: 'Pendente', created_at: new Date().toISOString()
                }]);
                // Update stock logic would go here
                if(method === 'whatsapp') {
                    let msg = `Novo Pedido #${oid}\nCliente: ${state.user.name}\nItens:\n`;
                    state.cart.forEach(i => msg += `${i.qty}x ${i.name} (${i.variant})\n`);
                    msg += `\nTotal: R$ ${total.toFixed(2)}`;
                    window.location.href = `https://wa.me/5567998951120?text=${encodeURIComponent(msg)}`;
                } else {
                    app.success("Pedido Registrado! Aguarde link de pagamento.");
                }
                state.cart = []; app.renderCart(); app.toggleCart();
            }
        };

        const auth = {
            checkProfile: () => { if(state.user) ui.alert(`Logado como ${state.user.name}`); else app.showModal('auth-modal'); },
            login: async () => {
                const email = document.getElementById('l-email').value;
                const pass = document.getElementById('l-pass').value;
                const { data, error } = await sb.auth.signInWithPassword({ email, password: pass });
                if(error) ui.alert(error.message, "Erro");
                else {
                    const {data: userData} = await sb.from('customers').select('*').eq('email', email).single();
                    state.user = userData || { name: 'Cliente', email: email, id: data.user.id };
                    localStorage.setItem('2a_user', JSON.stringify(state.user));
                    app.closeModal('auth-modal'); app.success("Bem-vindo!");
                }
            },
            register: async () => {
                const name = document.getElementById('r-name').value;
                const email = document.getElementById('r-email').value;
                const pass = document.getElementById('r-pass').value;
                const { data, error } = await sb.auth.signUp({ email, password: pass });
                if(error) ui.alert(error.message, "Erro");
                else {
                    await sb.from('customers').insert([{ id: data.user.id, name, email }]);
                    ui.alert("Cadastro realizado! Fa√ßa login.");
                    auth.toggle('login');
                }
            },
            toggle: (mode) => {
                document.getElementById('form-login').style.display = mode === 'login' ? 'block' : 'none';
                document.getElementById('form-register').style.display = mode === 'register' ? 'block' : 'none';
            }
        };

        const admin = {
            showLogin: () => app.showModal('admin-auth-modal'),
            verifyLogin: () => {
                if(document.getElementById('admin-pass').value) {
                    app.closeModal('admin-auth-modal');
                    app.showModal('admin-modal');
                    admin.renderOrders(); admin.renderPayments(); admin.renderStats();
                } else { ui.alert("Senha incorreta", "Erro"); }
            },
            logout: () => { app.closeModal('admin-modal'); window.location.reload(); },
            tab: (t) => {
                document.querySelectorAll('.admin-tab').forEach(b => b.classList.remove('active'));
                document.querySelector(`.admin-tab[onclick*='${t}']`).classList.add('active');
                ['dash','prod','orders','pay'].forEach(i => document.getElementById(`tab-${i}`).style.display = i===t ? 'block' : 'none');
            },
            
            // --- PRODUCTS ---
            handleFileSelect: (input) => {
                state.selectedFiles = Array.from(input.files);
                const area = document.getElementById('file-preview-area'); area.innerHTML="";
                state.selectedFiles.forEach(f => area.innerHTML += `<img src="${URL.createObjectURL(f)}" style="width:60px;height:60px;object-fit:cover;border-radius:8px;">`);
            },
            save: async () => {
                const name = document.getElementById('f-name').value;
                // Simplified save logic for demo - integrate full upload logic here
                if(!name) return ui.alert("Nome obrigat√≥rio");
                
                let urls = ["https://via.placeholder.com/300"];
                // Upload logic would go here
                
                const vars = []; // Gather vars from inputs
                
                const payload = { 
                    name, 
                    variations: JSON.stringify([{name:'Padr√£o', price: document.getElementById('f-price-global').value || 0, stock:10}]),
                    image_url: JSON.stringify(urls),
                    id: Date.now()
                };
                
                await sb.from('products').insert([payload]);
                app.success("Produto Salvo!");
                admin.clear(); app.load();
            },
            clear: () => { document.getElementById('f-name').value=""; document.getElementById('file-preview-area').innerHTML=""; },
            
            // --- ORDERS & PAYMENTS ---
            renderOrders: async () => {
                const { data } = await sb.from('orders').select('*').order('created_at', {ascending:false});
                state.adminOrders = data || [];
                const div = document.getElementById('orders-list'); div.innerHTML = "";
                state.adminOrders.forEach(o => div.innerHTML += admin.generateOrderCardHTML(o, false));
            },
            
            renderPayments: async () => {
                const { data } = await sb.from('orders').select('*').neq('status', 'Cancelado').order('created_at', {ascending: false});
                const div = document.getElementById('pay-list'); div.innerHTML = "";
                if(!data) return;

                const clients = {};
                let totalReceivable = 0;

                data.forEach(o => {
                    const key = o.customer_email || o.customer_name;
                    if(!clients[key]) clients[key] = { name: o.customer_name, email: o.customer_email, debt: 0, paid: 0, orders: [] };
                    
                    let paid = 0;
                    if(o.payment_status === 'Pago') paid = o.total;
                    else if(o.installments) {
                        try { JSON.parse(o.installments).forEach(i => { if(i.paid) paid += parseFloat(i.amount); }); } catch(e){}
                    }
                    
                    const debt = o.total - paid;
                    clients[key].paid += paid;
                    clients[key].debt += debt;
                    totalReceivable += debt;
                    clients[key].orders.push(o);
                });

                document.getElementById('fin-total-receivable').innerText = `R$ ${totalReceivable.toFixed(2)}`;

                Object.values(clients).forEach((c, idx) => {
                    const html = c.orders.map(o => admin.generateOrderCardHTML(o, true)).join('');
                    const debtClass = c.debt > 0.1 ? 'color:var(--danger)' : 'color:var(--success)';
                    div.innerHTML += `
                    <div class="client-admin-card">
                        <div class="cac-header" onclick="document.getElementById('cb-${idx}').classList.toggle('open')">
                            <div>
                                <h4>${c.name}</h4>
                                <small>${c.email}</small>
                            </div>
                            <div style="text-align:right">
                                <div style="font-size:0.8rem; color:#888;">A RECEBER</div>
                                <div style="font-weight:bold; ${debtClass}">R$ ${c.debt.toFixed(2)}</div>
                            </div>
                        </div>
                        <div id="cb-${idx}" class="cac-body">${html}</div>
                    </div>`;
                });
            },

            generateOrderCardHTML: (o, isFinanceView) => {
                const addr = JSON.parse(o.address || '{}');
                const fullAddr = `${addr.street || ''}, ${addr.number || ''} - ${addr.city || ''}`;
                const mapUrl = `https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(fullAddr)}`;
                
                // Item Thumbnails Logic
                let itemsHtml = '';
                try {
                    const iList = JSON.parse(o.items);
                    itemsHtml = iList.map(i => `
                        <div class="item-thumb-row">
                            <img src="${i.image}" class="item-thumb-img" onerror="this.src='https://via.placeholder.com/40'">
                            <div>
                                <div style="font-size:0.85rem; font-weight:bold;">${i.name}</div>
                                <div style="font-size:0.75rem; color:#666;">${i.variant} | Qtd: ${i.qty}</div>
                            </div>
                        </div>
                    `).join('');
                } catch(e) {}

                // Installments Logic
                let instHtml = '';
                let isPaidFull = o.payment_status === 'Pago';
                if(o.installments && !isPaidFull) {
                    const arr = JSON.parse(o.installments);
                    instHtml = '<div style="background:white; padding:10px; border-radius:10px; margin-top:10px;">';
                    arr.forEach((inst, idx) => {
                        instHtml += `
                            <div style="border-bottom:1px dashed #eee; padding:8px 0;">
                                <div style="display:flex; justify-content:space-between; font-weight:bold; font-size:0.9rem;">
                                    <span>${idx+1}x ${inst.date.split('-').reverse().join('/')}</span>
                                    <span>R$ ${parseFloat(inst.amount).toFixed(2)}</span>
                                </div>
                                <div style="display:flex; justify-content:space-between; align-items:center; margin-top:5px;">
                                    ${inst.paid 
                                        ? '<span class="paid-badge"><i class="fas fa-check"></i> PAGO</span>' 
                                        : `<div class="inst-partial-row">
                                             <input type="number" id="p-pay-${o.id}-${idx}" class="input" style="width:80px; padding:5px; margin:0; height:30px;" placeholder="Valor">
                                             <button onclick="admin.payPartial('${o.id}', ${idx})" class="btn-modern small success" style="height:30px;">Pagar</button>
                                           </div>`
                                    }
                                </div>
                            </div>`;
                    });
                    instHtml += '</div>';
                }

                return `
                <div class="order-card-modern">
                    <div style="display:flex; justify-content:space-between; margin-bottom:10px; border-bottom:1px solid #eee; padding-bottom:5px;">
                        <strong>#${o.id.slice(-4)}</strong>
                        <span style="color:#888;">${new Date(o.created_at).toLocaleDateString()}</span>
                    </div>
                    
                    <div style="margin-bottom:15px;">${itemsHtml}</div>

                    <div style="background:#f9f9f9; padding:10px; border-radius:8px; display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
                        <div>
                            <div style="font-size:0.7rem; color:#888; text-transform:uppercase; font-weight:bold;">Entrega</div>
                            <div style="font-size:0.85rem;">${addr.street ? addr.street : 'Retirar'}</div>
                        </div>
                        ${addr.street ? `<a href="${mapUrl}" target="_blank" class="btn-map-visual"><i class="fas fa-map-marked-alt"></i> Abrir Mapa</a>` : ''}
                    </div>

                    <div style="display:flex; justify-content:space-between; align-items:center;">
                        <span style="font-size:1.1rem; font-weight:800; color:var(--accent);">Total: R$ ${o.total.toFixed(2)}</span>
                        ${isPaidFull ? '<span class="paid-badge"><i class="fas fa-check-circle"></i> TOTAL PAGO</span>' : ''}
                    </div>

                    ${instHtml}
                    
                    ${(!isPaidFull && !instHtml) ? `<button onclick="admin.genInst('${o.id}', ${o.total})" class="btn-modern small outline" style="width:100%; margin-top:10px;">Gerar Parcelas</button>` : ''}
                </div>`;
            },

            genInst: async (oid, total) => {
                const n = await ui.prompt("Quantas parcelas?", "Gerar Financeiro");
                if(!n || isNaN(n)) return;
                const arr = [];
                const val = (total / parseInt(n)).toFixed(2);
                for(let i=0; i<parseInt(n); i++){
                    const d = new Date(); d.setDate(d.getDate() + (30*(i+1)));
                    arr.push({ date: d.toISOString().split('T')[0], amount: val, paid: false });
                }
                await sb.from('orders').update({ payment_status: 'Parcelado', installments: JSON.stringify(arr) }).eq('id', oid);
                admin.renderPayments();
            },

            payPartial: async (oid, idx) => {
                const input = document.getElementById(`p-pay-${oid}-${idx}`);
                const val = parseFloat(input.value);
                if(!val || val <= 0) return ui.alert("Valor inv√°lido");

                const confirm = await ui.confirm(`Confirmar recebimento de R$ ${val.toFixed(2)}?`);
                if(!confirm) return;

                const { data } = await sb.from('orders').select('installments').eq('id', oid).single();
                let arr = JSON.parse(data.installments);
                
                const originalAmount = parseFloat(arr[idx].amount);
                
                if(val >= originalAmount) {
                    // Paid full installment
                    arr[idx].paid = true;
                    arr[idx].amount = val; // Just in case they paid more, treat as paid
                    ui.alert("Parcela quitada!");
                } else {
                    // Partial
                    arr[idx].paid = true;
                    arr[idx].amount = val; // Set this one to what was paid
                    
                    const diff = originalAmount - val;
                    // Push diff to next
                    if(idx + 1 < arr.length) {
                        arr[idx+1].amount = (parseFloat(arr[idx+1].amount) + diff).toFixed(2);
                        ui.alert(`R$ ${val.toFixed(2)} recebido. R$ ${diff.toFixed(2)} somado √† pr√≥xima parcela.`);
                    } else {
                        // Create new installment at end
                        const d = new Date(arr[idx].date); d.setMonth(d.getMonth()+1);
                        arr.push({ date: d.toISOString().split('T')[0], amount: diff.toFixed(2), paid: false });
                        ui.alert(`R$ ${val.toFixed(2)} recebido. Nova parcela de R$ ${diff.toFixed(2)} criada.`);
                    }
                }

                // Check if all paid
                const allPaid = arr.every(i => i.paid);
                const status = allPaid ? 'Pago' : 'Parcelado';

                await sb.from('orders').update({ installments: JSON.stringify(arr), payment_status: status }).eq('id', oid);
                admin.renderPayments();
            },
            
            renderStats: () => {
                // ... same as before
            }
        };

        // ... Existing inits ...
        admin.initCheckboxes = () => { /* ... populate var presets ... */ };
    </script>
</body>
</html>
