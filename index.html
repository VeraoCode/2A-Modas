<script>
        // --- 1. COLE SUAS CHAVES REAIS AQUI ---
        // Se você não colar isso, o site VAI TRAVAR.
        const firebaseConfig = {
 // Import the functions you need from the SDKs you need
import { initializeApp } from "firebase/app";
import { getAnalytics } from "firebase/analytics";
// TODO: Add SDKs for Firebase products that you want to use
// https://firebase.google.com/docs/web/setup#available-libraries

// Your web app's Firebase configuration
// For Firebase JS SDK v7.20.0 and later, measurementId is optional
const firebaseConfig = {
  apiKey: "AIzaSyB1Z3Vy5-wVfJ7yelQ7b_GakJWjhmD338o",
  authDomain: "loja2a.firebaseapp.com",
  projectId: "loja2a",
  storageBucket: "loja2a.firebasestorage.app",
  messagingSenderId: "864712234172",
  appId: "1:864712234172:web:670edd2de6d85fb118acb9",
  measurementId: "G-26EMJRJ3EY"
};

// Initialize Firebase
const app = initializeApp(firebaseConfig);
const analytics = getAnalytics(app);
        };

        // URL da Cloud Function (Seu backend de pagamento)
        const CLOUD_URL = "https://criarpagamentoss-967029810770.southamerica-east1.run.app"; 

        // Inicialização Segura do Firebase
        let db, storage;
        try {
            firebase.initializeApp(firebaseConfig);
            db = firebase.firestore();
            storage = firebase.storage();
        } catch (error) {
            console.error("Erro critico Firebase:", error);
            alert("Erro na configuração do Firebase. Verifique o Console (F12).");
        }

        const state = { products: [], cart: [], current: null, var: null, qty: 1 };

        // --- APP PRINCIPAL ---
        const app = {
            init: async () => {
                const loader = document.getElementById('loading-products');
                
                // Verifica se o Firebase iniciou
                if (!db) {
                    loader.innerHTML = "<p style='color:red'>Erro de Configuração (Sem chaves)</p>";
                    return;
                }

                loader.style.display = 'block';

                // Tenta conectar no banco
                db.collection("products").onSnapshot((querySnapshot) => {
                    state.products = [];
                    querySnapshot.forEach((doc) => {
                        state.products.push({ id: doc.id, ...doc.data() });
                    });
                    app.render(state.products);
                    
                    // Se estiver logado como admin, atualiza a lista dele também
                    if(document.getElementById('admin-panel').classList.contains('active')){
                        admin.renderList();
                    }
                    
                    loader.style.display = 'none'; // Destrava a tela
                }, (error) => {
                    console.error("Erro ao ler produtos:", error);
                    loader.innerHTML = "<p>Sem produtos ou erro de permissão.</p>";
                    // Destrava a tela mesmo com erro para permitir login admin
                    loader.style.display = 'none'; 
                    alert("Erro ao carregar produtos: " + error.code + ". Verifique as Regras do Firestore.");
                });
            },

            render: (list) => {
                const div = document.getElementById('products-list'); div.innerHTML = "";
                if(list.length === 0) div.innerHTML = "<p style='text-align:center; width:100%; color:#999;'>Nenhum produto cadastrado ainda.</p>";
                
                list.forEach(p => {
                    const stockTag = p.stock < 1 ? '<div class="stock-tag" style="background:red; color:white;">Esgotado</div>' : '';
                    div.innerHTML += `
                        <div class="product-card" onclick="app.modal('${p.id}')">
                            ${stockTag}
                            <img src="${p.image}" class="card-img">
                            <div class="card-info">
                                <small style="text-transform:uppercase; color:#999;">${p.category}</small>
                                <div style="font-weight:600; margin:5px 0;">${p.name}</div>
                                <div style="color:var(--primary); font-weight:bold;">R$ ${parseFloat(p.price).toFixed(2)}</div>
                            </div>
                        </div>`;
                });
            },

            filter: (cat, btn) => {
                document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
                app.render(cat === 'all' ? state.products : state.products.filter(p => p.category === cat));
            },

            modal: (id) => {
                const p = state.products.find(x => x.id === id);
                state.current = p; state.qty = 1; state.var = null;
                
                document.getElementById('m-img').src = p.image;
                document.getElementById('m-title').innerText = p.name;
                document.getElementById('m-price').innerText = `R$ ${parseFloat(p.price).toFixed(2)}`;
                document.getElementById('m-desc').innerText = p.desc;
                document.getElementById('m-cat').innerText = p.category;
                document.getElementById('m-qty').innerText = 1;

                const optsDiv = document.getElementById('m-opts-area'); optsDiv.innerHTML = "<strong>Opções:</strong><br>";
                if(p.options) {
                    p.options.forEach(opt => {
                        optsDiv.innerHTML += `<button onclick="app.selVar('${opt}', this)" style="margin:5px 5px 0 0; padding:8px; border:1px solid #ddd; background:white; border-radius:5px;">${opt}</button>`;
                    });
                }

                document.getElementById('product-modal').classList.add('active');
            },

            selVar: (val, el) => {
                state.var = val;
                const btns = document.getElementById('m-opts-area').getElementsByTagName('button');
                for(let b of btns) b.style.background = 'white';
                el.style.background = '#ddd';
            },

            updQty: (n) => {
                state.qty += n; if(state.qty < 1) state.qty = 1;
                document.getElementById('m-qty').innerText = state.qty;
            },

            addCart: () => {
                if(!state.var) return alert("Selecione uma opção");
                state.cart.push({ ...state.current, qty: state.qty, variant: state.var });
                app.renderCart();
                document.getElementById('product-modal').classList.remove('active');
                app.toggleCart();
            },

            renderCart: () => {
                const ul = document.getElementById('cart-list'); ul.innerHTML = "";
                let total = 0;
                state.cart.forEach((item, idx) => {
                    const sub = item.price * item.qty; total += sub;
                    ul.innerHTML += `
                    <li style="display:flex; justify-content:space-between; margin-bottom:15px; border-bottom:1px solid #eee; padding-bottom:10px;">
                        <div>
                            <strong>${item.name}</strong><br>
                            <small>${item.variant} x${item.qty}</small>
                        </div>
                        <div style="text-align:right">
                            R$ ${sub.toFixed(2)}<br>
                            <small onclick="state.cart.splice(${idx},1); app.renderCart()" style="color:red; cursor:pointer;">remover</small>
                        </div>
                    </li>`;
                });
                document.getElementById('cart-total').innerText = `R$ ${total.toFixed(2)}`;
                document.getElementById('cart-count').innerText = state.cart.length;
            },

            toggleCart: () => document.querySelector('.cart-sidebar').classList.toggle('open'),

            checkoutWs: () => {
                if(!state.cart.length) return alert("Carrinho vazio");
                let msg = "Olá! Pedido 2A Modas:\n\n"; let t=0;
                state.cart.forEach(i => { msg += `${i.name} (${i.variant}) x${i.qty}\n`; t += i.price * i.qty; });
                msg += `\nTotal: R$ ${t.toFixed(2)}`;
                window.open(`https://wa.me/5511999999999?text=${encodeURIComponent(msg)}`);
            },

            checkoutMp: async () => {
                if(!state.cart.length) return alert("Carrinho vazio");
                const btn = document.querySelector('.btn-mp');
                const originalText = btn.innerHTML;
                btn.innerText = "Processando..."; btn.disabled = true;
                
                try {
                    const items = state.cart.map(i => ({ name: i.name, price: i.price, qty: i.qty, variant: i.variant }));
                    const res = await fetch(CLOUD_URL, {
                        method: 'POST', headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({ items })
                    });
                    const data = await res.json();
                    if(data.init_point) window.location.href = data.init_point;
                    else alert("Erro ao gerar link");
                } catch(e) {
                    console.error(e); alert("Erro conexão ou URL inválida");
                } finally {
                    btn.innerHTML = originalText; btn.disabled = false;
                }
            }
        };

        // --- ADMINISTRAÇÃO ---
        const admin = {
            login: () => {
                const e = document.getElementById('adm-email').value;
                const p = document.getElementById('adm-pass').value;
                if(e === "admin@2amodas.com" && p === "admin123") {
                    document.getElementById('login-modal').classList.remove('active');
                    document.getElementById('admin-panel').classList.add('active');
                    admin.renderList();
                } else alert("Dados incorretos");
            },
            logout: () => document.getElementById('admin-panel').classList.remove('active'),

            previewFile: () => {
                const file = document.getElementById('f-file').files[0];
                if (file) {
                    document.getElementById('file-text').innerText = file.name;
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        const img = document.getElementById('f-preview');
                        img.src = e.target.result;
                        img.style.display = 'block';
                    }
                    reader.readAsDataURL(file);
                }
            },

            save: async (e) => {
                e.preventDefault();
                
                if(!db || !storage) return alert("Erro: Firebase não configurado corretamente.");

                const btn = document.getElementById('btn-save');
                btn.innerText = "Enviando..."; btn.disabled = true;

                try {
                    const file = document.getElementById('f-file').files[0];
                    let imageUrl = "";

                    // Upload
                    if (file) {
                        const ref = storage.ref(`produtos/${Date.now()}_${file.name}`);
                        await ref.put(file);
                        imageUrl = await ref.getDownloadURL();
                    } else {
                         // Se for novo produto sem imagem
                        if(!document.getElementById('edit-id').value) imageUrl = "https://via.placeholder.com/300";
                    }

                    const data = {
                        name: document.getElementById('f-name').value,
                        price: parseFloat(document.getElementById('f-price').value),
                        category: document.getElementById('f-cat').value,
                        stock: parseInt(document.getElementById('f-stock').value),
                        type: document.getElementById('f-type').value,
                        options: document.getElementById('f-opts').value.split(',').map(s=>s.trim()),
                        desc: document.getElementById('f-desc').value
                    };
                    
                    if(imageUrl) data.image = imageUrl;

                    const id = document.getElementById('edit-id').value;
                    if(id) {
                        await db.collection("products").doc(id).update(data);
                    } else {
                        await db.collection("products").add(data);
                    }

                    alert("Salvo!");
                    admin.clear();

                } catch (error) {
                    console.error("Erro:", error);
                    alert("Erro ao salvar: " + error.message);
                } finally {
                    btn.innerText = "Salvar Produto"; btn.disabled = false;
                }
            },

            clear: () => {
                document.querySelector('form').reset();
                document.getElementById('edit-id').value = "";
                document.getElementById('f-preview').style.display = 'none';
                document.getElementById('file-text').innerText = "Clique para selecionar uma foto";
            },

            renderList: () => {
                if(!db) return;
                const list = document.getElementById('admin-list'); list.innerHTML = "";
                state.products.forEach(p => {
                    list.innerHTML += `
                    <div style="display:flex; justify-content:space-between; align-items:center; padding:10px; border-bottom:1px solid #eee;">
                        <div style="display:flex; align-items:center;">
                            <img src="${p.image}" style="width:40px; height:40px; object-fit:cover; border-radius:5px; margin-right:10px;">
                            <strong>${p.name}</strong>
                        </div>
                        <div>
                            <button onclick="admin.del('${p.id}')" style="color:red; background:none; border:none;">Excluir</button>
                        </div>
                    </div>`;
                });
            },

            del: async (id) => {
                if(confirm("Tem certeza?")) {
                    await db.collection("products").doc(id).delete();
                }
            }
        };

        app.init();
    </script>
