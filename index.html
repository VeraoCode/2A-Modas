<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>2A Modas e Perfumes | Loja Oficial</title>
    
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;600;700&family=Playfair+Display:wght@700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        :root {
            --primary: #c48b78; --accent: #2c3e50; --bg: #f8f9fa;
            --white: #ffffff; --glass: rgba(255, 255, 255, 0.98);
            --radius: 12px; --shadow: 0 10px 30px rgba(0,0,0,0.08);
        }
        * { margin:0; padding:0; box-sizing:border-box; outline:none; font-family:'Plus Jakarta Sans', sans-serif; }
        body { background: var(--bg); color: var(--accent); overflow-x: hidden; }
        h1, h2, h3 { font-family:'Playfair Display', serif; }
        button { cursor:pointer; transition: all 0.2s ease; }

        /* HEADER */
        .header-floating { position: fixed; top: 30px; right: 5%; z-index: 1000; display:flex; gap:15px; }
        .icon-btn { width:55px; height:55px; border-radius:50%; border:none; background:white; box-shadow:0 4px 15px rgba(0,0,0,0.15); color:var(--accent); font-size:1.2rem; display:flex; align-items:center; justify-content:center; transition:0.3s; position:relative; }
        .icon-btn:hover { background:var(--primary); color:white; transform:scale(1.1); }
        .badge { position:absolute; top:-5px; right:-5px; background:var(--accent); color:white; width:22px; height:22px; border-radius:50%; font-size:0.75rem; display:flex; align-items:center; justify-content:center; font-weight:bold; border:2px solid white; }

        /* HERO & CARROSEL */
        .hero { padding: 120px 20px 80px; text-align:center; background: radial-gradient(circle at top, #fff5f2 0%, transparent 100%); }
        .hero img { width:180px; height:180px; border-radius:50%; object-fit:cover; border:5px solid white; box-shadow:var(--shadow); margin-bottom:20px; }
        .hero h1 { font-size:3.5rem; margin-bottom:10px; color:var(--accent); }
        .btn-cta { padding:15px 40px; background:var(--accent); color:white; border-radius:50px; border:none; font-weight:600; font-size:1rem; box-shadow:0 10px 20px rgba(44,62,80,0.2); }
        
        /* PRODUTOS */
        .container { max-width:1200px; margin:0 auto; padding:40px 20px; }
        .filters { display:flex; justify-content:center; gap:10px; margin-bottom:50px; flex-wrap:wrap; }
        .filter-btn { padding:10px 25px; border-radius:30px; border:1px solid #eee; background:white; color:#666; font-weight:600; }
        .filter-btn.active { background:var(--accent); color:white; }

        .grid { display:grid; grid-template-columns:repeat(auto-fill, minmax(260px, 1fr)); gap:30px; }
        .card { background:white; border-radius:var(--radius); overflow:hidden; border:1px solid #f0f0f0; transition:0.4s; position:relative; cursor:pointer; }
        .card:hover { transform:translateY(-10px); box-shadow:var(--shadow); border-color:var(--primary); }
        .card img { width:100%; height:350px; object-fit:cover; background:#f9f9f9; }
        .card-info { padding:20px; text-align:center; }
        .tag-promo { position:absolute; top:15px; right:15px; background:#e91e63; color:white; padding:5px 12px; border-radius:20px; font-size:0.7rem; font-weight:bold; }

        /* MODALS */
        .overlay { position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.6); z-index:2000; display:none; align-items:center; justify-content:center; backdrop-filter:blur(8px); padding:20px; }
        .overlay.active { display:flex; animation: popIn 0.3s ease; }
        @keyframes popIn { from{transform:scale(0.9); opacity:0;} to{transform:scale(1); opacity:1;} }
        
        .box { background:white; width:100%; max-width:900px; border-radius:20px; overflow:hidden; max-height:90vh; overflow-y:auto; display:grid; grid-template-columns:1fr 1fr; box-shadow:var(--shadow); }
        .box.single-col { display:block; max-width:500px; }
        
        /* CARROSEL POPUP */
        .carousel-container { display:flex; overflow-x:auto; gap:20px; padding:20px; scroll-snap-type:x mandatory; }
        .carousel-item { flex:0 0 80%; scroll-snap-align:center; background:white; border-radius:15px; padding:15px; box-shadow:0 5px 15px rgba(0,0,0,0.1); cursor:pointer; text-align:center; }
        .carousel-item img { width:100%; height:200px; object-fit:cover; border-radius:10px; margin-bottom:10px; }

        /* SIDEBAR CARRINHO */
        .sidebar { position:fixed; top:0; right:-500px; width:450px; height:100%; background:white; z-index:3000; padding:30px; box-shadow:-10px 0 50px rgba(0,0,0,0.1); transition:0.4s; display:flex; flex-direction:column; }
        .sidebar.open { right:0; }
        .cart-item { display:flex; justify-content:space-between; align-items:center; padding:15px 0; border-bottom:1px solid #f5f5f5; }
        .qty-controls { display:flex; align-items:center; gap:8px; background:#f5f5f5; padding:5px; border-radius:8px; margin-top:5px; }
        .qty-btn { width:25px; height:25px; border:none; background:white; border-radius:4px; font-weight:bold; }

        /* ADMIN & FORMS */
        .admin-nav { padding:20px; background:white; border-bottom:1px solid #eee; display:flex; gap:10px; position:sticky; top:0; z-index:10; overflow-x:auto; }
        .admin-tab { padding:10px 20px; border-radius:30px; border:1px solid #eee; background:transparent; font-weight:600; color:#666; white-space:nowrap; }
        .admin-tab.active { background:var(--accent); color:white; border-color:var(--accent); }
        
        .input { width:100%; padding:12px; border:1px solid #ddd; border-radius:8px; font-size:0.95rem; margin-bottom:10px; }
        .checkbox-grid { display:grid; grid-template-columns:repeat(auto-fill, minmax(100px, 1fr)); gap:10px; background:#f9f9f9; padding:15px; border-radius:12px; margin-bottom:15px; border:1px solid #eee; }
        .var-inputs { display:none; background:white; border:1px solid #eee; padding:15px; border-radius:8px; margin-top:10px; }
        .var-inputs.show { display:grid; grid-template-columns:1fr 1fr; gap:10px; }
        
        /* TABELA ADMIN */
        .admin-table { width:100%; border-collapse:collapse; font-size:0.9rem; }
        .admin-table th { text-align:left; padding:12px; background:#f9f9f9; color:#666; }
        .admin-table td { padding:12px; border-bottom:1px solid #eee; }
        
        /* MINI PRODUTO ADMIN */
        .mini-prod { display:flex; align-items:center; gap:10px; padding:10px; border-bottom:1px solid #eee; }
        .mini-prod img { width:50px; height:50px; border-radius:8px; object-fit:cover; }

        @media(max-width:768px){ .box{grid-template-columns:1fr;} .sidebar{width:100%;} .hero{padding-top:80px;} }
    </style>
</head>
<body>

    <div class="header-floating">
        <button class="icon-btn" onclick="auth.checkProfile()">
            <i class="fas fa-user"></i>
        </button>
        <button class="icon-btn" onclick="app.toggleCart()">
            <i class="fas fa-shopping-bag"></i>
            <span class="badge" id="cart-count">0</span>
        </button>
    </div>

    <div class="hero">
        <img src="logo.jpg" onerror="this.src='https://via.placeholder.com/200?text=2A'">
        <h1>2A Modas e Perfumes</h1>
        <p>Eleg√¢ncia que transforma. Descubra sua ess√™ncia.</p>
        <button class="btn-cta" onclick="app.openPromoCarousel()">‚ú® Ver Promo√ß√µes</button>
    </div>

    <div class="container" id="vitrine">
        <div class="filters">
            <button class="filter-btn active" onclick="app.filter('all', this)">Todos</button>
            <button class="filter-btn" onclick="app.filter('feminino', this)">Feminino</button>
            <button class="filter-btn" onclick="app.filter('infantil', this)">Infantil</button>
            <button class="filter-btn" onclick="app.filter('perfumes', this)">Perfumes</button>
        </div>
        <div id="loading" style="text-align:center; padding:50px; color:#aaa;"><i class="fas fa-circle-notch fa-spin fa-2x"></i></div>
        <div id="products-list" class="grid"></div>
    </div>

    <div id="promo-modal" class="overlay">
        <div class="box single-col" style="background:var(--bg);">
            <div style="padding:20px; display:flex; justify-content:space-between; align-items:center;">
                <h3>üî• Destaques & Promo√ß√µes</h3>
                <button onclick="document.getElementById('promo-modal').classList.remove('active')" style="border:none; background:none; font-size:1.5rem;">&times;</button>
            </div>
            <div class="carousel-container" id="promo-list"></div>
        </div>
    </div>

    <div id="product-modal" class="overlay">
        <div class="box">
            <img id="m-img" style="width:100%; height:100%; object-fit:cover; background:#f0f0f0;">
            <div style="padding:40px; position:relative;">
                <button onclick="document.getElementById('product-modal').classList.remove('active')" style="position:absolute; top:20px; right:20px; border:none; background:none; font-size:1.5rem; color:#999;">&times;</button>
                <small id="m-cat" style="color:var(--primary); font-weight:700; text-transform:uppercase;">Categoria</small>
                <h2 id="m-title" style="margin:10px 0;">Nome</h2>
                <h3 id="m-price" style="color:var(--accent); margin-bottom:15px;">R$ 0,00</h3>
                <p id="m-desc" style="color:#666; margin-bottom:30px;">Descri√ß√£o...</p>
                <div id="m-vars" style="display:flex; flex-wrap:wrap; gap:10px; margin-bottom:30px;"></div>
                <div style="display:flex; align-items:center; gap:15px; margin-bottom:25px;">
                    <span style="font-weight:bold;">Qtd:</span>
                    <div style="border:1px solid #ddd; border-radius:8px; display:flex;">
                        <button onclick="app.updQty(-1)" style="padding:10px 15px; border:none; background:white;">-</button>
                        <span id="m-qty" style="padding:10px 15px; font-weight:bold;">1</span>
                        <button onclick="app.updQty(1)" style="padding:10px 15px; border:none; background:white;">+</button>
                    </div>
                </div>
                <button id="btn-add-cart" onclick="app.addCart()" style="width:100%; background:var(--accent); color:white; padding:18px; border-radius:12px; border:none; font-weight:bold;">Adicionar √† Sacola</button>
            </div>
        </div>
    </div>

    <div id="auth-modal" class="overlay">
        <div class="box single-col" style="padding:40px; text-align:center;">
            <h2 id="auth-title" style="margin-bottom:20px;">Bem-vindo</h2>
            
            <div id="form-login">
                <input type="email" id="l-email" class="input" placeholder="E-mail">
                <input type="password" id="l-pass" class="input" placeholder="Senha">
                <button onclick="auth.login()" style="width:100%; background:var(--accent); color:white; padding:12px; border-radius:8px; border:none; font-weight:bold;">Entrar</button>
                <p style="margin-top:15px; font-size:0.9rem;">N√£o tem conta? <a href="#" onclick="auth.toggle('register')">Cadastre-se</a></p>
                <hr style="margin:20px 0; border:0; border-top:1px solid #eee;">
                <button onclick="admin.checkAdmin()" style="background:none; border:none; color:#999; font-size:0.8rem;">Acesso Admin</button>
            </div>

            <div id="form-register" style="display:none;">
                <input type="text" id="r-name" class="input" placeholder="Nome Completo">
                <input type="email" id="r-email" class="input" placeholder="E-mail">
                <input type="password" id="r-pass" class="input" placeholder="Criar Senha">
                <h4 style="text-align:left; margin:10px 0;">Endere√ßo de Entrega:</h4>
                <input type="text" id="r-phone" class="input" placeholder="WhatsApp">
                <input type="text" id="r-street" class="input" placeholder="Rua e N√∫mero">
                <input type="text" id="r-bairro" class="input" placeholder="Bairro">
                <button onclick="auth.register()" style="width:100%; background:var(--primary); color:white; padding:12px; border-radius:8px; border:none; font-weight:bold;">Criar Conta</button>
                <p style="margin-top:15px; font-size:0.9rem;">J√° tem conta? <a href="#" onclick="auth.toggle('login')">Entrar</a></p>
            </div>
            
            <button onclick="document.getElementById('auth-modal').classList.remove('active')" style="position:absolute; top:15px; right:15px; border:none; background:none; font-size:1.5rem;">&times;</button>
        </div>
    </div>

    <div class="sidebar">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px; border-bottom:1px solid #eee; padding-bottom:10px;">
            <h2 style="margin:0;">Sua Sacola</h2>
            <button onclick="app.toggleCart()" style="border:none; background:none; font-size:1.5rem; color:#999;">&times;</button>
        </div>
        <div style="flex:1; overflow-y:auto;">
            <ul id="cart-list" style="list-style:none;"></ul>
        </div>
        <div style="border-top:1px solid #eee; padding-top:20px;">
            <div id="user-info-cart" style="background:#f0fff4; padding:10px; border-radius:8px; margin-bottom:15px; font-size:0.9rem; color:#27ae60; display:none;">
                <i class="fas fa-user-check"></i> Logado como <span id="lbl-user-name"></span><br>
                <small id="lbl-user-addr"></small>
            </div>
            <div style="display:flex; justify-content:space-between; font-weight:bold; margin-bottom:15px; font-size:1.1rem;">
                <span>Total</span> <span id="cart-total">R$ 0.00</span>
            </div>
            <button onclick="app.checkout('whatsapp')" style="width:100%; padding:14px; border-radius:10px; border:none; font-weight:bold; background:#25D366; color:white; margin-bottom:10px;">Falar via WhatsApp</button>
            <button onclick="app.checkout('mercadopago')" style="width:100%; padding:14px; border-radius:10px; border:none; font-weight:bold; background:#009EE3; color:white;">Via Pix/Cart√£o</button>
        </div>
    </div>

    <div id="admin-modal" class="overlay" style="z-index:2001; background:#f4f6f9; align-items:flex-start; padding:0;">
        <div class="box" style="max-width:100%; height:100%; border-radius:0; padding:0; display:flex; flex-direction:column;">
            <div class="admin-nav">
                <h3 style="margin-right:20px;">Gest√£o 2A</h3>
                <button onclick="admin.tab('dash')" class="admin-tab active">Financeiro</button>
                <button onclick="admin.tab('orders')" class="admin-tab">Pedidos</button>
                <button onclick="admin.tab('prod')" class="admin-tab">Produtos</button>
                <button onclick="document.getElementById('admin-modal').classList.remove('active')" style="background:#e74c3c; color:white; border:none; padding:8px 20px; border-radius:20px; margin-left:auto;">Sair</button>
            </div>

            <div style="flex:1; overflow-y:auto; padding:30px; width:100%; max-width:1200px; margin:0 auto;">
                
                <div id="tab-dash">
                    <div style="display:grid; grid-template-columns:repeat(auto-fit, minmax(200px, 1fr)); gap:20px; margin-bottom:30px;">
                        <div class="card" style="padding:20px; text-align:center;">
                            <div style="color:#27ae60; font-weight:bold;">LUCRO PREVISTO</div>
                            <div class="stat-val" id="st-profit" style="font-size:1.5rem; font-weight:bold; color:var(--accent);">R$ 0.00</div>
                        </div>
                        <div class="card" style="padding:20px; text-align:center;">
                            <div style="color:#e74c3c; font-weight:bold;">CUSTO ESTOQUE</div>
                            <div class="stat-val" id="st-cost" style="font-size:1.5rem; font-weight:bold; color:var(--accent);">R$ 0.00</div>
                        </div>
                        <div class="card" style="padding:20px; text-align:center;">
                            <div style="color:#2980b9; font-weight:bold;">VENDA TOTAL</div>
                            <div class="stat-val" id="st-rev" style="font-size:1.5rem; font-weight:bold; color:var(--accent);">R$ 0.00</div>
                        </div>
                    </div>
                    <div style="background:white; padding:20px; border-radius:12px;">
                        <h4>Vis√£o Geral de Produtos</h4>
                        <div id="mini-prod-list" style="margin-top:15px; max-height:400px; overflow-y:auto;"></div>
                    </div>
                </div>

                <div id="tab-orders" style="display:none;">
                    <div style="background:white; padding:20px; border-radius:12px;">
                        <h3>Hist√≥rico de Vendas</h3>
                        <table class="admin-table">
                            <thead><tr><th>Data</th><th>Cliente</th><th>Total</th><th>Itens</th></tr></thead>
                            <tbody id="orders-table-body"></tbody>
                        </table>
                    </div>
                </div>

                <div id="tab-prod" style="display:none;">
                    <div style="display:grid; grid-template-columns:1fr 1fr; gap:30px;">
                        <div style="background:white; padding:25px; border-radius:12px;">
                            <h3>Cadastro / Edi√ß√£o</h3>
                            <input type="hidden" id="edit-id">
                            <input type="text" id="f-name" class="input" placeholder="Nome do Produto">
                            <div style="display:flex; gap:10px;">
                                <select id="f-cat" class="input"><option value="feminino">Feminino</option><option value="infantil">Infantil</option><option value="perfumes">Perfumes</option></select>
                                <input type="number" id="f-cost" class="input" placeholder="Custo (R$)">
                            </div>
                            <label><input type="checkbox" id="f-promo"> √â Promo√ß√£o? (Aparecer no Carrossel)</label>
                            <input type="file" id="f-file" class="input" style="margin-top:10px;">
                            <hr style="margin:15px 0; border:0; border-top:1px solid #eee;">
                            <label style="font-weight:bold;">Cores & Volumetria:</label>
                            <div class="checkbox-grid" id="color-checks" style="margin-top:5px;"></div>
                            <div class="checkbox-grid" id="volume-checks"></div>
                            <div id="active-vars-area"></div>
                            <textarea id="f-desc" class="input" rows="3" placeholder="Descri√ß√£o" style="margin-top:10px;"></textarea>
                            <button onclick="admin.save()" id="btn-save" style="width:100%; background:var(--primary); color:white; padding:15px; border-radius:8px; border:none; margin-top:15px;">Salvar Produto</button>
                            <button onclick="admin.clear()" style="width:100%; padding:10px; background:none; border:none; color:#666;">Limpar</button>
                        </div>
                        <div style="background:white; padding:25px; border-radius:12px; overflow-y:auto; max-height:80vh;">
                            <h3>Produtos Cadastrados</h3>
                            <div id="admin-list" style="margin-top:15px;"></div>
                        </div>
                    </div>
                </div>

            </div>
        </div>
    </div>

    <script>
        // --- ‚ö†Ô∏è CHAVES ---
        const SUPABASE_URL = 'https://sdeslwemzhxqixmphyye.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InNkZXNsd2Vtemh4cWl4bXBoeXllIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjY3MDUxNDUsImV4cCI6MjA4MjI4MTE0NX0.QK7PkbYOnT6nIRFZHtHsuh42EuCjMSVvdnxf7h1bD80
';
        const GOOGLE_CLOUD_URL = 'https://criarpagamentoss-967029810770.southamerica-east1.run.app'; 

        const sb = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
        const state = { products: [], cart: [], current: null, var: null, qty: 1, user: null };
        const PRESETS = { colors: ['Preto','Branco','Vermelho','Azul','Rosa','Verde','Nude','Estampado'], vols: ['25ml','50ml','75ml','100ml','200ml'] };

        // --- INIT ---
        (async function init() {
            // Verifica usu√°rio logado
            const savedUser = localStorage.getItem('2a_user');
            if(savedUser) state.user = JSON.parse(savedUser);

            // Verifica retorno de pagamento
            const urlParams = new URLSearchParams(window.location.search);
            if(urlParams.get('status') === 'approved') {
                const savedCart = localStorage.getItem('2a_cart');
                if(savedCart && state.user) {
                    state.cart = JSON.parse(savedCart);
                    await app.registerOrder('Mercado Pago'); // Registra no banco
                    window.history.replaceState({}, document.title, "/");
                    app.sendPaidOrder(); // Envia whats
                }
            }

            // Carrega dados
            try {
                const { data } = await sb.from('products').select('*');
                state.products = data || [];
                app.render(state.products);
                document.getElementById('loading').style.display='none';
                admin.initCheckboxes();
                auth.updateUI();
            } catch(e) { console.error(e); }
        })();

        // --- AUTH & USER ---
        const auth = {
            checkProfile: () => {
                if(state.user) {
                    if(confirm(`Ol√° ${state.user.name}! Deseja sair?`)) auth.logout();
                } else {
                    document.getElementById('auth-modal').classList.add('active');
                }
            },
            toggle: (mode) => {
                document.getElementById('form-login').style.display = mode==='login'?'block':'none';
                document.getElementById('form-register').style.display = mode==='register'?'block':'none';
                document.getElementById('auth-title').innerText = mode==='login'?'Bem-vindo':'Criar Conta';
            },
            login: async () => {
                const email = document.getElementById('l-email').value;
                const pass = document.getElementById('l-pass').value;
                // Busca no banco
                const { data, error } = await sb.from('customers').select('*').eq('email', email).eq('password', pass).single();
                if(data) {
                    state.user = data;
                    localStorage.setItem('2a_user', JSON.stringify(data));
                    document.getElementById('auth-modal').classList.remove('active');
                    auth.updateUI();
                } else alert("E-mail ou senha incorretos.");
            },
            register: async () => {
                const name = document.getElementById('r-name').value;
                const email = document.getElementById('r-email').value;
                const pass = document.getElementById('r-pass').value;
                const addr = {
                    phone: document.getElementById('r-phone').value,
                    street: document.getElementById('r-street').value,
                    bairro: document.getElementById('r-bairro').value
                };
                
                if(!name || !email || !pass || !addr.phone) return alert("Preencha todos os campos");

                const id = Date.now().toString();
                const { error } = await sb.from('customers').insert([{ id, name, email, password: pass, address: addr }]);
                
                if(!error) {
                    alert("Conta criada com sucesso! Fa√ßa login.");
                    auth.toggle('login');
                } else alert("Erro ao criar conta: " + error.message);
            },
            logout: () => {
                state.user = null;
                localStorage.removeItem('2a_user');
                auth.updateUI();
            },
            updateUI: () => {
                const info = document.getElementById('user-info-cart');
                if(state.user) {
                    info.style.display = 'block';
                    document.getElementById('lbl-user-name').innerText = state.user.name;
                    document.getElementById('lbl-user-addr').innerText = `${state.user.address.street} - ${state.user.address.bairro}`;
                } else {
                    info.style.display = 'none';
                }
            }
        };

        // --- APP LOGIC ---
        const app = {
            render: (list) => {
                const div = document.getElementById('products-list'); div.innerHTML = "";
                list.forEach(p => {
                    const vars = typeof p.variations === 'string' ? JSON.parse(p.variations) : p.variations;
                    const minP = Math.min(...vars.map(v => parseFloat(v.price)));
                    const isPromo = p.is_promo ? '<span class="tag-promo">OFERTA</span>' : '';
                    div.innerHTML += `
                        <div class="card" onclick="app.modal('${p.id}')">
                            ${isPromo}
                            <img src="${p.image_url}" onerror="this.src='https://via.placeholder.com/300'">
                            <div class="card-info">
                                <span style="font-size:0.8rem; color:#999; text-transform:uppercase;">${p.category}</span>
                                <div style="font-weight:bold; margin:5px 0;">${p.name}</div>
                                <div style="color:var(--primary); font-weight:bold;">A partir R$ ${minP.toFixed(2)}</div>
                            </div>
                        </div>`;
                });
            },
            openPromoCarousel: () => {
                const promos = state.products.filter(p => p.is_promo);
                if(!promos.length) return alert("Nenhuma promo√ß√£o ativa no momento.");
                
                const cDiv = document.getElementById('promo-list'); cDiv.innerHTML = "";
                promos.forEach(p => {
                    cDiv.innerHTML += `
                    <div class="carousel-item" onclick="app.modal('${p.id}'); document.getElementById('promo-modal').classList.remove('active');">
                        <img src="${p.image_url}">
                        <strong>${p.name}</strong>
                    </div>`;
                });
                document.getElementById('promo-modal').classList.add('active');
            },
            filter: (cat, btn) => {
                document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
                app.render(cat==='all' ? state.products : state.products.filter(p => p.category===cat));
            },
            modal: (id) => {
                const p = state.products.find(x => String(x.id) === String(id));
                if(!p) return;
                state.current = p; state.qty=1; state.var=null;
                document.getElementById('m-img').src=p.image_url; document.getElementById('m-title').innerText=p.name;
                document.getElementById('m-cat').innerText=p.category; document.getElementById('m-desc').innerText=p.description;
                document.getElementById('m-price').innerText="Selecione...";
                
                const vDiv = document.getElementById('m-vars'); vDiv.innerHTML = "";
                const vars = typeof p.variations === 'string' ? JSON.parse(p.variations) : p.variations;
                
                vars.forEach(v => {
                    const btn = document.createElement('button');
                    btn.style.padding="8px"; btn.style.margin="5px"; btn.style.border="1px solid #ddd"; btn.style.borderRadius="5px"; btn.style.background="white";
                    btn.innerHTML = `${v.name} <br> <b>R$ ${parseFloat(v.price).toFixed(2)}</b>`;
                    if(parseInt(v.stock)>0) {
                        btn.onclick = () => {
                            state.var = v;
                            document.getElementById('m-price').innerText = `R$ ${parseFloat(v.price).toFixed(2)}`;
                            Array.from(vDiv.children).forEach(b=>b.style.background='white');
                            btn.style.background='#e3c0a5';
                        };
                    } else { btn.disabled=true; btn.style.opacity=0.5; }
                    vDiv.appendChild(btn);
                });
                document.getElementById('product-modal').classList.add('active');
            },
            updQty: (n) => { state.qty += n; if(state.qty<1) state.qty=1; document.getElementById('m-qty').innerText = state.qty; },
            addCart: () => {
                if(!state.var) return alert("Selecione uma op√ß√£o");
                state.cart.push({name: state.current.name, variant: state.var.name, price: parseFloat(state.var.price), qty: state.qty});
                app.renderCart(); document.getElementById('product-modal').classList.remove('active'); app.toggleCart();
            },
            renderCart: () => {
                const ul = document.getElementById('cart-list'); ul.innerHTML=""; let t=0;
                state.cart.forEach((i,idx) => {
                    t += i.price*i.qty;
                    ul.innerHTML += `<li class="cart-item">
                        <div><b>${i.name}</b><br><small>${i.variant}</small><div class="qty-controls"><button class="qty-btn" onclick="app.cQty(${idx},-1)">-</button>${i.qty}<button class="qty-btn" onclick="app.cQty(${idx},1)">+</button></div></div>
                        <div style="text-align:right">R$ ${(i.price*i.qty).toFixed(2)}<br><i class="fas fa-trash" onclick="state.cart.splice(${idx},1);app.renderCart()" style="color:red;cursor:pointer"></i></div>
                    </li>`;
                });
                document.getElementById('cart-total').innerText = `R$ ${t.toFixed(2)}`;
                document.getElementById('cart-count').innerText = state.cart.length;
            },
            cQty: (idx,n) => { state.cart[idx].qty+=n; if(state.cart[idx].qty<1) state.cart[idx].qty=1; app.renderCart(); },
            toggleCart: () => document.querySelector('.sidebar').classList.toggle('open'),
            
            // --- CHECKOUT LOGIC ---
            checkAuth: () => {
                if(!state.user) {
                    alert("Por favor, fa√ßa login ou cadastre-se para continuar.");
                    document.getElementById('auth-modal').classList.add('active');
                    app.toggleCart(); // fecha carrinho
                    return false;
                }
                return true;
            },
            checkout: async (method) => {
                if(!state.cart.length) return alert("Carrinho vazio");
                if(!app.checkAuth()) return;

                if(method === 'whatsapp') {
                    // Registra pedido e abre whats
                    await app.registerOrder('WhatsApp');
                    app.sendPaidOrder();
                } else {
                    // Mercado Pago
                    const btn = document.querySelector('.btn-mp'); 
                    try {
                        localStorage.setItem('2a_cart', JSON.stringify(state.cart));
                        const items = state.cart.map(i => ({name: `${i.name} - ${i.variant}`, price: i.price, qty: i.qty}));
                        const res = await fetch(GOOGLE_CLOUD_URL, {
                            method:'POST', headers:{'Content-Type':'application/json'}, 
                            body:JSON.stringify({items, address: state.user.address})
                        });
                        const data = await res.json();
                        if(data.init_point) window.location.href = data.init_point;
                    } catch(e) { alert("Erro conex√£o MP"); }
                }
            },
            registerOrder: async (method) => {
                const total = state.cart.reduce((a,b)=>a+(b.price*b.qty),0);
                const order = {
                    id: Date.now().toString(),
                    customer_name: state.user.name,
                    customer_email: state.user.email,
                    total: total,
                    items: state.cart,
                    address: state.user.address,
                    date: new Date().toLocaleDateString(),
                    method: method
                };
                await sb.from('orders').insert([order]);
            },
            sendPaidOrder: () => {
                let msg = `*PEDIDO 2A MODAS (${state.user.name})*\n\nEndere√ßo: ${state.user.address.street}, ${state.user.address.bairro}\nTel: ${state.user.address.phone}\n\nITENS:\n`;
                let t=0;
                state.cart.forEach(i=>{ msg+=`‚ñ™ ${i.name} (${i.variant}) x${i.qty}\n`; t+=i.price*i.qty; });
                msg+=`\n*TOTAL: R$ ${t.toFixed(2)}*`;
                localStorage.removeItem('2a_cart');
                window.location.href = `https://wa.me/5567998951120?text=${encodeURIComponent(msg)}`;
            }
        };

        // --- ADMIN ---
        const admin = {
            initCheckboxes: () => {
                const cDiv = document.getElementById('color-checks');
                const vDiv = document.getElementById('volume-checks');
                PRESETS.colors.forEach(c => cDiv.innerHTML += `<label class="check-label"><input type="checkbox" value="${c}" onchange="admin.toggleInput(this)"> ${c}</label>`);
                PRESETS.vols.forEach(v => vDiv.innerHTML += `<label class="check-label"><input type="checkbox" value="${v}" onchange="admin.toggleInput(this)"> ${v}</label>`);
            },
            toggleInput: (cb) => {
                const id = `grp-${cb.value.replace(/[^a-z0-9]/gi,'')}`;
                const area = document.getElementById('active-vars-area');
                if(cb.checked) {
                    area.innerHTML += `<div id="${id}" class="var-inputs show"><strong style="grid-column:span 2">${cb.value}</strong><input type="hidden" class="v-name" value="${cb.value}"><input type="number" class="input v-price" placeholder="Pre√ßo"><input type="number" class="input v-stock" placeholder="Estoque"></div>`;
                } else { document.getElementById(id)?.remove(); }
            },
            checkAdmin: () => {
                const pass = prompt("Senha Admin:");
                if(pass === "123") {
                    document.getElementById('auth-modal').classList.remove('active');
                    document.getElementById('admin-modal').classList.add('active');
                    admin.updateStats();
                    admin.renderOrders();
                    admin.renderList();
                }
            },
            tab: (t) => {
                document.getElementById('tab-dash').style.display=t==='dash'?'block':'none';
                document.getElementById('tab-orders').style.display=t==='orders'?'block':'none';
                document.getElementById('tab-prod').style.display=t==='prod'?'block':'none';
            },
            save: async () => {
                const btn = document.getElementById('btn-save'); btn.innerText="Salvando..."; btn.disabled=true;
                const vars = [];
                document.querySelectorAll('.var-inputs').forEach(d => {
                    vars.push({ name: d.querySelector('.v-name').value, price: d.querySelector('.v-price').value, stock: d.querySelector('.v-stock').value });
                });
                
                const file = document.getElementById('f-file').files[0];
                let imgUrl = null;
                if(file) {
                    const fName = `prod_${Date.now()}_${Math.floor(Math.random()*1000)}`;
                    const { data } = await sb.storage.from('images').upload(fName, file);
                    const { data: url } = sb.storage.from('images').getPublicUrl(fName);
                    imgUrl = url.publicUrl;
                }

                const payload = {
                    name: document.getElementById('f-name').value,
                    category: document.getElementById('f-cat').value,
                    cost_price: document.getElementById('f-cost').value,
                    description: document.getElementById('f-desc').value,
                    is_promo: document.getElementById('f-promo').checked,
                    variations: vars
                };
                if(imgUrl) payload.image_url = imgUrl; else if(!document.getElementById('edit-id').value) payload.image_url = "https://via.placeholder.com/300";

                const eid = document.getElementById('edit-id').value;
                if(eid) await sb.from('products').update(payload).eq('id', eid);
                else { payload.id = Date.now(); await sb.from('products').insert([payload]); }
                
                alert("Salvo!"); admin.clear(); location.reload();
            },
            edit: (id) => {
                const p = state.products.find(x => String(x.id) === String(id));
                document.getElementById('edit-id').value = p.id;
                document.getElementById('f-name').value = p.name;
                document.getElementById('f-cat').value = p.category;
                document.getElementById('f-cost').value = p.cost_price;
                document.getElementById('f-desc').value = p.description;
                document.getElementById('f-promo').checked = p.is_promo;
                
                // Repopulate logic simplified for brevity: User must re-check variations on edit in this version or expand logic to auto-check checkboxes based on JSON.
                alert("Edi√ß√£o carregada. Por favor, recadastre as varia√ß√µes.");
            },
            del: async (id) => { if(confirm("Excluir?")) { await sb.from('products').delete().eq('id', id); location.reload(); } },
            clear: () => { location.reload(); },
            
            renderOrders: async () => {
                const { data } = await sb.from('orders').select('*');
                const tb = document.getElementById('orders-table-body'); tb.innerHTML="";
                data.forEach(o => {
                    const items = o.items.map(i=>`${i.name} (${i.qty})`).join(', ');
                    tb.innerHTML += `<tr><td>${o.date}</td><td>${o.customer_name}</td><td>R$ ${o.total.toFixed(2)}</td><td><small>${items}</small></td></tr>`;
                });
            },
            renderList: () => {
                const div = document.getElementById('admin-list'); div.innerHTML="";
                state.products.forEach(p => {
                    div.innerHTML += `<div style="display:flex; justify-content:space-between; padding:10px; border-bottom:1px solid #eee;">
                        <div style="display:flex; gap:10px; align-items:center;">
                            <img src="${p.image_url}" style="width:40px; height:40px; object-fit:cover; border-radius:5px;">
                            <strong>${p.name}</strong>
                        </div>
                        <div>
                            <button onclick="admin.edit('${p.id}')" style="color:blue; border:none; background:none; margin-right:10px;"><i class="fas fa-edit"></i></button>
                            <button onclick="admin.del('${p.id}')" style="color:red; border:none; background:none;"><i class="fas fa-trash"></i></button>
                        </div>
                    </div>`;
                });
            },
            updateStats: () => {
                let cost=0, rev=0;
                let miniList = "";
                state.products.forEach(p => {
                    const vars = typeof p.variations === 'string' ? JSON.parse(p.variations) : p.variations;
                    let stock = 0, pRev = 0;
                    vars.forEach(v => {
                        let q = parseInt(v.stock)||0;
                        cost += (p.cost_price * q);
                        rev += (v.price * q);
                        pRev += (v.price * q);
                        stock += q;
                    });
                    miniList += `<div class="mini-prod"><img src="${p.image_url}"> <div><strong>${p.name}</strong><br><small>Estoque: ${stock} | Venda Potencial: R$ ${pRev.toFixed(2)}</small></div></div>`;
                });
                document.getElementById('st-cost').innerText = `R$ ${cost.toFixed(2)}`;
                document.getElementById('st-rev').innerText = `R$ ${rev.toFixed(2)}`;
                document.getElementById('st-profit').innerText = `R$ ${(rev-cost).toFixed(2)}`;
                document.getElementById('mini-prod-list').innerHTML = miniList;
            }
        };
    </script>
</body>
</html>
