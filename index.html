<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>2A Modas e Perfumes | Loja Oficial</title>
    
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/@emailjs/browser@3/dist/email.min.js"></script>
    <script src="https://unpkg.com/imask"></script> 
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;600;700;800&family=Playfair+Display:wght@700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        :root {
            --primary: #c48b78; --accent: #2c3e50; --bg: #f8f9fa; --white: #ffffff;
            --radius: 12px; --shadow: 0 10px 40px rgba(0,0,0,0.08);
        }
        * { margin:0; padding:0; box-sizing:border-box; outline:none; font-family:'Plus Jakarta Sans', sans-serif; -webkit-tap-highlight-color: transparent; }
        body { background: var(--bg); color: var(--accent); overflow-x: hidden; display: flex; flex-direction: column; min-height: 100vh; }
        
        h1, .brand-font { font-family:'Plus Jakarta Sans', sans-serif; font-weight: 800; letter-spacing: -0.5px; }
        button { cursor:pointer; transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1); user-select: none; }

        /* LOADING */
        #loading-screen { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: white; z-index: 99999; display: flex; flex-direction: column; align-items: center; justify-content: center; }
        
        /* HEADER */
        .header-floating { position: fixed; top: 20px; right: 5%; z-index: 1000; display:flex; gap:10px; align-items: center; }
        .icon-btn { width:45px; height:45px; border-radius:50%; border:none; background:white; box-shadow:0 4px 15px rgba(0,0,0,0.15); color:var(--accent); font-size:1.1rem; display:flex; align-items:center; justify-content:center; position:relative; }
        .icon-btn:active { transform:scale(0.95); }
        .badge { position:absolute; top:-5px; right:-5px; background:var(--accent); color:white; width:20px; height:20px; border-radius:50%; font-size:0.7rem; display:flex; align-items:center; justify-content:center; font-weight:bold; border:2px solid white; }
        
        .login-btn-header { padding: 0 20px; height: 45px; background: white; border: none; border-radius: 30px; font-weight: 700; color: var(--accent); box-shadow: 0 4px 15px rgba(0,0,0,0.15); display: flex; align-items: center; gap: 8px; font-size: 0.85rem; overflow: hidden; max-width: 200px; white-space: nowrap; text-overflow: ellipsis; cursor: pointer; }
        .login-btn-header:hover { transform: translateY(-2px); }

        /* HERO & GRID */
        .hero { padding: 100px 20px 40px; text-align:center; background: radial-gradient(circle at top, #fff5f2 0%, transparent 100%); display: flex; flex-direction: column; align-items: center; }
        .hero img { width:140px; height:140px; border-radius:50%; object-fit:cover; border:4px solid white; box-shadow:var(--shadow); margin-bottom:15px; }
        .hero h1 { font-size:2.5rem; margin-bottom:5px; color:var(--accent); line-height: 1.1; }
        .btn-cta { padding: 14px 40px; background: var(--accent); color: white; border-radius: 50px; border: none; font-weight: 700; font-size: 1rem; box-shadow: 0 10px 25px rgba(44,62,80,0.25); margin-top: 30px; animation: pulse 2s infinite; }
        @keyframes pulse { 0% { transform: scale(1); } 50% { transform: scale(1.05); } 100% { transform: scale(1); } }

        .container { max-width:1200px; margin:0 auto; padding:20px; flex: 1; }
        .filters { display:flex; justify-content:center; gap:8px; margin-bottom:30px; flex-wrap:wrap; }
        .filter-btn { padding: 8px 20px; border-radius: 30px; border: 1px solid #e0e0e0; background: white; color: #555; font-weight: 600; font-size: 0.9rem; }
        .filter-btn.active { background: var(--accent); color: white; border-color: var(--accent); }

        .grid { display:grid; grid-template-columns:repeat(auto-fill, minmax(150px, 1fr)); gap:15px; }
        .card { background:white; border-radius:var(--radius); overflow:hidden; border:1px solid #f0f0f0; position:relative; cursor:pointer; box-shadow: 0 2px 10px rgba(0,0,0,0.02); }
        .card img { width:100%; height:200px; object-fit:cover; background:#f9f9f9; }
        .card-info { padding:12px; text-align:center; }
        .tag-promo { position:absolute; top:8px; right:8px; background:#e91e63; color:white; padding:3px 8px; border-radius:20px; font-size:0.6rem; font-weight:bold; z-index: 2; }

        /* MODALS & SIDEBAR */
        .overlay { position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.85); backdrop-filter:blur(5px); z-index:2000; display:none; align-items:center; justify-content:center; padding:15px; }
        .overlay.active { display:flex; animation: popIn 0.2s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
        @keyframes popIn { from{transform:scale(0.95); opacity:0;} to{transform:scale(1); opacity:1;} }
        
        .box { background:white; width:100%; max-width:900px; border-radius:15px; overflow:hidden; max-height:95vh; overflow-y:auto; display:grid; grid-template-columns:1fr 1fr; box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5); }
        .box.single-col { display:block; max-width:500px; grid-template-columns: 1fr; }
        
        .sidebar { position:fixed; top:0; right:-100%; width:85%; max-width:400px; height:100%; background:white; z-index:3000; padding:25px; box-shadow:-10px 0 50px rgba(0,0,0,0.2); transition:0.3s; display:flex; flex-direction:column; }
        .sidebar.open { right:0; }
        
        /* CART & ADMIN UI */
        .cart-item { display:grid; grid-template-columns: 60px 1fr auto; gap:10px; align-items:center; padding:15px 0; border-bottom:1px solid #f5f5f5; }
        .cart-thumb { width:60px; height:60px; border-radius:8px; object-fit:cover; background:#f9f9f9; }
        .qty-controls { display:flex; align-items:center; background:#f4f4f4; border-radius:25px; padding:2px; width:fit-content; margin-top:5px; }
        .qty-btn { width:25px; height:25px; border-radius:50%; border:none; background:white; color:var(--accent); font-weight:bold; box-shadow:0 1px 3px rgba(0,0,0,0.1); display:flex; align-items:center; justify-content:center; }
        .qty-val { padding:0 10px; font-size:0.85rem; font-weight:600; min-width:25px; text-align:center; }
        .btn-remove { width:30px; height:30px; border-radius:50%; border:none; background:#fff5f5; color:#e74c3c; display:flex; align-items:center; justify-content:center; }
        
        .input { width:100%; padding:14px; border:1px solid #e0e0e0; border-radius:10px; font-size:1rem; margin-bottom:12px; background: #fdfdfd; transition: 0.3s; }
        .input:focus { border-color: var(--primary); background: white; box-shadow: 0 0 0 3px rgba(196, 139, 120, 0.1); }
        
        .admin-nav { padding:15px; background:white; border-bottom:1px solid #eee; display:flex; gap:10px; overflow-x:auto; white-space: nowrap; -webkit-overflow-scrolling: touch; }
        .admin-tab { padding:10px 20px; border-radius:30px; border:1px solid #eee; background:transparent; font-weight:600; cursor:pointer; color: #777; transition: all 0.3s; }
        .admin-tab.active { background:var(--accent); color:white; border-color: var(--accent); box-shadow: 0 4px 10px rgba(44,62,80,0.3); }

        .checkbox-wrapper { display: flex; flex-wrap: wrap; gap: 8px; margin-bottom: 15px; }
        .modern-checkbox input { display: none; }
        .variation-chip { display: flex; align-items: center; gap: 8px; padding: 10px 20px; border: 1px solid #eee; border-radius: 50px; cursor: pointer; transition: 0.2s cubic-bezier(0.25, 0.8, 0.25, 1); font-weight: 600; color: #555; background: white; user-select: none; font-size: 0.9rem; }
        .modern-checkbox input:checked + .variation-chip { background: var(--accent); color: white; border-color: var(--accent); box-shadow: 0 4px 12px rgba(44,62,80,0.25); transform: translateY(-2px); }
        .color-preview { width: 14px; height: 14px; border-radius: 50%; border: 1px solid rgba(0,0,0,0.1); display: inline-block; }
        
        .var-inputs { display:none; background:#f8f9fa; border:1px solid #eee; padding:15px; border-radius:12px; margin-top:10px; animation: slideDown 0.3s ease; }
        .var-inputs.show { display:grid; grid-template-columns:1fr 1fr 1fr; gap:10px; }
        @keyframes slideDown { from{opacity:0;transform:translateY(-10px);} to{opacity:1;transform:translateY(0);} }

        .admin-section-title { font-size: 0.9rem; text-transform: uppercase; color: #999; font-weight: 700; margin: 20px 0 10px; letter-spacing: 1px; }
        .mini-prod { display:flex; align-items:center; gap:12px; padding:12px; border-bottom:1px solid #eee; background: #fff; margin-bottom: 5px; border-radius: 8px; }
        .mini-prod img { width:50px; height:50px; border-radius:8px; object-fit:cover; border: 1px solid #eee; }
        .stock-info { font-size: 0.8rem; color: #666; margin-top: 2px; }
        .stock-warn { color: #e74c3c; font-weight: bold; }
        .btn-mini-edit { background: var(--accent); color: white; padding: 6px 14px; border-radius: 20px; font-size: 0.8rem; border: none; }
        
        .var-btn { padding:12px; border:1px solid #eee; border-radius:8px; background:white; margin:4px; cursor:pointer; font-size: 0.9rem; }
        .var-btn.selected { background:var(--accent); color:white; border-color: var(--accent); }
        .var-btn.disabled { opacity:0.5; cursor:not-allowed; }
        
        .btn-mp, .btn-whats { width:100%; padding:16px; border-radius:12px; border:none; font-weight:bold; margin-top:10px; color:white; display:flex; align-items:center; justify-content:center; gap:10px; font-size: 1rem; }
        .btn-mp { background:#009EE3; } .btn-whats { background:#25D366; }
        
        .btn-addr-trigger { width:100%; padding:15px; border:2px dashed var(--accent); background:none; border-radius:12px; color:var(--accent); font-weight:bold; cursor:pointer; margin-bottom:15px; display:flex; align-items:center; justify-content:center; gap:10px; }
        .btn-addr-trigger.filled { border-style:solid; border-color:#27ae60; background:#eafff0; color:#27ae60; }
        
        footer { background: #222; color: #888; text-align: center; padding: 40px 20px; margin-top: auto; }
        footer button { color: #ddd; text-decoration: none; font-size: 0.9rem; font-weight: bold; border: 1px solid #444; padding: 10px 20px; border-radius: 20px; transition: 0.3s; cursor: pointer; background: transparent; }
        footer button:hover { background: #444; color: white; }

        /* ENDERE√áO POPUP */
        #address-modal { z-index: 10005; background: rgba(0,0,0,0.9); }

        @media(max-width:768px){ 
            .box{grid-template-columns:1fr; border-radius: 0; height: 100%; max-height: 100vh; } 
            .hero { padding-top: 90px; }
            .hero h1 { font-size: 2rem; }
            .admin-nav { justify-content: flex-start; }
            .grid { gap: 10px; }
            .var-inputs.show { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body>

    <div id="loading-screen">
        <i class="fas fa-circle-notch fa-spin fa-3x" style="color:var(--primary);"></i>
        <p style="margin-top:15px; color:#666;">Carregando loja...</p>
    </div>

    <div class="header-floating">
        <button class="login-btn-header" onclick="auth.checkProfile()" id="btn-login-display">
            <i class="fas fa-user-circle"></i> Login
        </button>
        <button class="icon-btn" onclick="app.toggleCart()">
            <i class="fas fa-shopping-bag"></i><span class="badge" id="cart-count">0</span>
        </button>
    </div>

    <div class="hero">
        <img src="logo.jpg" onerror="this.src='https://via.placeholder.com/200?text=2A'">
        <h1 class="brand-font">2A Modas e Perfumes</h1>
        <p>Eleg√¢ncia que transforma. Descubra sua ess√™ncia.</p>
        <button class="btn-cta btn-pulse" onclick="app.openPromoModal()">‚ú® Ver Promo√ß√µes</button>
    </div>

    <div class="container" id="vitrine">
        <div class="filters">
            <button class="filter-btn active" onclick="app.filter('all', this)">Todos</button>
            <button class="filter-btn" onclick="app.filter('feminino', this)">Feminino</button>
            <button class="filter-btn" onclick="app.filter('infantil', this)">Infantil</button>
            <button class="filter-btn" onclick="app.filter('perfumes', this)">Perfumes</button>
        </div>
        <div id="products-list" class="grid"></div>
    </div>

    <footer>
        <p class="brand-font">&copy; 2025 2A Modas e Perfumes.</p>
        <br>
        <button onclick="app.showModal('admin-login-modal')">Acessar √Årea Administrativa</button>
    </footer>

    <div id="promo-modal" class="overlay">
        <div class="box single-col" style="background:var(--bg); overflow:hidden; height:auto; max-height:80vh;">
            <div style="padding:20px; display:flex; justify-content:space-between; align-items:center; border-bottom:1px solid #eee;">
                <h3>üî• Ofertas Especiais</h3>
                <button onclick="app.closeModal('promo-modal')" style="border:none; background:none; font-size:1.5rem;">&times;</button>
            </div>
            <div class="carousel-wrapper"><div id="promo-track" class="carousel-track"></div></div>
        </div>
    </div>

    <div id="product-modal" class="overlay">
        <div class="box">
            <img id="m-img" style="width:100%; height:300px; object-fit:cover; background:#f0f0f0;">
            <div style="padding:25px; position:relative; overflow-y: auto;">
                <button onclick="app.closeModal('product-modal')" style="position:absolute; top:15px; right:15px; border:none; background:white; width:40px; height:40px; border-radius:50%; box-shadow:0 2px 10px rgba(0,0,0,0.1); font-size:1.5rem; color:#999;">&times;</button>
                <small id="m-cat" style="color:var(--primary); font-weight:700; text-transform:uppercase;">Categoria</small>
                <h2 id="m-title" style="margin:5px 0 15px;"></h2>
                <h3 id="m-price" style="color:var(--accent); margin-bottom:15px;"></h3>
                <p id="m-desc" style="color:#666; margin-bottom:20px; font-size:0.95rem;"></p>
                <div style="margin-bottom:20px; color:#27ae60; font-weight:600;"><i class="fas fa-truck"></i> Prazo de entrega: 03 a 05 dias √∫teis</div>
                <div id="m-vars" style="display:flex; flex-wrap:wrap; gap:10px; margin-bottom:30px;"></div>
                <div style="display:flex; align-items:center; gap:15px; margin-bottom:25px;">
                    <span style="font-weight:bold;">Qtd:</span>
                    <div style="border:1px solid #ddd; border-radius:8px; display:flex;">
                        <button onclick="app.updQty(-1)" style="padding:10px 15px; border:none; background:white;">-</button>
                        <span id="m-qty" style="padding:10px 15px; font-weight:bold;">1</span>
                        <button onclick="app.updQty(1)" style="padding:10px 15px; border:none; background:white;">+</button>
                    </div>
                </div>
                <button onclick="app.addCart()" style="width:100%; background:var(--accent); color:white; padding:18px; border-radius:12px; border:none; font-weight:bold; font-size:1rem;">Adicionar √† Sacola</button>
            </div>
        </div>
    </div>

    <div id="address-modal" class="overlay" style="justify-content:flex-start; padding-left:0; z-index:10001; align-items: flex-end;">
        <div class="box single-col" style="width:100%; max-width:100%; height:85vh; border-radius: 20px 20px 0 0;">
            <div style="padding:25px; padding-bottom: 80px;">
                <h3>üìç Onde entregar?</h3>
                <div id="saved-addresses-list" style="margin-bottom:20px; max-height:150px; overflow-y:auto;"></div>
                
                <div style="background:#f9f9f9; padding:15px; border-radius:10px;">
                    <h4>Novo Endere√ßo</h4>
                    <input type="text" id="addr-cep" class="input" placeholder="CEP (00000-000)" onblur="app.fetchCep(this.value)">
                    <div style="display:flex; gap:10px;">
                        <input type="text" id="addr-street" class="input" placeholder="Rua" style="flex:2">
                        <input type="text" id="addr-num" class="input" placeholder="N¬∫" style="flex:1">
                    </div>
                    <input type="text" id="addr-dist" class="input" placeholder="Bairro">
                    <div style="display:flex; gap:10px;">
                        <input type="text" id="addr-city" class="input" placeholder="Cidade" style="flex:2">
                        <select id="addr-state" class="input" style="flex:1"><option value="">UF</option></select>
                    </div>
                    <input type="text" id="addr-ref" class="input" placeholder="Refer√™ncia">
                    <input type="text" id="addr-name" class="input" placeholder="Nome de quem recebe">
                    <input type="text" id="addr-phone" class="input" placeholder="WhatsApp">
                    <label style="display:block; margin:10px 0; font-weight:bold;">Salvar como:</label>
                    <select id="addr-type" class="input"><option value="Casa">Casa</option><option value="Trabalho">Trabalho</option><option value="Outro">Outro</option></select>
                    <button onclick="app.addNewAddress()" style="width:100%; background:var(--primary); color:white; padding:15px; border-radius:12px; border:none; font-weight:bold;">Salvar Endere√ßo</button>
                </div>
                <button onclick="app.closeModal('address-modal')" style="width:100%; margin-top:15px; padding:15px; background:none; border:none; color:#666; font-size:1rem;">Fechar</button>
            </div>
        </div>
    </div>

    <div id="client-modal" class="overlay">
        <div class="box single-col" style="max-width:600px;">
            <div style="padding:25px; height: 100%; overflow-y: auto;">
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
                    <h2>Minha Conta</h2>
                    <button onclick="app.closeModal('client-modal')" style="border:none; background:none; font-size:1.5rem;">&times;</button>
                </div>
                <div style="background:#f9f9f9; padding:20px; border-radius:12px; margin-bottom:20px;">
                    <h4>Meus Dados</h4>
                    <p id="client-info-txt" style="color:#666; font-size:0.95rem; line-height:1.6; margin-bottom:15px;"></p>
                    <button onclick="auth.logout()" style="border:1px solid #ccc; background:white; padding:8px 20px; border-radius:20px; font-size:0.9rem;">Sair da Conta</button>
                </div>
                <h3>Meus Pedidos</h3>
                <div id="client-orders-list" style="padding-bottom: 20px;"></div>
            </div>
        </div>
    </div>

    <div class="sidebar">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px; border-bottom:1px solid #eee; padding-bottom:10px;">
            <h2 style="margin:0;">Sua Sacola</h2>
            <button onclick="app.toggleCart()" style="border:none; background:none; font-size:1.5rem; color:#999;">&times;</button>
        </div>
        <div style="background:#eafff0; color:#27ae60; padding:10px; border-radius:8px; font-size:0.8rem; margin-bottom:15px; text-align:center;">
            <i class="fas fa-clock"></i> Entrega: 03 a 05 dias √∫teis
        </div>
        <div style="flex:1; overflow-y:auto;">
            <ul id="cart-list" style="list-style:none;"></ul>
        </div>
        <div style="border-top:1px solid #eee; padding-top:20px;">
            <div id="cart-auth-area" style="margin-bottom:15px;">
                <button onclick="app.showModal('auth-modal')" style="width:100%; padding:10px; background:#f0f0f0; border:none; border-radius:8px; color:#555; font-weight:bold;">
                    <i class="fas fa-user-circle"></i> Fazer Login / Cadastro
                </button>
            </div>
            <button id="btn-address-trigger" onclick="app.openAddressModal()" class="btn-addr-trigger">
                <i class="fas fa-map-marker-alt"></i> Cadastrar local de entrega
            </button>
            <div style="display:flex; justify-content:space-between; font-weight:bold; margin-bottom:15px; font-size:1.2rem;">
                <span>Total</span> <span id="cart-total">R$ 0.00</span>
            </div>
            <button onclick="app.checkout('whatsapp')" class="btn-whats btn-pulse"><i class="fab fa-whatsapp"></i> Falar Via WhatsApp</button>
            <button onclick="app.checkout('mercadopago')" class="btn-mp btn-pulse">Via Pix/Cart√£o/D√©bito</button>
        </div>
    </div>

    <div id="auth-modal" class="overlay" style="z-index:10002;">
        <div class="box single-col" style="padding:30px; text-align:center; max-width:400px; height: auto;">
            <h2 id="auth-title" style="margin-bottom:20px;">Acesso</h2>
            <div id="form-login">
                <input type="email" id="l-email" class="input" placeholder="E-mail">
                <input type="password" id="l-pass" class="input" placeholder="Senha">
                <button onclick="auth.login()" style="width:100%; background:var(--accent); color:white; padding:15px; border-radius:8px; border:none; font-weight:bold; font-size:1rem;">Entrar</button>
                <p style="margin-top:20px; font-size:0.9rem;">N√£o tem conta? <a href="#" onclick="auth.toggle('register')" style="color:var(--primary); font-weight:bold;">Cadastre-se</a></p>
            </div>
            <div id="form-register" style="display:none;">
                <input type="text" id="r-name" class="input" placeholder="Nome">
                <input type="email" id="r-email" class="input" placeholder="E-mail">
                <input type="password" id="r-pass" class="input" placeholder="Senha">
                <button onclick="auth.register()" style="width:100%; background:var(--primary); color:white; padding:15px; border-radius:8px; border:none; font-weight:bold; font-size:1rem;">Cadastrar</button>
                <p style="margin-top:20px; font-size:0.9rem;"><a href="#" onclick="auth.toggle('login')" style="color:var(--accent);">Voltar</a></p>
            </div>
            <button onclick="app.closeModal('auth-modal')" style="position:absolute; top:15px; right:15px; border:none; background:none; font-size:1.5rem;">&times;</button>
        </div>
    </div>

    <div id="admin-login-modal" class="overlay" style="z-index:10005;">
        <div class="box single-col" style="padding:30px; text-align:center; max-width:350px; height: auto;">
            <h3>Acesso Administrativo</h3>
            <p style="color:#666; margin-bottom:20px;">√Årea restrita</p>
            <input type="password" id="admin-pass-input" class="input" placeholder="Senha Admin" style="text-align:center;">
            <button onclick="admin.checkAdmin()" style="width:100%; background:var(--accent); color:white; padding:15px; border-radius:8px; border:none; font-weight:bold;">Acessar</button>
            <button onclick="app.closeModal('admin-login-modal')" style="margin-top:15px; border:none; background:none; color:#666;">Cancelar</button>
        </div>
    </div>

    <div id="admin-modal" class="overlay" style="z-index:2001; background:#f4f6f9; align-items:flex-start; padding:0;">
        <div class="box" style="max-width:100%; height:100%; border-radius:0; padding:0; display:flex; flex-direction:column;">
            <div class="admin-nav">
                <h3 style="margin-right:20px; align-self: center;">Admin</h3>
                <button onclick="admin.tab('dash')" class="admin-tab active">Dashboard</button>
                <button onclick="admin.tab('orders')" class="admin-tab">Pedidos</button>
                <button onclick="admin.tab('prod')" class="admin-tab">Produtos</button>
                <button onclick="app.closeModal('admin-modal')" style="background:#e74c3c; color:white; border:none; padding:8px 20px; border-radius:20px; margin-left:auto;">Sair</button>
            </div>
            <div style="flex:1; overflow-y:auto; padding:20px; width:100%; max-width:1200px; margin:0 auto;">
                
                <div id="tab-dash">
                    <div style="display:grid; grid-template-columns:repeat(auto-fit, minmax(150px, 1fr)); gap:15px; margin-bottom:30px;">
                        <div style="background:white; padding:20px; border-radius:12px; text-align:center; box-shadow:var(--shadow);">
                            <div style="color:#27ae60; font-weight:bold; font-size:0.8rem;">LUCRO PREVISTO</div>
                            <div class="stat-val" id="st-profit" style="font-size:1.2rem; font-weight:bold;">R$ 0.00</div>
                        </div>
                        <div style="background:white; padding:20px; border-radius:12px; text-align:center; box-shadow:var(--shadow);">
                            <div style="color:#e74c3c; font-weight:bold; font-size:0.8rem;">CUSTO ESTOQUE</div>
                            <div class="stat-val" id="st-cost" style="font-size:1.2rem; font-weight:bold;">R$ 0.00</div>
                        </div>
                        <div style="background:white; padding:20px; border-radius:12px; text-align:center; box-shadow:var(--shadow);">
                            <div style="color:#2980b9; font-weight:bold; font-size:0.8rem;">VENDA POTENCIAL</div>
                            <div class="stat-val" id="st-rev" style="font-size:1.2rem; font-weight:bold;">R$ 0.00</div>
                        </div>
                    </div>
                    <div style="background:white; padding:20px; border-radius:12px; box-shadow:var(--shadow);">
                        <h4>Estoque & Produtos</h4>
                        <div id="mini-prod-list" style="margin-top:15px;">Carregando...</div>
                    </div>
                </div>

                <div id="tab-orders" style="display:none;">
                    <div style="background:white; padding:20px; border-radius:12px; box-shadow:var(--shadow);">
                        <h3>Hist√≥rico de Compras</h3>
                        <div id="orders-list"></div>
                    </div>
                </div>

                <div id="tab-prod" style="display:none;">
                    <div style="background:white; padding:25px; border-radius:12px; margin-bottom:20px; box-shadow:var(--shadow);">
                        <h3>Cadastro de Produto</h3>
                        <input type="hidden" id="edit-id">
                        
                        <div class="admin-section-title">Informa√ß√µes B√°sicas</div>
                        <input type="text" id="f-name" class="input" placeholder="Nome do Produto">
                        <div style="display:flex; gap:10px; flex-wrap:wrap;">
                            <select id="f-cat" class="input" style="flex:1;"><option value="feminino">Feminino</option><option value="infantil">Infantil</option><option value="perfumes">Perfumes</option></select>
                            <input type="number" id="f-cost" class="input" placeholder="Custo Global (Opcional)" style="flex:1;">
                        </div>
                        
                        <label style="display:flex; align-items:center; gap:10px; margin-bottom:10px; font-weight:600;">
                            <input type="checkbox" id="f-promo" style="transform:scale(1.5);"> Produto em Promo√ß√£o?
                        </label>
                        <input type="file" id="f-file" class="input">
                        
                        <div class="admin-section-title">Varia√ß√µes (Cores e Tamanhos)</div>
                        <div class="checkbox-wrapper" id="color-checks"></div>
                        <div class="checkbox-wrapper" id="volume-checks"></div>
                        
                        <div id="active-vars-area"></div>
                        
                        <div class="admin-section-title">Descri√ß√£o</div>
                        <textarea id="f-desc" class="input" rows="3" placeholder="Detalhes do produto..."></textarea>
                        
                        <button onclick="admin.save()" id="btn-save" style="width:100%; background:var(--primary); color:white; padding:15px; border-radius:8px; border:none; margin-top:15px; font-weight:bold; font-size:1rem;">Salvar Produto</button>
                        <button onclick="admin.clear()" style="width:100%; padding:15px; background:none; border:none; color:#666;">Cancelar / Limpar</button>
                    </div>
                    <div style="background:white; padding:25px; border-radius:12px; box-shadow:var(--shadow);">
                        <h3>Produtos Cadastrados</h3>
                        <div id="admin-list"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // --- ‚ö†Ô∏è CONFIGURA√á√ÉO OBRIGAT√ìRIA (COLE SUAS CHAVES ABAIXO) ---
        const SUPABASE_URL = 'https://sdeslwemzhxqixmphyye.supabase.co'; 
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InNkZXNsd2Vtemh4cWl4bXBoeXllIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjY3MDUxNDUsImV4cCI6MjA4MjI4MTE0NX0.QK7PkbYOnT6nIRFZHtHsuh42EuCjMSVvdnxf7h1bD80';
        const GOOGLE_CLOUD_URL = 'https://criarpagamentoss-967029810770.southamerica-east1.run.app'; 

        
        // --- EMAILJS CONFIG ---
        const EMAILJS_PUBLIC_KEY = 'vEXIgVw6GynR5W1qj'; 
        const EMAILJS_SERVICE_ID = 'service_3x4ghcd';
        const EMAILJS_TEMPLATE_CLIENTE = 'template_rwf0bay';
        const EMAILJS_TEMPLATE_ADMIN = 'template_rwf0bay';

        const sb = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
        const state = { products: [], cart: [], current: null, var: null, qty: 1, user: null, address: null, states: ["AC","AL","AP","AM","BA","CE","DF","ES","GO","MA","MT","MS","MG","PA","PB","PR","PE","PI","RJ","RN","RS","RO","RR","SC","SP","SE","TO"] };
        const PRESETS_VOL = ['25ml','50ml','75ml','100ml','200ml','P','M','G','GG','Unico'];
        const COLOR_MAP = { 'Preto': '#000000', 'Branco': '#ffffff', 'Vermelho': '#e74c3c', 'Azul': '#3498db', 'Rosa': '#e91e63', 'Verde': '#2ecc71', 'Nude': '#e3c0a5', 'Estampado': 'linear-gradient(45deg, red, blue)', 'Bege': '#f5f5dc', 'Amarelo': '#f1c40f', 'Cinza': '#95a5a6' };
        
        // FUN√á√ïES SEGURAS
        const safeVal = (v) => (v === null || v === undefined || v === "null") ? "" : v;
        const setSafe = (id, val) => { const el = document.getElementById(id); if(el) el.innerText = safeVal(val); };

        // --- APP ---
        const app = {
            load: async () => {
                const { data, error } = await sb.from('products').select('*');
                if(!error) { state.products = data || []; app.render(state.products); }
                
                // Preenche estados
                const ufSel = document.getElementById('addr-state');
                if(ufSel && ufSel.options.length <= 1) {
                    state.states.forEach(uf => { const op = document.createElement('option'); op.value=uf; op.text=uf; ufSel.add(op); });
                }
            },
            render: (list) => {
                const div = document.getElementById('products-list'); 
                if(!div) return; div.innerHTML = "";
                if(list.length === 0) div.innerHTML = '<p style="grid-column:1/-1;text-align:center; color:#999">Nenhum produto encontrado.</p>';
                list.forEach(p => {
                    const vars = typeof p.variations === 'string' ? JSON.parse(p.variations) : p.variations;
                    const minP = (vars && vars.length) ? Math.min(...vars.map(v => Number(v.price))) : 0;
                    const isPromo = p.is_promo ? '<span class="tag-promo">OFERTA</span>' : '';
                    div.innerHTML += `<div class="card" onclick="app.openModal('${p.id}')">${isPromo}<img src="${p.image_url}" onerror="this.src='https://via.placeholder.com/300'"><div class="card-info"><div style="font-size:0.8rem;color:#999;text-transform:uppercase;">${p.category}</div><div style="font-weight:bold;margin:5px 0;">${p.name}</div><div style="color:var(--primary);font-weight:bold;">A partir R$ ${minP.toFixed(2)}</div><span class="tag-delivery">üöö 03 a 05 dias</span></div></div>`;
                });
            },
            openPromoModal: () => {
                const promos = state.products.filter(p => p.is_promo);
                if(!promos.length) return alert("Sem promo√ß√µes ativas.");
                const cDiv = document.getElementById('promo-track'); cDiv.innerHTML = "";
                const items = [...promos, ...promos]; 
                items.forEach(p => {
                    const vars = typeof p.variations === 'string' ? JSON.parse(p.variations) : p.variations;
                    const minP = Math.min(...vars.map(v => Number(v.price)));
                    cDiv.innerHTML += `<div class="promo-card" onclick="app.closeModal('promo-modal'); setTimeout(() => app.openModal('${p.id}'), 100)"><img src="${p.image_url}"><div><strong>${p.name}</strong><br><small style="color:var(--primary)">R$ ${minP.toFixed(2)}</small></div></div>`;
                });
                app.showModal('promo-modal');
            },
            openModal: (id) => {
                const p = state.products.find(x => String(x.id) === String(id));
                if(!p) return;
                state.current = p; state.qty=1; state.var=null;
                document.getElementById('m-img').src = p.image_url || "";
                setSafe('m-title', p.name); setSafe('m-cat', p.category); setSafe('m-desc', p.description); setSafe('m-price', "Selecione...");
                
                const vDiv = document.getElementById('m-vars'); vDiv.innerHTML = "";
                const vars = typeof p.variations === 'string' ? JSON.parse(p.variations) : p.variations;
                
                if(vars) {
                    vars.forEach(v => {
                        const btn = document.createElement('button');
                        const hasStock = parseInt(v.stock)>0;
                        btn.className = hasStock ? 'var-btn' : 'var-btn disabled';
                        let dot = "";
                        if(COLOR_MAP[v.name]) dot = `<span class="color-dot" style="background:${COLOR_MAP[v.name]}"></span>`;
                        btn.innerHTML = `${dot}${v.name} - <b>R$ ${parseFloat(v.price).toFixed(2)}</b>`;
                        if(hasStock) {
                            btn.onclick = () => {
                                state.var = v;
                                document.getElementById('m-price').innerText = `R$ ${parseFloat(v.price).toFixed(2)}`;
                                Array.from(vDiv.children).forEach(b=>b.classList.remove('selected'));
                                btn.classList.add('selected');
                            };
                        }
                        vDiv.appendChild(btn);
                    });
                }
                app.showModal('product-modal');
            },
            updQty: (n) => { 
                if (n > 0) {
                    if (!state.var) return alert("Selecione a varia√ß√£o primeiro.");
                    if (state.qty + n > parseInt(state.var.stock)) return alert("Estoque m√°ximo atingido.");
                }
                state.qty += n; 
                if(state.qty<1) state.qty=1; 
                document.getElementById('m-qty').innerText = state.qty; 
            },
            addCart: () => {
                if(!state.var) return alert("Selecione uma op√ß√£o");
                const existingItem = state.cart.find(i => i.name === state.current.name && i.variant === state.var.name);
                const currentCartQty = existingItem ? existingItem.qty : 0;
                if (currentCartQty + state.qty > parseInt(state.var.stock)) {
                    return alert(`Estoque insuficiente. Voc√™ j√° tem ${currentCartQty} no carrinho e o estoque √© ${state.var.stock}.`);
                }
                if(existingItem) { existingItem.qty += state.qty; } else {
                    state.cart.push({name: state.current.name, variant: state.var.name, price: parseFloat(state.var.price), qty: state.qty, image: state.current.image_url});
                }
                app.renderCart(); app.closeModal('product-modal'); app.toggleCart();
            },
            renderCart: () => {
                const ul = document.getElementById('cart-list'); if(!ul) return; ul.innerHTML=""; let t=0;
                state.cart.forEach((i,idx) => {
                    t += i.price*i.qty;
                    ul.innerHTML += `<li class="cart-item"><img src="${i.image || 'https://via.placeholder.com/70'}" class="cart-thumb"><div><b>${i.name}</b><br><small>${i.variant}</small><div class="qty-controls"><button class="qty-btn" onclick="app.cQty(${idx},-1)">-</button><span class="qty-val">${i.qty}</span><button class="qty-btn" onclick="app.cQty(${idx},1)">+</button></div></div><div style="text-align:right">R$ ${(i.price*i.qty).toFixed(2)}<br><button class="btn-remove" onclick="state.cart.splice(${idx},1);app.renderCart()"><i class="fas fa-trash"></i></button></div></li>`;
                });
                document.getElementById('cart-total').innerText = `R$ ${t.toFixed(2)}`;
                document.getElementById('cart-count').innerText = state.cart.length;
            },
            cQty: (idx,n) => { state.cart[idx].qty+=n; if(state.cart[idx].qty<1) state.cart[idx].qty=1; app.renderCart(); },
            toggleCart: () => document.querySelector('.sidebar').classList.toggle('open'),
            
            // ADDRESS & CEP
            openAddressModal: () => {
                const list = JSON.parse(localStorage.getItem('2a_addrs') || '[]');
                const div = document.getElementById('saved-addresses-list'); div.innerHTML="";
                if(list.length === 0) div.innerHTML = "<small style='color:#666'>Nenhum endere√ßo salvo.</small>";
                list.forEach((a,i) => {
                    div.innerHTML += `
                    <div style="border:1px solid #eee; padding:12px; margin-bottom:8px; border-radius:10px; display:flex; justify-content:space-between; align-items:center; background:#fff;">
                        <div onclick="app.setAddr(${i})" style="cursor:pointer; flex:1;">
                            <strong style="color:var(--accent)">${a.type || 'Casa'}</strong><br>
                            <span style="font-size:0.9rem">${a.street}, ${a.num}</span><br>
                            <small style="color:#999">${a.city}-${a.state}</small>
                        </div>
                        <div style="display:flex; gap:15px;">
                            <i class="fas fa-trash" onclick="app.delAddress(${i})" style="color:#e74c3c; cursor:pointer; font-size:1.1rem;"></i>
                        </div>
                    </div>`;
                });
                app.showModal('address-modal');
            },
            fetchCep: async (cep) => {
                const cleanCep = cep.replace(/\D/g, '');
                if(cleanCep.length === 8) {
                    try {
                        const res = await fetch(`https://viacep.com.br/ws/${cleanCep}/json/`);
                        const data = await res.json();
                        if(!data.erro) {
                            document.getElementById('addr-street').value = data.logradouro;
                            document.getElementById('addr-dist').value = data.bairro;
                            document.getElementById('addr-city').value = data.localidade;
                            document.getElementById('addr-state').value = data.uf;
                            document.getElementById('addr-num').focus();
                        } else alert("CEP n√£o encontrado.");
                    } catch(e) { alert("Erro ao buscar CEP."); }
                }
            },
            addNewAddress: () => {
                const val = id => document.getElementById(id).value;
                const a = { 
                    name: val('addr-name'), phone: val('addr-phone'), 
                    cep: val('addr-cep'), street: val('addr-street'), num: val('addr-num'),
                    dist: val('addr-dist'), city: val('addr-city'), state: val('addr-state'),
                    ref: val('addr-ref'), type: document.getElementById('addr-type').value 
                };
                
                if(!a.street || !a.dist) return alert("Preencha o endere√ßo completo (Rua e Bairro obrigat√≥rios)");
                
                const list = JSON.parse(localStorage.getItem('2a_addrs') || '[]'); list.push(a);
                localStorage.setItem('2a_addrs', JSON.stringify(list));
                
                if(state.user) {
                    sb.from('customers').update({ address: list }).eq('id', state.user.id).then();
                }

                state.address = a; localStorage.setItem('2a_active_addr', JSON.stringify(a));
                app.updateUI(); app.closeModal('address-modal');
            },
            delAddress: (i) => {
                const list = JSON.parse(localStorage.getItem('2a_addrs'));
                list.splice(i, 1);
                localStorage.setItem('2a_addrs', JSON.stringify(list));
                if(state.user) sb.from('customers').update({ address: list }).eq('id', state.user.id).then();
                app.openAddressModal();
            },
            setAddr: (i) => {
                const list = JSON.parse(localStorage.getItem('2a_addrs'));
                state.address = list[i]; localStorage.setItem('2a_active_addr', JSON.stringify(state.address));
                app.updateUI(); app.closeModal('address-modal');
            },
            updateUI: () => {
                const btn = document.getElementById('btn-address-trigger');
                if(btn && state.address) { btn.classList.add('filled'); btn.innerHTML = `üìç Entrega: <b>${state.address.type}</b><br><small>${state.address.street}, ${state.address.num}</small>`; }
                
                // ATUALIZA√á√ÉO DO BOT√ÉO DE LOGIN
                const loginBtn = document.getElementById('btn-login-display');
                if(loginBtn) {
                    if(state.user && state.user.name) {
                        const firstName = state.user.name.split(' ')[0];
                        loginBtn.innerHTML = `<i class="fas fa-check-circle" style="color:#27ae60"></i> Ol√°, ${firstName}`;
                    } else {
                        loginBtn.innerHTML = `<i class="fas fa-user-circle"></i> Login`;
                    }
                }
            },

            // CHECKOUT
            checkout: async (method) => {
                if(!state.cart.length) return alert("Carrinho vazio");
                if(method === 'mercadopago' && !state.user) {
                    alert("Para pagar via cart√£o/pix e registrar seu pedido, fa√ßa Login.");
                    app.showModal('auth-modal'); return;
                }
                if(!state.address) { app.openAddressModal(); return alert("Selecione entrega"); }

                const btn = document.querySelector('.btn-mp');
                try {
                    if(btn) btn.innerText = "Processando...";
                    
                    if(method === 'whatsapp') { 
                        const orderData = await app.registerOrder(null, 'WhatsApp / Dinheiro'); 
                        await app.updateStockDatabase(); 
                        await app.sendEmails(orderData); 
                        app.sendPaidOrder('Dinheiro/Combinar'); 
                    } 
                    else {
                        const newOrderId = Date.now().toString();
                        const orderData = await app.registerOrder(newOrderId, 'Mercado Pago (Pendente)');
                        
                        localStorage.setItem('2a_cart', JSON.stringify(state.cart));
                        const items = state.cart.map(i => ({name: `${i.name} - ${i.variant}`, price: i.price, qty: i.qty}));
                        
                        await app.sendEmails(orderData);

                        const res = await fetch(GOOGLE_CLOUD_URL, {
                            method:'POST', headers:{'Content-Type':'application/json'}, 
                            body:JSON.stringify({items, buyer: { email: state.user.email, name: state.user.name }, address: state.address})
                        });
                        const data = await res.json();
                        if(data.init_point) window.location.href = data.init_point;
                        else throw new Error("Falha ao gerar link");
                    }
                } catch(e) {
                    console.error(e);
                    if(confirm("Erro de conex√£o. Finalizar pelo WhatsApp?")) app.sendPaidOrder('Erro MP - Finalizado Whats');
                    if(btn) btn.innerText = "Via Pix/Cart√£o/D√©bito"; 
                }
            },
            sendEmails: async (order) => {
                if(!state.user || !state.user.email) return;
                const itemsTxt = state.cart.map(i => `${i.qty}x ${i.name} (${i.variant}) - R$ ${i.price.toFixed(2)}`).join('\n');
                const total = state.cart.reduce((a,b)=>a+(b.price*b.qty),0).toFixed(2);
                
                const templateParams = {
                    to_name: state.user.name,
                    to_email: state.user.email,
                    message: `\nITENS:\n${itemsTxt}\n\nTOTAL: R$ ${total}\n\nENDERE√áO:\n${state.address.street}, ${state.address.num} - ${state.address.dist}`,
                    admin_email: 'erickveraosilva@gmail.com' 
                };

                if(window.emailjs) {
                    emailjs.send(EMAILJS_SERVICE_ID, EMAILJS_TEMPLATE_CLIENTE, templateParams);
                    const adminParams = {...templateParams, to_email: 'erickveraosilva@gmail.com', to_name: 'Admin 2A'};
                    emailjs.send(EMAILJS_SERVICE_ID, EMAILJS_TEMPLATE_ADMIN, adminParams);
                }
            },
            updateStockDatabase: async () => {
                for (const item of state.cart) {
                    const { data: prod } = await sb.from('products').select('*').eq('name', item.name).single();
                    if(prod) {
                        let vars = typeof prod.variations === 'string' ? JSON.parse(prod.variations) : prod.variations;
                        const targetVar = vars.find(v => v.name === item.variant);
                        if(targetVar) {
                            targetVar.stock = parseInt(targetVar.stock) - item.qty;
                            if(targetVar.stock < 0) targetVar.stock = 0;
                            await sb.from('products').update({ variations: JSON.stringify(vars) }).eq('id', prod.id);
                        }
                    }
                }
            },
            registerOrder: async (oid, method) => {
                const total = state.cart.reduce((a,b)=>a+(b.price*b.qty),0);
                const order = {
                    id: oid || Date.now().toString(),
                    customer_name: state.user ? state.user.name : state.address.name,
                    customer_email: state.user ? state.user.email : 'N√£o logado',
                    customer_id: state.user ? state.user.id : null,
                    total: total,
                    items: state.cart, address: state.address,
                    date: new Date().toLocaleDateString(),
                    method: method, status: 'Pendente'
                };
                await sb.from('orders').insert([order]);
                return order; 
            },
            sendPaidOrder: (paymentType = 'Dinheiro/Outros') => {
                let addr = state.address;
                let msg = `*NOVO PEDIDO (${state.user ? state.user.name : addr.name})*\n----------------\n*PAGAMENTO:* ${paymentType}\n*TOTAL:* R$ ${document.getElementById('cart-total').innerText.replace('R$ ','')}\n\n*ENTREGA:* ${addr.street}, ${addr.num} - ${addr.dist} (${addr.city})\n*REF:* ${addr.ref}\n\n*ITENS:*\n`;
                state.cart.forEach(i=>{ msg += `‚ñ™ ${i.qty}x ${i.name} (${i.variant})\n`; });
                localStorage.removeItem('2a_cart');
                window.location.href = `https://wa.me/5567998951120?text=${encodeURIComponent(msg)}`;
            },

            // UTILS
            showModal: (id) => { document.getElementById(id).classList.add('active'); history.pushState({modal:id}, null, ""); },
            closeModal: (id) => { document.getElementById(id).classList.remove('active'); history.back(); },
            filter: (cat, btn) => {
                document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
                app.render(cat==='all' ? state.products : state.products.filter(p => p.category===cat));
            },

            // ADMIN EDIT / TOGGLES
            initCheckboxes: () => {
                const cDiv = document.getElementById('color-checks');
                const vDiv = document.getElementById('volume-checks');
                if(!cDiv || !vDiv) return;
                cDiv.innerHTML = ""; vDiv.innerHTML = "";
                Object.keys(COLOR_MAP).forEach(c => {
                    cDiv.innerHTML += `<div class="modern-checkbox"><input type="checkbox" id="chk-${c}" value="${c}" onchange="admin.toggleInput(this)"><label class="variation-chip" for="chk-${c}"><span class="color-preview" style="background:${COLOR_MAP[c]}"></span>${c}</label></div>`;
                });
                PRESETS_VOL.forEach(v => {
                    vDiv.innerHTML += `<div class="modern-checkbox"><input type="checkbox" id="chk-${v}" value="${v}" onchange="admin.toggleInput(this)"><label class="variation-chip" for="chk-${v}">${v}</label></div>`;
                });
            },
            toggleInput: (cb) => {
                const id = `grp-${cb.value.replace(/[^a-z0-9]/gi,'')}`;
                const area = document.getElementById('active-vars-area');
                if(cb.checked) {
                    area.innerHTML += `<div id="${id}" class="var-inputs show"><strong style="grid-column:span 3; color:var(--primary);">${cb.value}</strong><input type="hidden" class="v-name" value="${cb.value}"><input type="number" class="input v-cost" placeholder="Custo"><input type="number" class="input v-price" placeholder="Venda"><input type="number" class="input v-stock" placeholder="Estoque"></div>`;
                } else { document.getElementById(id)?.remove(); }
            },
            checkAdmin: () => { 
                const pass = document.getElementById('admin-pass-input').value;
                if(pass === "admin") { 
                    app.closeModal('admin-login-modal'); 
                    app.showModal('admin-modal'); 
                    // Carrega dados DEPOIS de abrir a tela para evitar travar
                    setTimeout(() => { admin.renderList(); admin.renderOrders(); admin.updateStats(); }, 100);
                } else alert("Senha incorreta");
            },
            tab: (t) => {
                document.querySelectorAll('.admin-tab').forEach(el => el.classList.remove('active'));
                event.target.classList.add('active');
                document.getElementById('tab-dash').style.display=t==='dash'?'block':'none';
                document.getElementById('tab-prod').style.display=t==='prod'?'block':'none';
                document.getElementById('tab-orders').style.display=t==='orders'?'block':'none';
            },
            save: async () => {
                const btn = document.getElementById('btn-save'); btn.innerText="Processando..."; btn.disabled=true;
                try {
                    const vars = [];
                    document.querySelectorAll('.var-inputs').forEach(d => {
                        const cost = d.querySelector('.v-cost').value || 0;
                        const p = d.querySelector('.v-price').value, s = d.querySelector('.v-stock').value;
                        if(p && s) vars.push({ name: d.querySelector('.v-name').value, cost: cost, price: p, stock: s });
                    });
                    const file = document.getElementById('f-file').files[0];
                    let imgUrl = null;
                    if(file) {
                        const fName = `prod_${Date.now()}_${Math.floor(Math.random()*1000)}`;
                        const { data } = await sb.storage.from('images').upload(fName, file);
                        const { data: url } = sb.storage.from('images').getPublicUrl(fName);
                        imgUrl = url.publicUrl;
                    }
                    const payload = {
                        name: document.getElementById('f-name').value,
                        category: document.getElementById('f-cat').value,
                        cost_price: document.getElementById('f-cost').value || 0,
                        description: document.getElementById('f-desc').value || "",
                        is_promo: document.getElementById('f-promo').checked,
                        variations: JSON.stringify(vars)
                    };
                    if(imgUrl) payload.image_url = imgUrl; else if(!document.getElementById('edit-id').value) payload.image_url = "https://via.placeholder.com/300";
                    const eid = document.getElementById('edit-id').value;
                    if(eid) await sb.from('products').update(payload).eq('id', eid);
                    else { payload.id = Date.now(); await sb.from('products').insert([payload]); }
                    alert("Salvo!"); admin.clear(); await app.load(); admin.renderList(); admin.updateStats();
                } catch(e) { alert(e.message); } finally { btn.innerText="Salvar Produto"; btn.disabled=false; }
            },
            edit: (id) => {
                const p = state.products.find(x => String(x.id) === String(id));
                document.getElementById('edit-id').value = p.id;
                document.getElementById('f-name').value = safeVal(p.name);
                document.getElementById('f-cat').value = safeVal(p.category);
                document.getElementById('f-cost').value = safeVal(p.cost_price);
                document.getElementById('f-desc').value = safeVal(p.description);
                document.getElementById('f-promo').checked = p.is_promo;
                admin.clear(true); document.getElementById('edit-id').value = p.id;
                
                const vars = typeof p.variations === 'string' ? JSON.parse(p.variations) : p.variations;
                if(vars) {
                    const checks = document.querySelectorAll('input[type="checkbox"]');
                    vars.forEach(v => {
                        const cb = document.getElementById(`chk-${v.name}`);
                        if(cb) {
                            cb.checked = true;
                            admin.toggleInput(cb);
                            setTimeout(() => {
                                const div = document.getElementById(`grp-${v.name.replace(/[^a-z0-9]/gi,'')}`);
                                if(div) { 
                                    div.querySelector('.v-cost').value = safeVal(v.cost || p.cost_price); 
                                    div.querySelector('.v-price').value = safeVal(v.price); 
                                    div.querySelector('.v-stock').value = safeVal(v.stock); 
                                }
                            }, 50);
                        }
                    });
                }
                document.querySelectorAll('.admin-tab').forEach(t=>t.classList.remove('active'));
                document.querySelectorAll('.admin-tab')[2].classList.add('active'); // Aba Produtos
                admin.tab('prod');
            },
            del: async (id) => { if(confirm("Excluir?")) { await sb.from('products').delete().eq('id', id); await app.load(); admin.renderList(); } },
            clear: (soft=false) => { 
                if(!soft) document.getElementById('edit-id').value=""; 
                document.getElementById('f-name').value=""; document.getElementById('f-desc').value=""; 
                document.getElementById('f-cost').value=""; document.getElementById('f-file').value=""; 
                document.getElementById('active-vars-area').innerHTML="";
                document.querySelectorAll('.modern-checkbox input').forEach(c => c.checked=false);
            },
            renderList: () => {
                const div = document.getElementById('admin-list'); div.innerHTML="";
                state.products.forEach(p => {
                    const vars = typeof p.variations === 'string' ? JSON.parse(p.variations) : p.variations;
                    let stock = 0; if(vars) vars.forEach(v => stock += parseInt(v.stock||0));
                    div.innerHTML += `<div class="mini-prod"><img src="${p.image_url}" onerror="this.src='https://via.placeholder.com/50'"> <div style="flex:1"><strong>${p.name}</strong><div class="stock-info">Estoque: <span class="${stock<5?'stock-warn':''}">${stock}</span></div></div><div><button onclick="admin.edit('${p.id}')" class="btn-mini-edit"><i class="fas fa-edit"></i></button> <button onclick="admin.del('${p.id}')" style="color:red;border:none;background:none;margin-left:10px;"><i class="fas fa-trash"></i></button></div></div>`;
                });
            },
            renderOrders: async () => {
                const { data } = await sb.from('orders').select('*').order('id', {ascending:false});
                const div = document.getElementById('orders-list'); 
                if(div && data) {
                    div.innerHTML="";
                    data.forEach(o => {
                        const iList = typeof o.items==='string'?JSON.parse(o.items):o.items;
                        const addr = typeof o.address==='string'?JSON.parse(o.address):o.address;
                        const status = o.status || 'Pendente';
                        let prodHtml = iList.map(i => `<div>${i.qty}x ${i.name} (${i.variant})</div>`).join('');
                        div.innerHTML += `<div class="order-card"><div class="order-header"><span>${o.date}</span><span>R$ ${o.total.toFixed(2)}</span></div><div class="order-body"><div><span class="order-label">Cliente</span><strong>${o.customer_name}</strong><br><small>${o.customer_email}</small><br><small>${addr.phone}</small></div><div><span class="order-label">Status</span><select onchange="admin.updateStatus('${o.id}', this.value)" style="padding:5px;"><option value="Pendente" ${status==='Pendente'?'selected':''}>Pendente</option><option value="Enviado" ${status==='Enviado'?'selected':''}>Enviado</option><option value="Entregue" ${status==='Entregue'?'selected':''}>Entregue</option></select></div></div><div class="order-items"><span class="order-label">Produtos</span>${prodHtml}</div></div>`;
                    });
                }
            },
            updateStatus: async (id, val) => { await sb.from('orders').update({status: val}).eq('id', id); alert("Status atualizado!"); },
            updateStats: () => {
                let cost=0, rev=0; let miniList = "";
                const div = document.getElementById('mini-prod-list');
                try {
                    if(!state.products || state.products.length === 0) { if(div) div.innerHTML = "<p style='color:#666'>Sem dados.</p>"; return; }
                    state.products.forEach(p => {
                        const vars = typeof p.variations === 'string' ? JSON.parse(p.variations || '[]') : (p.variations || []);
                        let stock = 0;
                        if(vars) {
                            vars.forEach(v => {
                                let q = parseInt(v.stock)||0;
                                let vCost = parseFloat(v.cost) || parseFloat(p.cost_price) || 0;
                                cost += (vCost * q); rev += (parseFloat(v.price||0) * q); stock += q;
                            });
                        }
                        miniList += `<div class="mini-prod"><img src="${p.image_url}" onerror="this.src='https://via.placeholder.com/50'"> <div style="flex:1"><strong>${p.name}</strong><br><span class="stock-info ${stock === 0 ? 'stock-warn' : ''}">${stock === 0 ? 'ESGOTADO' : 'Estoque: ' + stock}</span></div><button onclick="admin.edit('${p.id}')" class="btn-mini-edit">Editar</button></div>`;
                    });
                    document.getElementById('st-cost').innerText = `R$ ${cost.toFixed(2)}`;
                    document.getElementById('st-rev').innerText = `R$ ${rev.toFixed(2)}`;
                    document.getElementById('st-profit').innerText = `R$ ${(rev-cost).toFixed(2)}`;
                    if(div) div.innerHTML = miniList;
                } catch(e) { console.error("Erro dashboard:", e); }
            }
        };

        // --- INIT CALL ---
        (async function init() {
            try {
                if(SUPABASE_URL.includes("COLE_SUA")) throw new Error("Chaves n√£o configuradas.");
                if(window.emailjs) emailjs.init(EMAILJS_PUBLIC_KEY);

                const u = localStorage.getItem('2a_user'); if(u) state.user=JSON.parse(u);
                const a = localStorage.getItem('2a_active_addr'); if(a) state.address=JSON.parse(a);
                
                const urlParams = new URLSearchParams(window.location.search);
                const status = urlParams.get('status') || urlParams.get('collection_status'); 
                const paymentId = urlParams.get('payment_id');

                if (status === 'approved' || (status === null && paymentId)) {
                    const sc = localStorage.getItem('2a_cart');
                    if(sc) { 
                        state.cart = JSON.parse(sc); 
                        const orderData = await app.registerOrder(Date.now().toString(), `Mercado Pago (ID: ${paymentId || 'Auto'})`); 
                        await app.updateStockDatabase();
                        await app.sendEmails(orderData); 
                        localStorage.removeItem('2a_cart');
                        window.history.replaceState({}, document.title, window.location.pathname);
                        alert("Pagamento Confirmado!");
                    }
                }
                await app.load(); admin.initCheckboxes(); app.updateUI();
                document.getElementById('status-bar').style.display='none';
                
                if(window.IMask) {
                    IMask(document.getElementById('addr-cep'), {mask: '00000-000'});
                    IMask(document.getElementById('addr-phone'), {mask: '(00) 00000-0000'});
                }

            } catch(e) { console.error(e); const sb = document.getElementById('status-bar'); if(sb) { sb.className='err'; sb.innerText = e.message; }
            } finally { document.getElementById('loading-screen').style.display='none'; }
        })();

        window.addEventListener('popstate', (e) => { document.querySelectorAll('.overlay.active').forEach(m => m.classList.remove('active')); });
        document.addEventListener('keydown', (e) => { if(e.key === "Escape") { document.querySelectorAll('.overlay.active').forEach(m => m.classList.remove('active')); history.back(); } });
    </script>
</body>
</html>
