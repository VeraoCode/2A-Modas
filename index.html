<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>2A Modas e Perfumes</title>
    
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Montserrat:wght@400;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        /* --- ESTILOS --- */
        :root { --primary: #c48b78; --sec: #2c3e50; --bg: #f8f9fa; --radius: 12px; }
        * { margin:0; padding:0; box-sizing:border-box; font-family:'Inter',sans-serif; outline:none; }
        body { background: var(--bg); color: var(--sec); padding-top: 60px; }
        button { cursor:pointer; transition:0.3s; }
        h1,h2,h3 { font-family:'Montserrat',sans-serif; }

        /* STATUS */
        #status-bar { position:fixed; top:0; left:0; width:100%; height:30px; background:#333; color:white; font-size:0.8rem; display:flex; align-items:center; justify-content:center; z-index:9999; }
        .ok { background:#27ae60 !important; } .err { background:#c0392b !important; }

        /* HEADER & HERO */
        header { position:fixed; top:30px; width:100%; background:rgba(255,255,255,0.95); padding:10px 5%; display:flex; justify-content:flex-end; z-index:1000; border-bottom:1px solid #eee; backdrop-filter:blur(5px); }
        .cart-btn { width:50px; height:50px; border-radius:50%; border:1px solid #eee; background:white; position:relative; font-size:1.2rem; color:var(--sec); }
        .cart-badge { position:absolute; top:-2px; right:-2px; background:var(--primary); color:white; width:22px; height:22px; border-radius:50%; font-size:0.75rem; display:flex; align-items:center; justify-content:center; }

        .hero { padding:100px 20px 60px; text-align:center; background:radial-gradient(circle at top, #fff5f2 0%, #fff 100%); }
        .hero img { width:180px; height:180px; border-radius:50%; border:5px solid white; box-shadow:0 10px 30px rgba(0,0,0,0.1); object-fit:cover; margin-bottom:20px; }
        .btn-cta { background:var(--sec); color:white; padding:12px 35px; border-radius:30px; border:none; font-weight:600; margin-top:20px; }

        /* PRODUTOS */
        .container { max-width:1200px; margin:0 auto; padding:40px 20px; }
        .filters { display:flex; justify-content:center; gap:10px; margin-bottom:40px; flex-wrap:wrap; }
        .filter-btn { padding:8px 25px; border:1px solid #ddd; background:white; border-radius:20px; color:#666; }
        .filter-btn.active { background:var(--sec); color:white; border-color:var(--sec); }

        .grid { display:grid; grid-template-columns:repeat(auto-fill, minmax(260px, 1fr)); gap:30px; }
        .card { background:white; border-radius:var(--radius); overflow:hidden; border:1px solid #eee; transition:0.3s; cursor:pointer; }
        .card:hover { transform:translateY(-5px); box-shadow:0 10px 20px rgba(0,0,0,0.08); }
        .card img { width:100%; height:320px; object-fit:cover; background:#f9f9f9; }
        .card-info { padding:15px; text-align:center; }

        /* MODAL */
        .overlay { position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.6); z-index:2000; display:none; align-items:center; justify-content:center; padding:20px; backdrop-filter:blur(3px); }
        .overlay.active { display:flex; }
        .box { background:white; width:100%; max-width:900px; border-radius:15px; overflow:hidden; max-height:90vh; overflow-y:auto; display:grid; grid-template-columns:1fr 1fr; box-shadow:0 20px 50px rgba(0,0,0,0.2); }
        .box-content { padding:40px; position:relative; }

        /* ADMIN & DASHBOARD */
        .admin-nav { padding:15px; background:white; border-bottom:1px solid #eee; display:flex; gap:10px; position:sticky; top:0; z-index:10; }
        .dash-cards { display:grid; grid-template-columns:repeat(auto-fit, minmax(200px, 1fr)); gap:20px; margin-bottom:30px; }
        .stat-card { background:white; padding:20px; border-radius:10px; border:1px solid #eee; text-align:center; }
        .stat-val { font-size:1.5rem; font-weight:bold; margin-top:5px; color:var(--sec); }
        
        .form-grid { display:grid; grid-template-columns:1fr 1fr; gap:15px; margin-bottom:15px; }
        .input { width:100%; padding:10px; border:1px solid #ddd; border-radius:8px; margin-bottom:10px; }
        .var-row { display:flex; gap:10px; margin-bottom:10px; align-items:center; background:#f9f9f9; padding:10px; border-radius:8px; }

        /* CARRINHO SIDEBAR */
        .sidebar { position:fixed; top:30px; right:-400px; width:350px; height:100%; background:white; z-index:2001; padding:25px; transition:0.3s; box-shadow:-5px 0 20px rgba(0,0,0,0.1); display:flex; flex-direction:column; padding-bottom:60px; }
        .sidebar.open { right:0; }
        .btn-mp { background:#009EE3; color:white; width:100%; padding:15px; border-radius:8px; border:none; display:flex; align-items:center; justify-content:center; gap:10px; font-weight:bold; margin-top:10px; }
        .btn-ws { background:#25D366; color:white; width:100%; padding:15px; border-radius:8px; border:none; font-weight:bold; display:flex; align-items:center; justify-content:center; gap:10px; }

        @media(max-width:768px){ .box{grid-template-columns:1fr;} .sidebar{width:100%;} .form-grid{grid-template-columns:1fr;} }
    </style>
</head>
<body>

    <div id="status-bar" class="err">Conectando ao Banco de Dados...</div>

    <header>
        <button class="cart-btn" onclick="app.toggleCart()">
            <i class="fas fa-shopping-bag"></i>
            <span class="cart-badge" id="cart-count">0</span>
        </button>
    </header>

    <div class="hero">
        <img src="logo.jpg" onerror="this.src='https://via.placeholder.com/200?text=2A'">
        <h1>2A Modas e Perfumes</h1>
        <p>Estilo e ess√™ncia em um s√≥ lugar.</p>
        <button class="btn-cta" onclick="document.getElementById('vitrine').scrollIntoView({behavior:'smooth'})">Ver Cole√ß√£o</button>
    </div>

    <div class="container" id="vitrine">
        <div class="filters">
            <button class="filter-btn active" onclick="app.filter('all', this)">Todos</button>
            <button class="filter-btn" onclick="app.filter('feminino', this)">Feminino</button>
            <button class="filter-btn" onclick="app.filter('infantil', this)">Infantil</button>
            <button class="filter-btn" onclick="app.filter('perfumes', this)">Perfumes</button>
        </div>
        <div id="loading" style="text-align:center; padding:20px;">Carregando produtos...</div>
        <div id="products-list" class="grid"></div>
    </div>

    <div id="product-modal" class="overlay">
        <div class="box">
            <img id="m-img" style="width:100%; height:100%; object-fit:cover; min-height:300px;">
            <div class="box-content">
                <button onclick="document.getElementById('product-modal').classList.remove('active')" style="position:absolute; top:20px; right:20px; border:none; background:none; font-size:1.5rem;">&times;</button>
                <small id="m-cat" style="color:var(--primary); font-weight:bold; text-transform:uppercase;">Cat</small>
                <h2 id="m-title" style="margin:10px 0;">Produto</h2>
                <h3 id="m-price" style="color:var(--sec); margin-bottom:20px;">R$ 0,00</h3>
                <p id="m-desc" style="color:#666; margin-bottom:20px;">Desc</p>
                
                <div id="m-vars" style="display:flex; flex-wrap:wrap; gap:10px; margin-bottom:20px;"></div>
                
                <div style="display:flex; align-items:center; gap:10px; margin-bottom:20px;">
                    <strong>Qtd:</strong>
                    <button onclick="app.updQty(-1)" style="padding:5px 10px; border:1px solid #ddd;">-</button>
                    <span id="m-qty" style="font-weight:bold;">1</span>
                    <button onclick="app.updQty(1)" style="padding:5px 10px; border:1px solid #ddd;">+</button>
                </div>
                <button onclick="app.addCart()" style="width:100%; background:var(--sec); color:white; padding:15px; border-radius:8px; border:none; font-weight:bold;">Adicionar √† Sacola</button>
            </div>
        </div>
    </div>

    <div class="sidebar">
        <div style="display:flex; justify-content:space-between; margin-bottom:20px;">
            <h3>Sacola</h3>
            <button onclick="app.toggleCart()" style="border:none; background:none; font-size:1.5rem;">&times;</button>
        </div>
        <ul id="cart-list" style="flex:1; overflow-y:auto; list-style:none;"></ul>
        <div style="border-top:1px solid #eee; padding-top:20px;">
            <div style="display:flex; justify-content:space-between; font-weight:bold; margin-bottom:15px; font-size:1.2rem;">
                <span>Total</span> <span id="cart-total">R$ 0.00</span>
            </div>
            <button onclick="app.checkoutWs()" class="btn-ws"><i class="fab fa-whatsapp"></i> Finalizar no WhatsApp</button>
            <button class="btn-mp">
                <img src="https://http2.mlstatic.com/frontend-assets/ui-navigation/5.18.9/mercadopago/logo__small.png" style="height:20px; filter:brightness(0) invert(1);"> Pagar
            </button>
        </div>
    </div>

    <div id="login-modal" class="overlay">
        <div class="box" style="max-width:400px; display:block; padding:40px; text-align:center;">
            <h2 style="margin-bottom:20px;">Acesso Admin</h2>
            <input type="email" id="adm-email" placeholder="E-mail" class="input">
            <input type="password" id="adm-pass" placeholder="Senha" class="input">
            <button onclick="admin.login()" style="width:100%; background:var(--sec); color:white; padding:12px; border-radius:8px; border:none; margin-top:10px;">Entrar</button>
            <button onclick="document.getElementById('login-modal').classList.remove('active')" style="margin-top:15px; background:none; border:none; color:#888;">Voltar</button>
        </div>
    </div>

    <div id="admin-modal" class="overlay" style="z-index:2001; background:#f4f6f9; align-items:flex-start; padding:0;">
        <div class="box" style="max-width:100%; height:100%; border-radius:0; padding:0; display:flex; flex-direction:column;">
            
            <div class="admin-nav">
                <h3 style="margin-right:auto;">Gest√£o 2A</h3>
                <button onclick="admin.tab('dash')" class="filter-btn active">Faturamento</button>
                <button onclick="admin.tab('prod')" class="filter-btn">Produtos</button>
                <button onclick="document.getElementById('admin-modal').classList.remove('active')" style="background:#e74c3c; color:white; border:none; padding:8px 20px; border-radius:20px;">Sair</button>
            </div>

            <div style="padding:30px; overflow-y:auto; flex:1;">
                
                <div id="tab-dash">
                    <div class="dash-cards">
                        <div class="stat-card">
                            <div style="color:#e74c3c; font-size:0.8rem;">CUSTO TOTAL (ESTOQUE)</div>
                            <div class="stat-val" id="stat-cost">R$ 0.00</div>
                        </div>
                        <div class="stat-card">
                            <div style="color:#2980b9; font-size:0.8rem;">VALOR DE VENDA POTENCIAL</div>
                            <div class="stat-val" id="stat-rev">R$ 0.00</div>
                        </div>
                        <div class="stat-card">
                            <div style="color:#27ae60; font-size:0.8rem;">LUCRO PREVISTO</div>
                            <div class="stat-val" id="stat-prof">R$ 0.00</div>
                        </div>
                    </div>
                    
                    <div style="display:grid; grid-template-columns:1fr 2fr; gap:30px;">
                        <div style="background:white; padding:20px; border-radius:12px; border:1px solid #eee;">
                            <h4>Estoque por Categoria</h4>
                            <canvas id="chartStock"></canvas>
                        </div>
                        <div style="background:white; padding:20px; border-radius:12px; border:1px solid #eee;">
                            <h4>Detalhamento de Estoque</h4>
                            <div id="stock-list" style="margin-top:15px; max-height:300px; overflow-y:auto;"></div>
                        </div>
                    </div>
                </div>

                <div id="tab-prod" style="display:none;">
                    <div style="display:grid; grid-template-columns:1fr 1fr; gap:30px;">
                        <div style="background:white; padding:25px; border-radius:12px; border:1px solid #eee;">
                            <h3 style="margin-bottom:20px;">Novo Produto</h3>
                            <input type="hidden" id="edit-id">
                            <input type="text" id="f-name" placeholder="Nome" class="input">
                            <div class="form-grid">
                                <select id="f-cat" class="input">
                                    <option value="feminino">Feminino</option>
                                    <option value="infantil">Infantil</option>
                                    <option value="perfumes">Perfumes</option>
                                </select>
                                <input type="number" id="f-cost" placeholder="Custo un. (R$)" class="input">
                            </div>
                            <input type="file" id="f-file" class="input">
                            
                            <hr style="margin:20px 0; border:0; border-top:1px solid #eee;">
                            <label style="font-weight:bold; font-size:0.9rem;">Varia√ß√µes (Cor/Vol - Pre√ßo Venda - Qtd)</label>
                            <div id="f-vars-list" style="margin-top:10px;"></div>
                            <button onclick="admin.addVarRow()" style="background:#eee; padding:5px 10px; border:none; border-radius:5px; margin-top:5px; font-size:0.8rem;">+ Adicionar</button>
                            
                            <textarea id="f-desc" placeholder="Descri√ß√£o" class="input" style="margin-top:20px;" rows="3"></textarea>
                            
                            <button onclick="admin.save()" id="btn-save" style="width:100%; background:var(--success); color:white; padding:15px; border-radius:8px; border:none; font-weight:bold; margin-top:20px;">Salvar</button>
                            <button onclick="admin.clear()" style="width:100%; margin-top:10px; background:white; border:1px solid #ddd; padding:10px; border-radius:8px;">Limpar</button>
                        </div>

                        <div style="background:white; padding:25px; border-radius:12px; border:1px solid #eee;">
                            <h3>Produtos Cadastrados</h3>
                            <div id="admin-list" style="margin-top:20px; max-height:600px; overflow-y:auto;"></div>
                        </div>
                    </div>
                </div>

            </div>
        </div>
    </div>

    <footer>
        <div style="text-align:center; padding:40px; color:#aaa; font-size:0.8rem;">
            &copy; 2025 2A Modas e Perfumes.<br><br>
            <button onclick="document.getElementById('login-modal').classList.add('active')" style="background:none; border:none; color:#ccc;">√Årea Admin</button>
        </div>
    </footer>

    <script>
        // --- ‚ö†Ô∏è CONFIGURA√á√ÉO SUPABASE (COLE SUAS CHAVES AQUI) ---
        const SUPABASE_URL = 'https://sdeslwemzhxqixmphyye.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InNkZXNsd2Vtemh4cWl4bXBoeXllIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjY3MDUxNDUsImV4cCI6MjA4MjI4MTE0NX0.QK7PkbYOnT6nIRFZHtHsuh42EuCjMSVvdnxf7h1bD80';
        
        // Inicializa√ß√£o do Cliente
        const sb = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        // --- ESTADO GLOBAL ---
        const state = { products: [], cart: [], current: null, var: null, qty: 1 };
        let chartInst = null;

        // --- VERIFICA√á√ÉO DE CONEX√ÉO ---
        (async function checkConn() {
            const { error } = await sb.from('products').select('count', { count: 'exact', head: true });
            const status = document.getElementById('status-bar');
            if(error) { status.className='err'; status.innerText="ERRO DE CONEX√ÉO - Verifique as Chaves"; }
            else { status.className='ok'; status.innerText="SISTEMA ONLINE"; setTimeout(()=>status.style.top='-30px', 3000); app.init(); }
        })();

        // --- APLICA√á√ÉO CLIENTE ---
        const app = {
            init: async () => {
                const { data, error } = await sb.from('products').select('*');
                if(!error) {
                    state.products = data;
                    app.render(data);
                    document.getElementById('loading').style.display='none';
                }
            },

            render: (list) => {
                const div = document.getElementById('products-list'); div.innerHTML = "";
                if(list.length===0) div.innerHTML = "<p style='text-align:center; width:100%; color:#999'>Nenhum produto cadastrado.</p>";
                
                list.forEach(p => {
                    // Pre√ßo m√≠nimo
                    let minP = 0;
                    if(p.variations && p.variations.length) minP = Math.min(...p.variations.map(v => v.price));
                    
                    div.innerHTML += `
                        <div class="card" onclick="app.modal(${p.id})">
                            <img src="${p.image_url}" onerror="this.src='https://via.placeholder.com/300'">
                            <div class="card-info">
                                <small class="p-cat">${p.category}</small>
                                <div class="p-title">${p.name}</div>
                                <div class="p-price">A partir R$ ${minP.toFixed(2)}</div>
                            </div>
                        </div>`;
                });
            },

            filter: (cat, btn) => {
                document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
                if(btn) btn.classList.add('active');
                const list = cat === 'all' ? state.products : state.products.filter(p => p.category === cat);
                app.render(list);
            },

            modal: (id) => {
                const p = state.products.find(x => x.id === id);
                state.current = p; state.qty = 1; state.var = null;
                
                document.getElementById('m-img').src = p.image_url;
                document.getElementById('m-title').innerText = p.name;
                document.getElementById('m-cat').innerText = p.category;
                document.getElementById('m-desc').innerText = p.description;
                document.getElementById('m-price').innerText = "Selecione...";
                
                const vars = document.getElementById('m-vars'); vars.innerHTML = "";
                p.variations.forEach((v, idx) => {
                    const btn = document.createElement('button');
                    const hasStock = parseInt(v.stock) > 0;
                    btn.innerHTML = `${v.name} - R$ ${parseFloat(v.price).toFixed(2)}`;
                    btn.style.padding = "10px"; btn.style.border = "1px solid #ddd"; btn.style.borderRadius="8px"; btn.style.background="white";
                    
                    if(!hasStock) { btn.disabled=true; btn.style.opacity=0.5; btn.innerHTML += " (Esgotado)"; }
                    else {
                        btn.onclick = () => {
                            state.var = v;
                            document.getElementById('m-price').innerText = `R$ ${parseFloat(v.price).toFixed(2)}`;
                            Array.from(vars.children).forEach(b => { b.style.background='white'; b.style.color='black'; });
                            btn.style.background = 'var(--sec)'; btn.style.color='white';
                        };
                    }
                    vars.appendChild(btn);
                });
                document.getElementById('product-modal').classList.add('active');
            },

            updQty: (n) => { state.qty += n; if(state.qty<1) state.qty=1; document.getElementById('m-qty').innerText = state.qty; },

            addCart: () => {
                if(!state.var) return alert("Selecione uma op√ß√£o.");
                state.cart.push({
                    name: state.current.name,
                    variant: state.var.name,
                    price: parseFloat(state.var.price),
                    qty: state.qty
                });
                app.renderCart();
                document.getElementById('product-modal').classList.remove('active');
                app.toggleCart();
            },

            renderCart: () => {
                const ul = document.getElementById('cart-list'); ul.innerHTML=""; let t=0;
                state.cart.forEach((i, idx) => {
                    t += i.price * i.qty;
                    ul.innerHTML += `<li style="padding:10px; border-bottom:1px solid #eee; display:flex; justify-content:space-between; align-items:center;">
                        <div><strong>${i.name}</strong><br><small>${i.variant} x${i.qty}</small></div>
                        <div style="text-align:right;">R$ ${(i.price*i.qty).toFixed(2)} <i class="fas fa-trash" onclick="state.cart.splice(${idx},1); app.renderCart()" style="color:red; cursor:pointer; margin-left:5px;"></i></div>
                    </li>`;
                });
                document.getElementById('cart-total').innerText = `R$ ${t.toFixed(2)}`;
                document.getElementById('cart-count').innerText = state.cart.length;
            },
            toggleCart: () => document.querySelector('.sidebar').classList.toggle('open'),

            checkoutWs: () => {
                if(!state.cart.length) return alert("Vazio");
                let msg = "*NOVO PEDIDO (Site)*\n------------------\n"; let total = 0;
                state.cart.forEach(i => {
                    msg += `üì¶ ${i.name} (${i.variant})\n   Qtd: ${i.qty} | Valor: R$ ${(i.price*i.qty).toFixed(2)}\n`;
                    total += i.price * i.qty;
                });
                msg += `------------------\n*TOTAL FINAL: R$ ${total.toFixed(2)}*`;
                window.open(`https://wa.me/5511999999999?text=${encodeURIComponent(msg)}`);
            }
        };

        // --- ADMIN ---
        const admin = {
            login: () => {
                // Login simplificado para frontend (Use Supabase Auth para produ√ß√£o real)
                if(document.getElementById('adm-email').value === "admin@2a.com" && document.getElementById('adm-pass').value === "123") {
                    document.getElementById('login-modal').classList.remove('active');
                    document.getElementById('admin-modal').classList.add('active');
                    admin.renderList();
                    admin.updateStats();
                } else alert("Dados inv√°lidos");
            },

            tab: (t) => {
                document.getElementById('tab-dash').style.display = t === 'dash' ? 'block' : 'none';
                document.getElementById('tab-prod').style.display = t === 'prod' ? 'block' : 'none';
                admin.updateStats(); // Refresh charts
            },

            addVarRow: (data={name:'', price:'', stock:''}) => {
                const div = document.getElementById('f-vars-list');
                const row = document.createElement('div'); row.className = 'var-row';
                row.innerHTML = `
                    <input type="text" placeholder="Ex: P, 50ml" class="input v-name" value="${data.name}" style="margin:0">
                    <input type="number" placeholder="Venda R$" class="input v-price" value="${data.price}" style="margin:0">
                    <input type="number" placeholder="Qtd" class="input v-stock" value="${data.stock}" style="margin:0">
                    <button onclick="this.parentElement.remove()" style="color:red; border:none; background:none;">X</button>`;
                div.appendChild(row);
            },

            save: async () => {
                const btn = document.getElementById('btn-save'); btn.innerText="Salvando..."; btn.disabled=true;
                try {
                    const vars = [];
                    document.querySelectorAll('.var-row').forEach(r => {
                        vars.push({
                            name: r.querySelector('.v-name').value,
                            price: r.querySelector('.v-price').value,
                            stock: r.querySelector('.v-stock').value
                        });
                    });
                    if(!vars.length) throw new Error("Adicione varia√ß√µes.");

                    const file = document.getElementById('f-file').files[0];
                    let imgUrl = "https://via.placeholder.com/300";
                    
                    if(file) {
                        const fName = `prod_${Date.now()}`;
                        const { data, error } = await sb.storage.from('images').upload(fName, file);
                        if(error) throw error;
                        const { data: urlData } = sb.storage.from('images').getPublicUrl(fName);
                        imgUrl = urlData.publicUrl;
                    }

                    const payload = {
                        name: document.getElementById('f-name').value,
                        category: document.getElementById('f-cat').value,
                        description: document.getElementById('f-desc').value,
                        cost_price: parseFloat(document.getElementById('f-cost').value) || 0,
                        variations: vars, // JSON
                        image_url: imgUrl
                    };

                    const { error } = await sb.from('products').insert([payload]);
                    if(error) throw error;

                    alert("Salvo!"); admin.clear(); app.init(); // Recarrega
                } catch(e) { alert(e.message); }
                finally { btn.innerText="Salvar Produto"; btn.disabled=false; }
            },

            clear: () => {
                document.querySelector('#tab-prod input').value="";
                document.getElementById('f-vars-list').innerHTML="";
                admin.addVarRow();
            },

            renderList: () => {
                const div = document.getElementById('admin-list'); div.innerHTML="";
                state.products.forEach(p => {
                    div.innerHTML += `<div style="display:flex; justify-content:space-between; align-items:center; padding:10px; border-bottom:1px solid #eee;">
                        <div style="display:flex; align-items:center; gap:10px;">
                            <img src="${p.image_url}" style="width:40px; height:40px; object-fit:cover; border-radius:5px;">
                            <strong>${p.name}</strong>
                        </div>
                        <button onclick="admin.del(${p.id})" style="color:red; border:none; background:none;"><i class="fas fa-trash"></i></button>
                    </div>`;
                });
            },

            del: async (id) => {
                if(confirm("Excluir?")) {
                    await sb.from('products').delete().eq('id', id);
                    app.init(); admin.renderList();
                }
            },

            updateStats: () => {
                let cost=0, rev=0, cats={feminino:0, infantil:0, perfumes:0};
                let stockList = "";

                state.products.forEach(p => {
                    let pStock = 0;
                    if(p.variations) {
                        p.variations.forEach(v => {
                            let q = parseInt(v.stock)||0;
                            cost += (p.cost_price * q);
                            rev += (v.price * q);
                            pStock += q;
                            if(cats[p.category] !== undefined) cats[p.category] += q;
                        });
                    }
                    stockList += `<div style="display:flex; justify-content:space-between; padding:5px; border-bottom:1px solid #eee;"><span>${p.name}</span><b>${pStock} un</b></div>`;
                });

                document.getElementById('stat-cost').innerText = `R$ ${cost.toFixed(2)}`;
                document.getElementById('stat-rev').innerText = `R$ ${rev.toFixed(2)}`;
                document.getElementById('stat-prof').innerText = `R$ ${(rev-cost).toFixed(2)}`;
                document.getElementById('stock-list').innerHTML = stockList;

                const ctx = document.getElementById('chartStock');
                if(chartInst) chartInst.destroy();
                chartInst = new Chart(ctx, {
                    type: 'doughnut',
                    data: {
                        labels: ['Feminino', 'Infantil', 'Perfumes'],
                        datasets: [{ data: [cats.feminino, cats.infantil, cats.perfumes], backgroundColor: ['#c48b78', '#f1c40f', '#9b59b6'] }]
                    }
                });
            }
        };

        // Iniciar
        admin.addVarRow();
    </script>
</body>
</html>
